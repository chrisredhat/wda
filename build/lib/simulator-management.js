"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.createSim = createSim;
exports.getExistingSim = getExistingSim;
exports.runSimulatorReset = runSimulatorReset;
exports.installToSimulator = installToSimulator;
exports.shutdownSimulator = shutdownSimulator;
exports.shutdownOtherSimulators = shutdownOtherSimulators;

require("source-map-support/register");

var _path = _interopRequireDefault(require("path"));

var _appiumIosSimulator = require("appium-ios-simulator");

var _nodeSimctl = require("node-simctl");

var _utils = require("./utils");

var _lodash = _interopRequireDefault(require("lodash"));

var _logger = _interopRequireDefault(require("./logger"));

var _appiumSupport = require("appium-support");

var _uuidJs = _interopRequireDefault(require("uuid-js"));

var _desiredCaps = require("./desired-caps");

const INSTALL_DAEMON_CACHE = 'com.apple.mobile.installd.staging';

async function createSim(caps, platform = _desiredCaps.PLATFORM_NAME_IOS) {
  const appiumTestDeviceName = `appiumTest-${_uuidJs.default.create().toString().toUpperCase()}-${caps.deviceName}`;
  const udid = await (0, _nodeSimctl.createDevice)(appiumTestDeviceName, caps.deviceName, caps.platformVersion, {
    platform
  });
  return await (0, _appiumIosSimulator.getSimulator)(udid);
}

async function getExistingSim(opts) {
  const devices = await (0, _nodeSimctl.getDevices)(opts.platformVersion);
  const appiumTestDeviceName = `appiumTest-${opts.deviceName}`;
  let appiumTestDevice;

  for (const device of _lodash.default.values(devices)) {
    if (device.name === opts.deviceName) {
      return await (0, _appiumIosSimulator.getSimulator)(device.udid);
    }

    if (device.name === appiumTestDeviceName) {
      appiumTestDevice = device;
    }
  }

  if (appiumTestDevice) {
    _logger.default.warn(`Unable to find device '${opts.deviceName}'. Found '${appiumTestDevice.name}' (udid: '${appiumTestDevice.udid}') instead`);

    return await (0, _appiumIosSimulator.getSimulator)(appiumTestDevice.udid);
  }

  return null;
}

async function shutdownSimulator(device) {
  await (0, _utils.resetXCTestProcesses)(device.udid, true);
  await device.shutdown();
}

async function runSimulatorReset(device, opts) {
  if (opts.noReset && !opts.fullReset) {
    _logger.default.debug('Reset: noReset is on. Leaving simulator as is');

    return;
  }

  if (!device) {
    _logger.default.debug('Reset: no device available. Skipping');

    return;
  }

  if (opts.fullReset) {
    _logger.default.debug('Reset: fullReset is on. Cleaning simulator');

    await shutdownSimulator(device);
    let isKeychainsBackupSuccessful = false;

    if (opts.keychainsExcludePatterns || opts.keepKeyChains) {
      isKeychainsBackupSuccessful = await device.backupKeychains();
    }

    await device.clean();

    if (isKeychainsBackupSuccessful) {
      await device.restoreKeychains(opts.keychainsExcludePatterns || []);

      _logger.default.info(`Successfully restored keychains after full reset`);
    } else if (opts.keychainsExcludePatterns || opts.keepKeyChains) {
      _logger.default.warn('Cannot restore keychains after full reset, because ' + 'the backup operation did not succeed');
    }
  } else if (opts.bundleId) {
    if (await device.isRunning()) {
      if (device.xcodeVersion.major >= 8) {
        try {
          await (0, _nodeSimctl.terminate)(device.udid, opts.bundleId);
        } catch (err) {
          _logger.default.warn(`Reset: failed to terminate Simulator application with id "${opts.bundleId}"`);
        }
      } else {
        await shutdownSimulator(device);
      }
    }

    if (opts.app) {
      _logger.default.info('Not scrubbing third party app in anticipation of uninstall');

      return;
    }

    const isSafari = (opts.browserName || '').toLowerCase() === 'safari';

    try {
      if (isSafari) {
        await device.cleanSafari();
      } else {
        await device.scrubCustomApp(_path.default.basename(opts.app), opts.bundleId);
      }
    } catch (err) {
      _logger.default.warn(err.message);

      _logger.default.warn(`Reset: could not scrub ${isSafari ? 'Safari browser' : 'application with id "' + opts.bundleId + '"'}. Leaving as is.`);
    }
  }
}

async function installToSimulator(device, app, bundleId, noReset = true) {
  if (!app) {
    _logger.default.debug('No app path is given. Nothing to install.');

    return;
  }

  if (bundleId) {
    if (await device.isAppInstalled(bundleId)) {
      if (noReset) {
        _logger.default.debug(`App '${bundleId}' is already installed. No need to reinstall.`);

        return;
      }

      _logger.default.debug(`Reset requested. Removing app with id '${bundleId}' from the device`);

      await device.removeApp(bundleId);
    }
  }

  const installdCacheRoot = _path.default.resolve(device.getDir(), 'Library', 'Caches', INSTALL_DAEMON_CACHE);

  let tmpRoot = null;

  if (await _appiumSupport.fs.exists(installdCacheRoot)) {
    tmpRoot = await _appiumSupport.tempDir.openDir();

    _logger.default.debug('Cleaning installd cache to save the disk space');

    await _appiumSupport.fs.mv(installdCacheRoot, _path.default.resolve(tmpRoot, INSTALL_DAEMON_CACHE), {
      mkdirp: true
    });
    await (0, _appiumSupport.mkdirp)(installdCacheRoot);
  }

  _logger.default.debug(`Installing '${app}' on Simulator with UUID '${device.udid}'...`);

  try {
    try {
      await device.installApp(app);
    } catch (e) {
      _logger.default.info(`Got an error on '${app}' install: ${e.message}`);

      if (e.message.includes('domain=MIInstallerErrorDomain, code=35') && tmpRoot) {
        _logger.default.info(`installd requires the cache to be available in order to install '${app}'. ` + `Restoring the cache`);

        await _appiumSupport.fs.rimraf(installdCacheRoot);
        await _appiumSupport.fs.mv(_path.default.resolve(tmpRoot, INSTALL_DAEMON_CACHE), installdCacheRoot, {
          mkdirp: true
        });
      }

      _logger.default.info('Retrying application install');

      await device.installApp(app);
    }

    _logger.default.debug('The app has been installed successfully.');
  } finally {
    if (tmpRoot && (await _appiumSupport.fs.exists(tmpRoot))) {
      await _appiumSupport.fs.rimraf(tmpRoot);
    }
  }
}

async function shutdownOtherSimulators(currentDevice) {
  const allDevices = _lodash.default.flatMap(_lodash.default.values((await (0, _nodeSimctl.getDevices)())));

  const otherBootedDevices = allDevices.filter(device => device.udid !== currentDevice.udid && device.state === 'Booted');

  if (_lodash.default.isEmpty(otherBootedDevices)) {
    _logger.default.info('No other running simulators have been detected');

    return;
  }

  _logger.default.info(`Detected ${otherBootedDevices.length} other running Simulator${otherBootedDevices.length === 1 ? '' : 's'}.` + `Shutting ${otherBootedDevices.length === 1 ? 'it' : 'them'} down...`);

  for (const _ref of otherBootedDevices) {
    const {
      udid
    } = _ref;
    await (0, _utils.resetXCTestProcesses)(udid, true);
    await (0, _nodeSimctl.shutdown)(udid);
  }
}require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9zaW11bGF0b3ItbWFuYWdlbWVudC5qcyJdLCJuYW1lcyI6WyJJTlNUQUxMX0RBRU1PTl9DQUNIRSIsImNyZWF0ZVNpbSIsImNhcHMiLCJwbGF0Zm9ybSIsIlBMQVRGT1JNX05BTUVfSU9TIiwiYXBwaXVtVGVzdERldmljZU5hbWUiLCJVVUlEIiwiY3JlYXRlIiwidG9TdHJpbmciLCJ0b1VwcGVyQ2FzZSIsImRldmljZU5hbWUiLCJ1ZGlkIiwicGxhdGZvcm1WZXJzaW9uIiwiZ2V0RXhpc3RpbmdTaW0iLCJvcHRzIiwiZGV2aWNlcyIsImFwcGl1bVRlc3REZXZpY2UiLCJkZXZpY2UiLCJfIiwidmFsdWVzIiwibmFtZSIsImxvZyIsIndhcm4iLCJzaHV0ZG93blNpbXVsYXRvciIsInNodXRkb3duIiwicnVuU2ltdWxhdG9yUmVzZXQiLCJub1Jlc2V0IiwiZnVsbFJlc2V0IiwiZGVidWciLCJpc0tleWNoYWluc0JhY2t1cFN1Y2Nlc3NmdWwiLCJrZXljaGFpbnNFeGNsdWRlUGF0dGVybnMiLCJrZWVwS2V5Q2hhaW5zIiwiYmFja3VwS2V5Y2hhaW5zIiwiY2xlYW4iLCJyZXN0b3JlS2V5Y2hhaW5zIiwiaW5mbyIsImJ1bmRsZUlkIiwiaXNSdW5uaW5nIiwieGNvZGVWZXJzaW9uIiwibWFqb3IiLCJlcnIiLCJhcHAiLCJpc1NhZmFyaSIsImJyb3dzZXJOYW1lIiwidG9Mb3dlckNhc2UiLCJjbGVhblNhZmFyaSIsInNjcnViQ3VzdG9tQXBwIiwicGF0aCIsImJhc2VuYW1lIiwibWVzc2FnZSIsImluc3RhbGxUb1NpbXVsYXRvciIsImlzQXBwSW5zdGFsbGVkIiwicmVtb3ZlQXBwIiwiaW5zdGFsbGRDYWNoZVJvb3QiLCJyZXNvbHZlIiwiZ2V0RGlyIiwidG1wUm9vdCIsImZzIiwiZXhpc3RzIiwidGVtcERpciIsIm9wZW5EaXIiLCJtdiIsIm1rZGlycCIsImluc3RhbGxBcHAiLCJlIiwiaW5jbHVkZXMiLCJyaW1yYWYiLCJzaHV0ZG93bk90aGVyU2ltdWxhdG9ycyIsImN1cnJlbnREZXZpY2UiLCJhbGxEZXZpY2VzIiwiZmxhdE1hcCIsIm90aGVyQm9vdGVkRGV2aWNlcyIsImZpbHRlciIsInN0YXRlIiwiaXNFbXB0eSIsImxlbmd0aCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUdBLE1BQU1BLG9CQUFvQixHQUFHLG1DQUE3Qjs7QUFnQkEsZUFBZUMsU0FBZixDQUEwQkMsSUFBMUIsRUFBZ0NDLFFBQVEsR0FBR0MsOEJBQTNDLEVBQThEO0FBQzVELFFBQU1DLG9CQUFvQixHQUFJLGNBQWFDLGdCQUFLQyxNQUFMLEdBQWNDLFFBQWQsR0FBeUJDLFdBQXpCLEVBQXVDLElBQUdQLElBQUksQ0FBQ1EsVUFBVyxFQUFyRztBQUNBLFFBQU1DLElBQUksR0FBRyxNQUFNLDhCQUNqQk4sb0JBRGlCLEVBRWpCSCxJQUFJLENBQUNRLFVBRlksRUFHakJSLElBQUksQ0FBQ1UsZUFIWSxFQUlqQjtBQUFFVCxJQUFBQTtBQUFGLEdBSmlCLENBQW5CO0FBTUEsU0FBTyxNQUFNLHNDQUFhUSxJQUFiLENBQWI7QUFDRDs7QUFVRCxlQUFlRSxjQUFmLENBQStCQyxJQUEvQixFQUFxQztBQUNuQyxRQUFNQyxPQUFPLEdBQUcsTUFBTSw0QkFBV0QsSUFBSSxDQUFDRixlQUFoQixDQUF0QjtBQUNBLFFBQU1QLG9CQUFvQixHQUFJLGNBQWFTLElBQUksQ0FBQ0osVUFBVyxFQUEzRDtBQUVBLE1BQUlNLGdCQUFKOztBQUVBLE9BQUssTUFBTUMsTUFBWCxJQUFxQkMsZ0JBQUVDLE1BQUYsQ0FBU0osT0FBVCxDQUFyQixFQUF3QztBQUN0QyxRQUFJRSxNQUFNLENBQUNHLElBQVAsS0FBZ0JOLElBQUksQ0FBQ0osVUFBekIsRUFBcUM7QUFDbkMsYUFBTyxNQUFNLHNDQUFhTyxNQUFNLENBQUNOLElBQXBCLENBQWI7QUFDRDs7QUFFRCxRQUFJTSxNQUFNLENBQUNHLElBQVAsS0FBZ0JmLG9CQUFwQixFQUEwQztBQUN4Q1csTUFBQUEsZ0JBQWdCLEdBQUdDLE1BQW5CO0FBQ0Q7QUFDRjs7QUFFRCxNQUFJRCxnQkFBSixFQUFzQjtBQUNwQkssb0JBQUlDLElBQUosQ0FBVSwwQkFBeUJSLElBQUksQ0FBQ0osVUFBVyxhQUFZTSxnQkFBZ0IsQ0FBQ0ksSUFBSyxhQUFZSixnQkFBZ0IsQ0FBQ0wsSUFBSyxZQUF2SDs7QUFDQSxXQUFPLE1BQU0sc0NBQWFLLGdCQUFnQixDQUFDTCxJQUE5QixDQUFiO0FBQ0Q7O0FBQ0QsU0FBTyxJQUFQO0FBQ0Q7O0FBRUQsZUFBZVksaUJBQWYsQ0FBa0NOLE1BQWxDLEVBQTBDO0FBRXhDLFFBQU0saUNBQXFCQSxNQUFNLENBQUNOLElBQTVCLEVBQWtDLElBQWxDLENBQU47QUFDQSxRQUFNTSxNQUFNLENBQUNPLFFBQVAsRUFBTjtBQUNEOztBQUVELGVBQWVDLGlCQUFmLENBQWtDUixNQUFsQyxFQUEwQ0gsSUFBMUMsRUFBZ0Q7QUFDOUMsTUFBSUEsSUFBSSxDQUFDWSxPQUFMLElBQWdCLENBQUNaLElBQUksQ0FBQ2EsU0FBMUIsRUFBcUM7QUFFbkNOLG9CQUFJTyxLQUFKLENBQVUsK0NBQVY7O0FBQ0E7QUFDRDs7QUFFRCxNQUFJLENBQUNYLE1BQUwsRUFBYTtBQUNYSSxvQkFBSU8sS0FBSixDQUFVLHNDQUFWOztBQUNBO0FBQ0Q7O0FBRUQsTUFBSWQsSUFBSSxDQUFDYSxTQUFULEVBQW9CO0FBQ2xCTixvQkFBSU8sS0FBSixDQUFVLDRDQUFWOztBQUNBLFVBQU1MLGlCQUFpQixDQUFDTixNQUFELENBQXZCO0FBQ0EsUUFBSVksMkJBQTJCLEdBQUcsS0FBbEM7O0FBQ0EsUUFBSWYsSUFBSSxDQUFDZ0Isd0JBQUwsSUFBaUNoQixJQUFJLENBQUNpQixhQUExQyxFQUF5RDtBQUN2REYsTUFBQUEsMkJBQTJCLEdBQUcsTUFBTVosTUFBTSxDQUFDZSxlQUFQLEVBQXBDO0FBQ0Q7O0FBQ0QsVUFBTWYsTUFBTSxDQUFDZ0IsS0FBUCxFQUFOOztBQUNBLFFBQUlKLDJCQUFKLEVBQWlDO0FBQy9CLFlBQU1aLE1BQU0sQ0FBQ2lCLGdCQUFQLENBQXdCcEIsSUFBSSxDQUFDZ0Isd0JBQUwsSUFBaUMsRUFBekQsQ0FBTjs7QUFDQVQsc0JBQUljLElBQUosQ0FBVSxrREFBVjtBQUNELEtBSEQsTUFHTyxJQUFJckIsSUFBSSxDQUFDZ0Isd0JBQUwsSUFBaUNoQixJQUFJLENBQUNpQixhQUExQyxFQUF5RDtBQUM5RFYsc0JBQUlDLElBQUosQ0FBUyx3REFDQSxzQ0FEVDtBQUVEO0FBQ0YsR0FmRCxNQWVPLElBQUlSLElBQUksQ0FBQ3NCLFFBQVQsRUFBbUI7QUFHeEIsUUFBSSxNQUFNbkIsTUFBTSxDQUFDb0IsU0FBUCxFQUFWLEVBQThCO0FBQzVCLFVBQUlwQixNQUFNLENBQUNxQixZQUFQLENBQW9CQyxLQUFwQixJQUE2QixDQUFqQyxFQUFvQztBQUNsQyxZQUFJO0FBQ0YsZ0JBQU0sMkJBQVV0QixNQUFNLENBQUNOLElBQWpCLEVBQXVCRyxJQUFJLENBQUNzQixRQUE1QixDQUFOO0FBQ0QsU0FGRCxDQUVFLE9BQU9JLEdBQVAsRUFBWTtBQUNabkIsMEJBQUlDLElBQUosQ0FBVSw2REFBNERSLElBQUksQ0FBQ3NCLFFBQVMsR0FBcEY7QUFDRDtBQUNGLE9BTkQsTUFNTztBQUNMLGNBQU1iLGlCQUFpQixDQUFDTixNQUFELENBQXZCO0FBQ0Q7QUFDRjs7QUFDRCxRQUFJSCxJQUFJLENBQUMyQixHQUFULEVBQWM7QUFDWnBCLHNCQUFJYyxJQUFKLENBQVMsNERBQVQ7O0FBQ0E7QUFDRDs7QUFDRCxVQUFNTyxRQUFRLEdBQUcsQ0FBQzVCLElBQUksQ0FBQzZCLFdBQUwsSUFBb0IsRUFBckIsRUFBeUJDLFdBQXpCLE9BQTJDLFFBQTVEOztBQUNBLFFBQUk7QUFDRixVQUFJRixRQUFKLEVBQWM7QUFDWixjQUFNekIsTUFBTSxDQUFDNEIsV0FBUCxFQUFOO0FBQ0QsT0FGRCxNQUVPO0FBQ0wsY0FBTTVCLE1BQU0sQ0FBQzZCLGNBQVAsQ0FBc0JDLGNBQUtDLFFBQUwsQ0FBY2xDLElBQUksQ0FBQzJCLEdBQW5CLENBQXRCLEVBQStDM0IsSUFBSSxDQUFDc0IsUUFBcEQsQ0FBTjtBQUNEO0FBQ0YsS0FORCxDQU1FLE9BQU9JLEdBQVAsRUFBWTtBQUNabkIsc0JBQUlDLElBQUosQ0FBU2tCLEdBQUcsQ0FBQ1MsT0FBYjs7QUFDQTVCLHNCQUFJQyxJQUFKLENBQVUsMEJBQXlCb0IsUUFBUSxHQUFHLGdCQUFILEdBQXNCLDBCQUEwQjVCLElBQUksQ0FBQ3NCLFFBQS9CLEdBQTBDLEdBQUksa0JBQS9HO0FBQ0Q7QUFDRjtBQUNGOztBQUVELGVBQWVjLGtCQUFmLENBQW1DakMsTUFBbkMsRUFBMkN3QixHQUEzQyxFQUFnREwsUUFBaEQsRUFBMERWLE9BQU8sR0FBRyxJQUFwRSxFQUEwRTtBQUN4RSxNQUFJLENBQUNlLEdBQUwsRUFBVTtBQUNScEIsb0JBQUlPLEtBQUosQ0FBVSwyQ0FBVjs7QUFDQTtBQUNEOztBQUVELE1BQUlRLFFBQUosRUFBYztBQUNaLFFBQUksTUFBTW5CLE1BQU0sQ0FBQ2tDLGNBQVAsQ0FBc0JmLFFBQXRCLENBQVYsRUFBMkM7QUFDekMsVUFBSVYsT0FBSixFQUFhO0FBQ1hMLHdCQUFJTyxLQUFKLENBQVcsUUFBT1EsUUFBUywrQ0FBM0I7O0FBQ0E7QUFDRDs7QUFDRGYsc0JBQUlPLEtBQUosQ0FBVywwQ0FBeUNRLFFBQVMsbUJBQTdEOztBQUNBLFlBQU1uQixNQUFNLENBQUNtQyxTQUFQLENBQWlCaEIsUUFBakIsQ0FBTjtBQUNEO0FBQ0Y7O0FBRUQsUUFBTWlCLGlCQUFpQixHQUFHTixjQUFLTyxPQUFMLENBQWFyQyxNQUFNLENBQUNzQyxNQUFQLEVBQWIsRUFBOEIsU0FBOUIsRUFBeUMsUUFBekMsRUFBbUR2RCxvQkFBbkQsQ0FBMUI7O0FBQ0EsTUFBSXdELE9BQU8sR0FBRyxJQUFkOztBQUNBLE1BQUksTUFBTUMsa0JBQUdDLE1BQUgsQ0FBVUwsaUJBQVYsQ0FBVixFQUF3QztBQUd0Q0csSUFBQUEsT0FBTyxHQUFHLE1BQU1HLHVCQUFRQyxPQUFSLEVBQWhCOztBQUNBdkMsb0JBQUlPLEtBQUosQ0FBVSxnREFBVjs7QUFDQSxVQUFNNkIsa0JBQUdJLEVBQUgsQ0FBTVIsaUJBQU4sRUFBeUJOLGNBQUtPLE9BQUwsQ0FBYUUsT0FBYixFQUFzQnhELG9CQUF0QixDQUF6QixFQUFzRTtBQUFDOEQsTUFBQUEsTUFBTSxFQUFFO0FBQVQsS0FBdEUsQ0FBTjtBQUNBLFVBQU0sMkJBQU9ULGlCQUFQLENBQU47QUFDRDs7QUFFRGhDLGtCQUFJTyxLQUFKLENBQVcsZUFBY2EsR0FBSSw2QkFBNEJ4QixNQUFNLENBQUNOLElBQUssTUFBckU7O0FBQ0EsTUFBSTtBQUNGLFFBQUk7QUFDRixZQUFNTSxNQUFNLENBQUM4QyxVQUFQLENBQWtCdEIsR0FBbEIsQ0FBTjtBQUNELEtBRkQsQ0FFRSxPQUFPdUIsQ0FBUCxFQUFVO0FBRVYzQyxzQkFBSWMsSUFBSixDQUFVLG9CQUFtQk0sR0FBSSxjQUFhdUIsQ0FBQyxDQUFDZixPQUFRLEVBQXhEOztBQUNBLFVBQUllLENBQUMsQ0FBQ2YsT0FBRixDQUFVZ0IsUUFBVixDQUFtQix3Q0FBbkIsS0FBZ0VULE9BQXBFLEVBQTZFO0FBRTNFbkMsd0JBQUljLElBQUosQ0FBVSxvRUFBbUVNLEdBQUksS0FBeEUsR0FDTixxQkFESDs7QUFFQSxjQUFNZ0Isa0JBQUdTLE1BQUgsQ0FBVWIsaUJBQVYsQ0FBTjtBQUNBLGNBQU1JLGtCQUFHSSxFQUFILENBQU1kLGNBQUtPLE9BQUwsQ0FBYUUsT0FBYixFQUFzQnhELG9CQUF0QixDQUFOLEVBQW1EcUQsaUJBQW5ELEVBQXNFO0FBQUNTLFVBQUFBLE1BQU0sRUFBRTtBQUFULFNBQXRFLENBQU47QUFDRDs7QUFDRHpDLHNCQUFJYyxJQUFKLENBQVMsOEJBQVQ7O0FBQ0EsWUFBTWxCLE1BQU0sQ0FBQzhDLFVBQVAsQ0FBa0J0QixHQUFsQixDQUFOO0FBQ0Q7O0FBQ0RwQixvQkFBSU8sS0FBSixDQUFVLDBDQUFWO0FBQ0QsR0FqQkQsU0FpQlU7QUFDUixRQUFJNEIsT0FBTyxLQUFJLE1BQU1DLGtCQUFHQyxNQUFILENBQVVGLE9BQVYsQ0FBVixDQUFYLEVBQXlDO0FBQ3ZDLFlBQU1DLGtCQUFHUyxNQUFILENBQVVWLE9BQVYsQ0FBTjtBQUNEO0FBQ0Y7QUFDRjs7QUFFRCxlQUFlVyx1QkFBZixDQUF3Q0MsYUFBeEMsRUFBdUQ7QUFDckQsUUFBTUMsVUFBVSxHQUFHbkQsZ0JBQUVvRCxPQUFGLENBQVVwRCxnQkFBRUMsTUFBRixFQUFTLE1BQU0sNkJBQWYsRUFBVixDQUFuQjs7QUFDQSxRQUFNb0Qsa0JBQWtCLEdBQUdGLFVBQVUsQ0FBQ0csTUFBWCxDQUFtQnZELE1BQUQsSUFBWUEsTUFBTSxDQUFDTixJQUFQLEtBQWdCeUQsYUFBYSxDQUFDekQsSUFBOUIsSUFBc0NNLE1BQU0sQ0FBQ3dELEtBQVAsS0FBaUIsUUFBckYsQ0FBM0I7O0FBQ0EsTUFBSXZELGdCQUFFd0QsT0FBRixDQUFVSCxrQkFBVixDQUFKLEVBQW1DO0FBQ2pDbEQsb0JBQUljLElBQUosQ0FBUyxnREFBVDs7QUFDQTtBQUNEOztBQUNEZCxrQkFBSWMsSUFBSixDQUFVLFlBQVdvQyxrQkFBa0IsQ0FBQ0ksTUFBTywyQkFBMEJKLGtCQUFrQixDQUFDSSxNQUFuQixLQUE4QixDQUE5QixHQUFrQyxFQUFsQyxHQUF1QyxHQUFJLEdBQTNHLEdBQ0MsWUFBV0osa0JBQWtCLENBQUNJLE1BQW5CLEtBQThCLENBQTlCLEdBQWtDLElBQWxDLEdBQXlDLE1BQU8sVUFEckU7O0FBRUEscUJBQXFCSixrQkFBckIsRUFBeUM7QUFBQSxVQUE5QjtBQUFDNUQsTUFBQUE7QUFBRCxLQUE4QjtBQUd2QyxVQUFNLGlDQUFxQkEsSUFBckIsRUFBMkIsSUFBM0IsQ0FBTjtBQUNBLFVBQU0sMEJBQVNBLElBQVQsQ0FBTjtBQUNEO0FBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IGdldFNpbXVsYXRvciB9IGZyb20gJ2FwcGl1bS1pb3Mtc2ltdWxhdG9yJztcbmltcG9ydCB7IGNyZWF0ZURldmljZSwgZ2V0RGV2aWNlcywgdGVybWluYXRlLCBzaHV0ZG93biB9IGZyb20gJ25vZGUtc2ltY3RsJztcbmltcG9ydCB7IHJlc2V0WENUZXN0UHJvY2Vzc2VzIH0gZnJvbSAnLi91dGlscyc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IGxvZyBmcm9tICcuL2xvZ2dlcic7XG5pbXBvcnQgeyB0ZW1wRGlyLCBmcywgbWtkaXJwIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IFVVSUQgZnJvbSAndXVpZC1qcyc7XG5pbXBvcnQgeyBQTEFURk9STV9OQU1FX0lPUyB9IGZyb20gJy4vZGVzaXJlZC1jYXBzJztcblxuXG5jb25zdCBJTlNUQUxMX0RBRU1PTl9DQUNIRSA9ICdjb20uYXBwbGUubW9iaWxlLmluc3RhbGxkLnN0YWdpbmcnO1xuXG5cbi8qKlxuICogQ2FwYWJpbGl0eSBzZXQgYnkgYSB1c2VyXG4gKlxuICogQHByb3BlcnR5IHtzdHJpbmd9IGRldmljZU5hbWUgLSBBIG5hbWUgZm9yIHRoZSBkZXZpY2VcbiAqIEBwcm9wZXJ0eSB7c3RyaW5nfSBwbGF0Zm9ybVZlcnNpb24gLSBUaGUgdmVyc2lvbiBvZiBpT1MgdG8gdXNlXG4gKi9cbi8qKlxuICogQ3JlYXRlIGEgbmV3IHNpbXVsYXRvciB3aXRoIGBhcHBpdW1UZXN0LWAgcHJlZml4IGFuZCByZXR1cm4gdGhlIG9iamVjdC5cbiAqXG4gKiBAcGFyYW0ge29iamVjdH0gU2ltQ3JlYXRpb25DYXBzIC0gQ2FwYWJpbGl0eSBzZXQgYnkgYSB1c2VyLiBUaGUgb3B0aW9ucyBhdmFpbGFibGUgYXJlOlxuICogQHByb3BlcnR5IHtzdHJpbmd9IHBsYXRmb3JtIFtpT1NdIC0gUGxhdGZvcm0gbmFtZSBpbiBvcmRlciB0byBzcGVjaWZ5IHJ1bnRpbWUgc3VjaCBhcyAnaU9TJywgJ3R2T1MnLCAnd2F0Y2hPUydcbiAqIEByZXR1cm5zIHtvYmplY3R9IFNpbXVsYXRvciBvYmplY3QgYXNzb2NpYXRlZCB3aXRoIHRoZSB1ZGlkIHBhc3NlZCBpbi5cbiAqL1xuYXN5bmMgZnVuY3Rpb24gY3JlYXRlU2ltIChjYXBzLCBwbGF0Zm9ybSA9IFBMQVRGT1JNX05BTUVfSU9TKSB7XG4gIGNvbnN0IGFwcGl1bVRlc3REZXZpY2VOYW1lID0gYGFwcGl1bVRlc3QtJHtVVUlELmNyZWF0ZSgpLnRvU3RyaW5nKCkudG9VcHBlckNhc2UoKX0tJHtjYXBzLmRldmljZU5hbWV9YDtcbiAgY29uc3QgdWRpZCA9IGF3YWl0IGNyZWF0ZURldmljZShcbiAgICBhcHBpdW1UZXN0RGV2aWNlTmFtZSxcbiAgICBjYXBzLmRldmljZU5hbWUsXG4gICAgY2Fwcy5wbGF0Zm9ybVZlcnNpb24sXG4gICAgeyBwbGF0Zm9ybSB9XG4gICk7XG4gIHJldHVybiBhd2FpdCBnZXRTaW11bGF0b3IodWRpZCk7XG59XG5cbi8qKlxuICogR2V0IGEgc2ltdWxhdG9yIHdoaWNoIGlzIGFscmVhZHkgcnVubmluZy5cbiAqXG4gKiBAcGFyYW0ge29iamVjdH0gb3B0cyAtIENhcGFiaWxpdHkgc2V0IGJ5IGEgdXNlci4gVGhlIG9wdGlvbnMgYXZhaWxhYmxlIGFyZTpcbiAqICAgLSBgZGV2aWNlTmFtZWAgLSBhIG5hbWUgZm9yIHRoZSBkZXZpY2VcbiAqICAgLSBgcGxhdGZvcm1WZXJzaW9uYCAtIHRoZSB2ZXJzaW9uIG9mIGlPUyB0byB1c2VcbiAqIEByZXR1cm5zIHs/b2JqZWN0fSBTaW11bGF0b3Igb2JqZWN0IGFzc29jaWF0ZWQgd2l0aCB0aGUgdWRpZCBwYXNzZWQgaW4uIE9yIG51bGwgaWYgbm8gZGV2aWNlIGlzIHJ1bm5pbmcuXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIGdldEV4aXN0aW5nU2ltIChvcHRzKSB7XG4gIGNvbnN0IGRldmljZXMgPSBhd2FpdCBnZXREZXZpY2VzKG9wdHMucGxhdGZvcm1WZXJzaW9uKTtcbiAgY29uc3QgYXBwaXVtVGVzdERldmljZU5hbWUgPSBgYXBwaXVtVGVzdC0ke29wdHMuZGV2aWNlTmFtZX1gO1xuXG4gIGxldCBhcHBpdW1UZXN0RGV2aWNlO1xuXG4gIGZvciAoY29uc3QgZGV2aWNlIG9mIF8udmFsdWVzKGRldmljZXMpKSB7XG4gICAgaWYgKGRldmljZS5uYW1lID09PSBvcHRzLmRldmljZU5hbWUpIHtcbiAgICAgIHJldHVybiBhd2FpdCBnZXRTaW11bGF0b3IoZGV2aWNlLnVkaWQpO1xuICAgIH1cblxuICAgIGlmIChkZXZpY2UubmFtZSA9PT0gYXBwaXVtVGVzdERldmljZU5hbWUpIHtcbiAgICAgIGFwcGl1bVRlc3REZXZpY2UgPSBkZXZpY2U7XG4gICAgfVxuICB9XG5cbiAgaWYgKGFwcGl1bVRlc3REZXZpY2UpIHtcbiAgICBsb2cud2FybihgVW5hYmxlIHRvIGZpbmQgZGV2aWNlICcke29wdHMuZGV2aWNlTmFtZX0nLiBGb3VuZCAnJHthcHBpdW1UZXN0RGV2aWNlLm5hbWV9JyAodWRpZDogJyR7YXBwaXVtVGVzdERldmljZS51ZGlkfScpIGluc3RlYWRgKTtcbiAgICByZXR1cm4gYXdhaXQgZ2V0U2ltdWxhdG9yKGFwcGl1bVRlc3REZXZpY2UudWRpZCk7XG4gIH1cbiAgcmV0dXJuIG51bGw7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHNodXRkb3duU2ltdWxhdG9yIChkZXZpY2UpIHtcbiAgLy8gc3RvcCBYQ1Rlc3QgcHJvY2Vzc2VzIGlmIHJ1bm5pbmcgdG8gYXZvaWQgdW5leHBlY3RlZCBzaWRlIGVmZmVjdHNcbiAgYXdhaXQgcmVzZXRYQ1Rlc3RQcm9jZXNzZXMoZGV2aWNlLnVkaWQsIHRydWUpO1xuICBhd2FpdCBkZXZpY2Uuc2h1dGRvd24oKTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gcnVuU2ltdWxhdG9yUmVzZXQgKGRldmljZSwgb3B0cykge1xuICBpZiAob3B0cy5ub1Jlc2V0ICYmICFvcHRzLmZ1bGxSZXNldCkge1xuICAgIC8vIG5vUmVzZXQgPT09IHRydWUgJiYgZnVsbFJlc2V0ID09PSBmYWxzZVxuICAgIGxvZy5kZWJ1ZygnUmVzZXQ6IG5vUmVzZXQgaXMgb24uIExlYXZpbmcgc2ltdWxhdG9yIGFzIGlzJyk7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgaWYgKCFkZXZpY2UpIHtcbiAgICBsb2cuZGVidWcoJ1Jlc2V0OiBubyBkZXZpY2UgYXZhaWxhYmxlLiBTa2lwcGluZycpO1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGlmIChvcHRzLmZ1bGxSZXNldCkge1xuICAgIGxvZy5kZWJ1ZygnUmVzZXQ6IGZ1bGxSZXNldCBpcyBvbi4gQ2xlYW5pbmcgc2ltdWxhdG9yJyk7XG4gICAgYXdhaXQgc2h1dGRvd25TaW11bGF0b3IoZGV2aWNlKTtcbiAgICBsZXQgaXNLZXljaGFpbnNCYWNrdXBTdWNjZXNzZnVsID0gZmFsc2U7XG4gICAgaWYgKG9wdHMua2V5Y2hhaW5zRXhjbHVkZVBhdHRlcm5zIHx8IG9wdHMua2VlcEtleUNoYWlucykge1xuICAgICAgaXNLZXljaGFpbnNCYWNrdXBTdWNjZXNzZnVsID0gYXdhaXQgZGV2aWNlLmJhY2t1cEtleWNoYWlucygpO1xuICAgIH1cbiAgICBhd2FpdCBkZXZpY2UuY2xlYW4oKTtcbiAgICBpZiAoaXNLZXljaGFpbnNCYWNrdXBTdWNjZXNzZnVsKSB7XG4gICAgICBhd2FpdCBkZXZpY2UucmVzdG9yZUtleWNoYWlucyhvcHRzLmtleWNoYWluc0V4Y2x1ZGVQYXR0ZXJucyB8fCBbXSk7XG4gICAgICBsb2cuaW5mbyhgU3VjY2Vzc2Z1bGx5IHJlc3RvcmVkIGtleWNoYWlucyBhZnRlciBmdWxsIHJlc2V0YCk7XG4gICAgfSBlbHNlIGlmIChvcHRzLmtleWNoYWluc0V4Y2x1ZGVQYXR0ZXJucyB8fCBvcHRzLmtlZXBLZXlDaGFpbnMpIHtcbiAgICAgIGxvZy53YXJuKCdDYW5ub3QgcmVzdG9yZSBrZXljaGFpbnMgYWZ0ZXIgZnVsbCByZXNldCwgYmVjYXVzZSAnICtcbiAgICAgICAgICAgICAgICd0aGUgYmFja3VwIG9wZXJhdGlvbiBkaWQgbm90IHN1Y2NlZWQnKTtcbiAgICB9XG4gIH0gZWxzZSBpZiAob3B0cy5idW5kbGVJZCkge1xuICAgIC8vIFRlcm1pbmF0ZSB0aGUgYXBwIHVuZGVyIHRlc3QgaWYgaXQgaXMgc3RpbGwgcnVubmluZyBvbiBTaW11bGF0b3JcbiAgICAvLyBUZXJtaW5hdGlvbiBpcyBub3QgbmVlZGVkIGlmIFNpbXVsYXRvciBpcyBub3QgcnVubmluZ1xuICAgIGlmIChhd2FpdCBkZXZpY2UuaXNSdW5uaW5nKCkpIHtcbiAgICAgIGlmIChkZXZpY2UueGNvZGVWZXJzaW9uLm1ham9yID49IDgpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBhd2FpdCB0ZXJtaW5hdGUoZGV2aWNlLnVkaWQsIG9wdHMuYnVuZGxlSWQpO1xuICAgICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgICBsb2cud2FybihgUmVzZXQ6IGZhaWxlZCB0byB0ZXJtaW5hdGUgU2ltdWxhdG9yIGFwcGxpY2F0aW9uIHdpdGggaWQgXCIke29wdHMuYnVuZGxlSWR9XCJgKTtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgYXdhaXQgc2h1dGRvd25TaW11bGF0b3IoZGV2aWNlKTtcbiAgICAgIH1cbiAgICB9XG4gICAgaWYgKG9wdHMuYXBwKSB7XG4gICAgICBsb2cuaW5mbygnTm90IHNjcnViYmluZyB0aGlyZCBwYXJ0eSBhcHAgaW4gYW50aWNpcGF0aW9uIG9mIHVuaW5zdGFsbCcpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cbiAgICBjb25zdCBpc1NhZmFyaSA9IChvcHRzLmJyb3dzZXJOYW1lIHx8ICcnKS50b0xvd2VyQ2FzZSgpID09PSAnc2FmYXJpJztcbiAgICB0cnkge1xuICAgICAgaWYgKGlzU2FmYXJpKSB7XG4gICAgICAgIGF3YWl0IGRldmljZS5jbGVhblNhZmFyaSgpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgYXdhaXQgZGV2aWNlLnNjcnViQ3VzdG9tQXBwKHBhdGguYmFzZW5hbWUob3B0cy5hcHApLCBvcHRzLmJ1bmRsZUlkKTtcbiAgICAgIH1cbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGxvZy53YXJuKGVyci5tZXNzYWdlKTtcbiAgICAgIGxvZy53YXJuKGBSZXNldDogY291bGQgbm90IHNjcnViICR7aXNTYWZhcmkgPyAnU2FmYXJpIGJyb3dzZXInIDogJ2FwcGxpY2F0aW9uIHdpdGggaWQgXCInICsgb3B0cy5idW5kbGVJZCArICdcIid9LiBMZWF2aW5nIGFzIGlzLmApO1xuICAgIH1cbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBpbnN0YWxsVG9TaW11bGF0b3IgKGRldmljZSwgYXBwLCBidW5kbGVJZCwgbm9SZXNldCA9IHRydWUpIHtcbiAgaWYgKCFhcHApIHtcbiAgICBsb2cuZGVidWcoJ05vIGFwcCBwYXRoIGlzIGdpdmVuLiBOb3RoaW5nIHRvIGluc3RhbGwuJyk7XG4gICAgcmV0dXJuO1xuICB9XG5cbiAgaWYgKGJ1bmRsZUlkKSB7XG4gICAgaWYgKGF3YWl0IGRldmljZS5pc0FwcEluc3RhbGxlZChidW5kbGVJZCkpIHtcbiAgICAgIGlmIChub1Jlc2V0KSB7XG4gICAgICAgIGxvZy5kZWJ1ZyhgQXBwICcke2J1bmRsZUlkfScgaXMgYWxyZWFkeSBpbnN0YWxsZWQuIE5vIG5lZWQgdG8gcmVpbnN0YWxsLmApO1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBsb2cuZGVidWcoYFJlc2V0IHJlcXVlc3RlZC4gUmVtb3ZpbmcgYXBwIHdpdGggaWQgJyR7YnVuZGxlSWR9JyBmcm9tIHRoZSBkZXZpY2VgKTtcbiAgICAgIGF3YWl0IGRldmljZS5yZW1vdmVBcHAoYnVuZGxlSWQpO1xuICAgIH1cbiAgfVxuXG4gIGNvbnN0IGluc3RhbGxkQ2FjaGVSb290ID0gcGF0aC5yZXNvbHZlKGRldmljZS5nZXREaXIoKSwgJ0xpYnJhcnknLCAnQ2FjaGVzJywgSU5TVEFMTF9EQUVNT05fQ0FDSEUpO1xuICBsZXQgdG1wUm9vdCA9IG51bGw7XG4gIGlmIChhd2FpdCBmcy5leGlzdHMoaW5zdGFsbGRDYWNoZVJvb3QpKSB7XG4gICAgLy8gQ2xlYW51cCBvZiBpbnN0YWxsZCBjYWNoZSBoZWxwcyB0byBzYXZlIGRpc2sgc3BhY2Ugd2hpbGUgcnVubmluZyBtdWx0aXBsZSB0ZXN0c1xuICAgIC8vIHdpdGhvdXQgcmVzdGFydGluZyB0aGUgU2ltdWxhdG9yOiBodHRwczovL2dpdGh1Yi5jb20vYXBwaXVtL2FwcGl1bS9pc3N1ZXMvOTQxMFxuICAgIHRtcFJvb3QgPSBhd2FpdCB0ZW1wRGlyLm9wZW5EaXIoKTtcbiAgICBsb2cuZGVidWcoJ0NsZWFuaW5nIGluc3RhbGxkIGNhY2hlIHRvIHNhdmUgdGhlIGRpc2sgc3BhY2UnKTtcbiAgICBhd2FpdCBmcy5tdihpbnN0YWxsZENhY2hlUm9vdCwgcGF0aC5yZXNvbHZlKHRtcFJvb3QsIElOU1RBTExfREFFTU9OX0NBQ0hFKSwge21rZGlycDogdHJ1ZX0pO1xuICAgIGF3YWl0IG1rZGlycChpbnN0YWxsZENhY2hlUm9vdCk7XG4gIH1cblxuICBsb2cuZGVidWcoYEluc3RhbGxpbmcgJyR7YXBwfScgb24gU2ltdWxhdG9yIHdpdGggVVVJRCAnJHtkZXZpY2UudWRpZH0nLi4uYCk7XG4gIHRyeSB7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IGRldmljZS5pbnN0YWxsQXBwKGFwcCk7XG4gICAgfSBjYXRjaCAoZSkge1xuICAgICAgLy8gb24gWGNvZGUgMTAgc29tZXRpbWVzIHRoaXMgaXMgdG9vIGZhc3QgYW5kIGl0IGZhaWxzXG4gICAgICBsb2cuaW5mbyhgR290IGFuIGVycm9yIG9uICcke2FwcH0nIGluc3RhbGw6ICR7ZS5tZXNzYWdlfWApO1xuICAgICAgaWYgKGUubWVzc2FnZS5pbmNsdWRlcygnZG9tYWluPU1JSW5zdGFsbGVyRXJyb3JEb21haW4sIGNvZGU9MzUnKSAmJiB0bXBSb290KSB7XG4gICAgICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9hcHBpdW0vYXBwaXVtL2lzc3Vlcy8xMTM1MFxuICAgICAgICBsb2cuaW5mbyhgaW5zdGFsbGQgcmVxdWlyZXMgdGhlIGNhY2hlIHRvIGJlIGF2YWlsYWJsZSBpbiBvcmRlciB0byBpbnN0YWxsICcke2FwcH0nLiBgICtcbiAgICAgICAgICBgUmVzdG9yaW5nIHRoZSBjYWNoZWApO1xuICAgICAgICBhd2FpdCBmcy5yaW1yYWYoaW5zdGFsbGRDYWNoZVJvb3QpO1xuICAgICAgICBhd2FpdCBmcy5tdihwYXRoLnJlc29sdmUodG1wUm9vdCwgSU5TVEFMTF9EQUVNT05fQ0FDSEUpLCBpbnN0YWxsZENhY2hlUm9vdCwge21rZGlycDogdHJ1ZX0pO1xuICAgICAgfVxuICAgICAgbG9nLmluZm8oJ1JldHJ5aW5nIGFwcGxpY2F0aW9uIGluc3RhbGwnKTtcbiAgICAgIGF3YWl0IGRldmljZS5pbnN0YWxsQXBwKGFwcCk7XG4gICAgfVxuICAgIGxvZy5kZWJ1ZygnVGhlIGFwcCBoYXMgYmVlbiBpbnN0YWxsZWQgc3VjY2Vzc2Z1bGx5LicpO1xuICB9IGZpbmFsbHkge1xuICAgIGlmICh0bXBSb290ICYmIGF3YWl0IGZzLmV4aXN0cyh0bXBSb290KSkge1xuICAgICAgYXdhaXQgZnMucmltcmFmKHRtcFJvb3QpO1xuICAgIH1cbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBzaHV0ZG93bk90aGVyU2ltdWxhdG9ycyAoY3VycmVudERldmljZSkge1xuICBjb25zdCBhbGxEZXZpY2VzID0gXy5mbGF0TWFwKF8udmFsdWVzKGF3YWl0IGdldERldmljZXMoKSkpO1xuICBjb25zdCBvdGhlckJvb3RlZERldmljZXMgPSBhbGxEZXZpY2VzLmZpbHRlcigoZGV2aWNlKSA9PiBkZXZpY2UudWRpZCAhPT0gY3VycmVudERldmljZS51ZGlkICYmIGRldmljZS5zdGF0ZSA9PT0gJ0Jvb3RlZCcpO1xuICBpZiAoXy5pc0VtcHR5KG90aGVyQm9vdGVkRGV2aWNlcykpIHtcbiAgICBsb2cuaW5mbygnTm8gb3RoZXIgcnVubmluZyBzaW11bGF0b3JzIGhhdmUgYmVlbiBkZXRlY3RlZCcpO1xuICAgIHJldHVybjtcbiAgfVxuICBsb2cuaW5mbyhgRGV0ZWN0ZWQgJHtvdGhlckJvb3RlZERldmljZXMubGVuZ3RofSBvdGhlciBydW5uaW5nIFNpbXVsYXRvciR7b3RoZXJCb290ZWREZXZpY2VzLmxlbmd0aCA9PT0gMSA/ICcnIDogJ3MnfS5gICtcbiAgICAgICAgICAgYFNodXR0aW5nICR7b3RoZXJCb290ZWREZXZpY2VzLmxlbmd0aCA9PT0gMSA/ICdpdCcgOiAndGhlbSd9IGRvd24uLi5gKTtcbiAgZm9yIChjb25zdCB7dWRpZH0gb2Ygb3RoZXJCb290ZWREZXZpY2VzKSB7XG4gICAgLy8gSXQgaXMgbmVjZXNzYXJ5IHRvIHN0b3AgdGhlIGNvcnJlc3BvbmRpbmcgeGNvZGVidWlsZCBwcm9jZXNzIGJlZm9yZSBraWxsaW5nXG4gICAgLy8gdGhlIHNpbXVsYXRvciwgb3RoZXJ3aXNlIGl0IHdpbGwgYmUgYXV0b21hdGljYWxseSByZXN0YXJ0ZWRcbiAgICBhd2FpdCByZXNldFhDVGVzdFByb2Nlc3Nlcyh1ZGlkLCB0cnVlKTtcbiAgICBhd2FpdCBzaHV0ZG93bih1ZGlkKTtcbiAgfVxufVxuXG5leHBvcnQgeyBjcmVhdGVTaW0sIGdldEV4aXN0aW5nU2ltLCBydW5TaW11bGF0b3JSZXNldCwgaW5zdGFsbFRvU2ltdWxhdG9yLFxuICBzaHV0ZG93blNpbXVsYXRvciwgc2h1dGRvd25PdGhlclNpbXVsYXRvcnMgfTtcbiJdLCJmaWxlIjoibGliL3NpbXVsYXRvci1tYW5hZ2VtZW50LmpzIiwic291cmNlUm9vdCI6Ii4uLy4uIn0=
