"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.WDA_BASE_URL = exports.BOOTSTRAP_PATH = exports.WDA_BUNDLE_ID = exports.WebDriverAgent = exports.default = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _path = _interopRequireDefault(require("path"));

var _url2 = _interopRequireDefault(require("url"));

var _appiumBaseDriver = require("appium-base-driver");

var _appiumSupport = require("appium-support");

var _logger = _interopRequireDefault(require("../logger"));

var _noSessionProxy = require("./no-session-proxy");

var _utils = require("./utils");

var _utils2 = require("../utils");

var _xcodebuild = _interopRequireDefault(require("./xcodebuild"));

var _iproxy = _interopRequireDefault(require("./iproxy"));

var _teen_process = require("teen_process");

var _asyncLock = _interopRequireDefault(require("async-lock"));

const BOOTSTRAP_PATH = _path.default.resolve(__dirname, '..', '..', '..', 'WebDriverAgent');

exports.BOOTSTRAP_PATH = BOOTSTRAP_PATH;
const WDA_BUNDLE_ID = 'com.apple.test.WebDriverAgentRunner-Runner';
exports.WDA_BUNDLE_ID = WDA_BUNDLE_ID;
const WDA_LAUNCH_TIMEOUT = 60 * 1000;
const WDA_AGENT_PORT = 8100;
const WDA_BASE_URL = 'http://localhost';
exports.WDA_BASE_URL = WDA_BASE_URL;
const SHARED_RESOURCES_GUARD = new _asyncLock.default();

class WebDriverAgent {
  constructor(xcodeVersion, args = {}) {
    this.xcodeVersion = xcodeVersion;
    this.args = _lodash.default.clone(args);
    this.device = args.device;
    this.platformVersion = args.platformVersion;
    this.platformName = args.platformName;
    this.iosSdkVersion = args.iosSdkVersion;
    this.host = args.host;
    this.realDevice = !!args.realDevice;
    this.setWDAPaths(args.bootstrapPath, args.agentPath);
    this.wdaLocalPort = args.wdaLocalPort;
    this.wdaBaseUrl = args.wdaBaseUrl || WDA_BASE_URL;
    this.prebuildWDA = args.prebuildWDA;
    this.webDriverAgentUrl = args.webDriverAgentUrl;
    this.started = false;
    this.wdaConnectionTimeout = args.wdaConnectionTimeout;
    this.useCarthageSsl = _lodash.default.isBoolean(args.useCarthageSsl) && args.useCarthageSsl;
    this.useXctestrunFile = args.useXctestrunFile;
    this.xcodebuild = new _xcodebuild.default(this.xcodeVersion, this.device, {
      platformVersion: this.platformVersion,
      platformName: this.platformName,
      iosSdkVersion: this.iosSdkVersion,
      agentPath: this.agentPath,
      bootstrapPath: this.bootstrapPath,
      realDevice: this.realDevice,
      showXcodeLog: args.showXcodeLog,
      xcodeConfigFile: args.xcodeConfigFile,
      xcodeOrgId: args.xcodeOrgId,
      xcodeSigningId: args.xcodeSigningId,
      keychainPath: args.keychainPath,
      keychainPassword: args.keychainPassword,
      useSimpleBuildTest: args.useSimpleBuildTest,
      usePrebuiltWDA: args.usePrebuiltWDA,
      updatedWDABundleId: args.updatedWDABundleId,
      launchTimeout: args.wdaLaunchTimeout || WDA_LAUNCH_TIMEOUT,
      wdaRemotePort: this.realDevice ? WDA_AGENT_PORT : this.wdaLocalPort || WDA_AGENT_PORT,
      useXctestrunFile: this.useXctestrunFile,
      derivedDataPath: args.derivedDataPath,
      mjpegServerPort: args.mjpegServerPort
    });
  }

  setWDAPaths(bootstrapPath, agentPath) {
    this.bootstrapPath = bootstrapPath || BOOTSTRAP_PATH;

    _logger.default.info(`Using WDA path: '${this.bootstrapPath}'`);

    this.agentPath = agentPath || _path.default.resolve(this.bootstrapPath, 'WebDriverAgent.xcodeproj');

    _logger.default.info(`Using WDA agent: '${this.agentPath}'`);
  }

  async cleanupObsoleteProcesses() {
    const pids = await (0, _utils2.getPIDsListeningOnPort)(this.url.port, cmdLine => (cmdLine.includes('/WebDriverAgentRunner') || cmdLine.includes('/iproxy')) && !cmdLine.toLowerCase().includes(this.device.udid.toLowerCase()));

    if (!pids.length) {
      _logger.default.debug(`No obsolete cached processes from previous WDA sessions ` + `listening on port ${this.url.port} have been found`);

      return;
    }

    _logger.default.info(`Detected ${pids.length} obsolete cached process${pids.length === 1 ? '' : 'es'} ` + `from previous WDA sessions. Cleaning up...`);

    try {
      await (0, _teen_process.exec)('kill', pids);
    } catch (e) {
      _logger.default.warn(`Failed to kill obsolete cached process${pids.length === 1 ? '' : 'es'} '${pids}'. ` + `Original error: ${e.message}`);
    }
  }

  async isRunning() {
    return !!(await this.getStatus());
  }

  async getStatus() {
    const noSessionProxy = new _noSessionProxy.NoSessionProxy({
      server: this.url.hostname,
      port: this.url.port,
      base: '',
      timeout: 3000
    });

    try {
      return await noSessionProxy.command('/status', 'GET');
    } catch (err) {
      _logger.default.debug(`WDA is not listening at '${this.url.href}'`);

      return null;
    }
  }

  async uninstall() {
    _logger.default.debug(`Removing WDA application from device`);

    try {
      await this.device.removeApp(WDA_BUNDLE_ID);
    } catch (e) {
      _logger.default.warn(`WebDriverAgent uninstall failed. Perhaps, it is already uninstalled? Original error: ${JSON.stringify(e)}`);
    }
  }

  async launch(sessionId) {
    if (this.webDriverAgentUrl) {
      _logger.default.info(`Using provided WebdriverAgent at '${this.webDriverAgentUrl}'`);

      this.url = this.webDriverAgentUrl;
      this.setupProxies(sessionId);
      return await this.getStatus();
    }

    _logger.default.info('Launching WebDriverAgent on the device');

    this.setupProxies(sessionId);

    if (!this.useXctestrunFile && !(await _appiumSupport.fs.exists(this.agentPath))) {
      throw new Error(`Trying to use WebDriverAgent project at '${this.agentPath}' but the ` + 'file does not exist');
    }

    if (!this.useXctestrunFile) {
      const synchronizationKey = _path.default.normalize(this.bootstrapPath);

      await SHARED_RESOURCES_GUARD.acquire(synchronizationKey, async () => {
        const didPerformUpgrade = await (0, _utils.checkForDependencies)(this.bootstrapPath, this.useCarthageSsl);

        if (didPerformUpgrade) {
          await this.xcodebuild.cleanProject();
        }
      });
    }

    await (0, _utils2.resetXCTestProcesses)(this.device.udid, !this.realDevice, {
      wdaLocalPort: this.url.port
    });

    if (this.realDevice) {
      if ((0, _utils2.isLocalHost)(this.wdaBaseUrl)) {
        this.iproxy = new _iproxy.default(this.device.udid, this.url.port, WDA_AGENT_PORT);
        await this.iproxy.start();
      } else {
        _logger.default.info(`Skip starting iproxy since Appium will communicate with WDA via '${this.wdaBaseUrl}'`);
      }
    }

    await this.xcodebuild.init(this.noSessionProxy);

    if (this.prebuildWDA) {
      await this.xcodebuild.prebuild();
    }

    return await this.xcodebuild.start();
  }

  async isSourceFresh() {
    for (const subPath of [_utils.CARTHAGE_ROOT, 'Resources', `Resources${_path.default.sep}WebDriverAgent.bundle`]) {
      if (!(await _appiumSupport.fs.exists(_path.default.resolve(this.bootstrapPath, subPath)))) {
        return true;
      }
    }

    return false;
  }

  setupProxies(sessionId) {
    const proxyOpts = {
      server: this.url.hostname,
      port: this.url.port,
      base: '',
      timeout: this.wdaConnectionTimeout
    };
    this.jwproxy = new _appiumBaseDriver.JWProxy(proxyOpts);
    this.jwproxy.sessionId = sessionId;
    this.proxyReqRes = this.jwproxy.proxyReqRes.bind(this.jwproxy);
    this.noSessionProxy = new _noSessionProxy.NoSessionProxy(proxyOpts);
    this.noSessionProxyReqRes = this.noSessionProxy.proxyReqRes.bind(this.noSessionProxy);
  }

  async quit() {
    _logger.default.info('Shutting down sub-processes');

    if (this.iproxy) {
      await this.iproxy.quit();
    }

    await this.xcodebuild.quit();
    await this.xcodebuild.reset();

    if (this.jwproxy) {
      this.jwproxy.sessionId = null;
    }

    this.started = false;

    if (!this.args.webDriverAgentUrl) {
      this.webDriverAgentUrl = null;
    }
  }

  get url() {
    if (!this._url) {
      const port = this.wdaLocalPort || WDA_AGENT_PORT;

      const {
        protocol,
        hostname
      } = _url2.default.parse(this.wdaBaseUrl || WDA_BASE_URL);

      this._url = _url2.default.parse(`${protocol}//${hostname}:${port}`);
    }

    return this._url;
  }

  set url(_url) {
    this._url = _url2.default.parse(_url);
  }

  get fullyStarted() {
    return this.started;
  }

  set fullyStarted(started = false) {
    this.started = started;

    if (this.iproxy) {
      this.iproxy.expectIProxyErrors = !started;
    }
  }

  async retrieveDerivedDataPath() {
    return await this.xcodebuild.retrieveDerivedDataPath();
  }

  async setupCaching(updatedWDABundleId) {
    const status = await this.getStatus();

    if (!status || !status.build) {
      _logger.default.debug('WDA is currently not running. There is nothing to cache');

      return;
    }

    const {
      productBundleIdentifier,
      upgradedAt
    } = status.build;

    if (_appiumSupport.util.hasValue(productBundleIdentifier) && _appiumSupport.util.hasValue(updatedWDABundleId) && updatedWDABundleId !== productBundleIdentifier) {
      _logger.default.info(`Will uninstall running WDA since it has different bundle id. The actual value is '${productBundleIdentifier}'.`);

      return await this.uninstall();
    }

    if (_appiumSupport.util.hasValue(productBundleIdentifier) && !_appiumSupport.util.hasValue(updatedWDABundleId) && _utils.WDA_RUNNER_BUNDLE_ID !== productBundleIdentifier) {
      _logger.default.info(`Will uninstall running WDA since its bundle id is not equal to the default value ${_utils.WDA_RUNNER_BUNDLE_ID}`);

      return await this.uninstall();
    }

    const actualUpgradeTimestamp = await (0, _utils.getWDAUpgradeTimestamp)(this.bootstrapPath);

    _logger.default.debug(`Upgrade timestamp of the currently bundled WDA: ${actualUpgradeTimestamp}`);

    _logger.default.debug(`Upgrade timestamp of the WDA on the device: ${upgradedAt}`);

    if (actualUpgradeTimestamp && upgradedAt && _lodash.default.toLower(`${actualUpgradeTimestamp}`) !== _lodash.default.toLower(`${upgradedAt}`)) {
      _logger.default.info('Will uninstall running WDA since it has different version in comparison to the one ' + `which is bundled with appium-xcuitest-driver module (${actualUpgradeTimestamp} != ${upgradedAt})`);

      return await this.uninstall();
    }

    const message = _appiumSupport.util.hasValue(productBundleIdentifier) ? `Will reuse previously cached WDA instance at '${this.url.href}' with '${productBundleIdentifier}'` : `Will reuse previously cached WDA instance at '${this.url.href}'`;

    _logger.default.info(`${message}. Set the wdaLocalPort capability to a value different from ${this.url.port} if this is an undesired behavior.`);

    this.webDriverAgentUrl = this.url.href;
  }

  async quitAndUninstall() {
    await this.quit();
    await this.uninstall();
  }

}

exports.WebDriverAgent = WebDriverAgent;
var _default = WebDriverAgent;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi93ZGEvd2ViZHJpdmVyYWdlbnQuanMiXSwibmFtZXMiOlsiQk9PVFNUUkFQX1BBVEgiLCJwYXRoIiwicmVzb2x2ZSIsIl9fZGlybmFtZSIsIldEQV9CVU5ETEVfSUQiLCJXREFfTEFVTkNIX1RJTUVPVVQiLCJXREFfQUdFTlRfUE9SVCIsIldEQV9CQVNFX1VSTCIsIlNIQVJFRF9SRVNPVVJDRVNfR1VBUkQiLCJBc3luY0xvY2siLCJXZWJEcml2ZXJBZ2VudCIsImNvbnN0cnVjdG9yIiwieGNvZGVWZXJzaW9uIiwiYXJncyIsIl8iLCJjbG9uZSIsImRldmljZSIsInBsYXRmb3JtVmVyc2lvbiIsInBsYXRmb3JtTmFtZSIsImlvc1Nka1ZlcnNpb24iLCJob3N0IiwicmVhbERldmljZSIsInNldFdEQVBhdGhzIiwiYm9vdHN0cmFwUGF0aCIsImFnZW50UGF0aCIsIndkYUxvY2FsUG9ydCIsIndkYUJhc2VVcmwiLCJwcmVidWlsZFdEQSIsIndlYkRyaXZlckFnZW50VXJsIiwic3RhcnRlZCIsIndkYUNvbm5lY3Rpb25UaW1lb3V0IiwidXNlQ2FydGhhZ2VTc2wiLCJpc0Jvb2xlYW4iLCJ1c2VYY3Rlc3RydW5GaWxlIiwieGNvZGVidWlsZCIsIlhjb2RlQnVpbGQiLCJzaG93WGNvZGVMb2ciLCJ4Y29kZUNvbmZpZ0ZpbGUiLCJ4Y29kZU9yZ0lkIiwieGNvZGVTaWduaW5nSWQiLCJrZXljaGFpblBhdGgiLCJrZXljaGFpblBhc3N3b3JkIiwidXNlU2ltcGxlQnVpbGRUZXN0IiwidXNlUHJlYnVpbHRXREEiLCJ1cGRhdGVkV0RBQnVuZGxlSWQiLCJsYXVuY2hUaW1lb3V0Iiwid2RhTGF1bmNoVGltZW91dCIsIndkYVJlbW90ZVBvcnQiLCJkZXJpdmVkRGF0YVBhdGgiLCJtanBlZ1NlcnZlclBvcnQiLCJsb2ciLCJpbmZvIiwiY2xlYW51cE9ic29sZXRlUHJvY2Vzc2VzIiwicGlkcyIsInVybCIsInBvcnQiLCJjbWRMaW5lIiwiaW5jbHVkZXMiLCJ0b0xvd2VyQ2FzZSIsInVkaWQiLCJsZW5ndGgiLCJkZWJ1ZyIsImUiLCJ3YXJuIiwibWVzc2FnZSIsImlzUnVubmluZyIsImdldFN0YXR1cyIsIm5vU2Vzc2lvblByb3h5IiwiTm9TZXNzaW9uUHJveHkiLCJzZXJ2ZXIiLCJob3N0bmFtZSIsImJhc2UiLCJ0aW1lb3V0IiwiY29tbWFuZCIsImVyciIsImhyZWYiLCJ1bmluc3RhbGwiLCJyZW1vdmVBcHAiLCJKU09OIiwic3RyaW5naWZ5IiwibGF1bmNoIiwic2Vzc2lvbklkIiwic2V0dXBQcm94aWVzIiwiZnMiLCJleGlzdHMiLCJFcnJvciIsInN5bmNocm9uaXphdGlvbktleSIsIm5vcm1hbGl6ZSIsImFjcXVpcmUiLCJkaWRQZXJmb3JtVXBncmFkZSIsImNsZWFuUHJvamVjdCIsImlwcm94eSIsImlQcm94eSIsInN0YXJ0IiwiaW5pdCIsInByZWJ1aWxkIiwiaXNTb3VyY2VGcmVzaCIsInN1YlBhdGgiLCJDQVJUSEFHRV9ST09UIiwic2VwIiwicHJveHlPcHRzIiwiandwcm94eSIsIkpXUHJveHkiLCJwcm94eVJlcVJlcyIsImJpbmQiLCJub1Nlc3Npb25Qcm94eVJlcVJlcyIsInF1aXQiLCJyZXNldCIsIl91cmwiLCJwcm90b2NvbCIsInBhcnNlIiwiZnVsbHlTdGFydGVkIiwiZXhwZWN0SVByb3h5RXJyb3JzIiwicmV0cmlldmVEZXJpdmVkRGF0YVBhdGgiLCJzZXR1cENhY2hpbmciLCJzdGF0dXMiLCJidWlsZCIsInByb2R1Y3RCdW5kbGVJZGVudGlmaWVyIiwidXBncmFkZWRBdCIsInV0aWwiLCJoYXNWYWx1ZSIsIldEQV9SVU5ORVJfQlVORExFX0lEIiwiYWN0dWFsVXBncmFkZVRpbWVzdGFtcCIsInRvTG93ZXIiLCJxdWl0QW5kVW5pbnN0YWxsIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUdBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUdBLE1BQU1BLGNB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YUFBTyxNQUFNLEtBQUsxQyxTQUFMLEVBQWI7QUFDRDs7QUFFRCxVQUFNWixPQUFPLEdBQUd1RCxvQkFBS0MsUUFBTCxDQUFjSCx1QkFBZCxJQUNYLGlEQUFnRCxLQUFLL0QsR0FBTCxDQUFTcUIsSUFBSyxXQUFVMEMsdUJBQXdCLEdBRHJGLEdBRVgsaURBQWdELEtBQUsvRCxHQUFMLENBQVNxQixJQUFLLEdBRm5FOztBQUdBekIsb0JBQUlDLElBQUosQ0FBVSxHQUFFYSxPQUFRLCtEQUE4RCxLQUFLVixHQUFMLENBQVNDLElBQUssb0NBQWhHOztBQUNBLFNBQUszQixpQkFBTCxHQUF5QixLQUFLMEIsR0FBTCxDQUFTcUIsSUFBbEM7QUFDRDs7QUFFRCxRQUFNaUQsZ0JBQU4sR0FBMEI7QUFDeEIsVUFBTSxLQUFLbEIsSUFBTCxFQUFOO0FBQ0EsVUFBTSxLQUFLOUIsU0FBTCxFQUFOO0FBQ0Q7O0FBdlZrQjs7O2VBMFZObEUsYyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB1cmwgZnJvbSAndXJsJztcbmltcG9ydCB7IEpXUHJveHkgfSBmcm9tICdhcHBpdW0tYmFzZS1kcml2ZXInO1xuaW1wb3J0IHsgZnMsIHV0aWwgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgbG9nIGZyb20gJy4uL2xvZ2dlcic7XG5pbXBvcnQgeyBOb1Nlc3Npb25Qcm94eSB9IGZyb20gJy4vbm8tc2Vzc2lvbi1wcm94eSc7XG5pbXBvcnQge1xuICBjaGVja0ZvckRlcGVuZGVuY2llcywgV0RBX1JVTk5FUl9CVU5ETEVfSUQsIGdldFdEQVVwZ3JhZGVUaW1lc3RhbXAsXG4gIENBUlRIQUdFX1JPT1QgfSBmcm9tICcuL3V0aWxzJztcbmltcG9ydCB7IHJlc2V0WENUZXN0UHJvY2Vzc2VzLCBnZXRQSURzTGlzdGVuaW5nT25Qb3J0LCBpc0xvY2FsSG9zdCB9IGZyb20gJy4uL3V0aWxzJztcbmltcG9ydCBYY29kZUJ1aWxkIGZyb20gJy4veGNvZGVidWlsZCc7XG5pbXBvcnQgaVByb3h5IGZyb20gJy4vaXByb3h5JztcbmltcG9ydCB7IGV4ZWMgfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuaW1wb3J0IEFzeW5jTG9jayBmcm9tICdhc3luYy1sb2NrJztcblxuXG5jb25zdCBCT09UU1RSQVBfUEFUSCA9IHBhdGgucmVzb2x2ZShfX2Rpcm5hbWUsICcuLicsICcuLicsICcuLicsICdXZWJEcml2ZXJBZ2VudCcpO1xuY29uc3QgV0RBX0JVTkRMRV9JRCA9ICdjb20uYXBwbGUudGVzdC5XZWJEcml2ZXJBZ2VudFJ1bm5lci1SdW5uZXInO1xuY29uc3QgV0RBX0xBVU5DSF9USU1FT1VUID0gNjAgKiAxMDAwO1xuY29uc3QgV0RBX0FHRU5UX1BPUlQgPSA4MTAwO1xuY29uc3QgV0RBX0JBU0VfVVJMID0gJ2h0dHA6Ly9sb2NhbGhvc3QnO1xuXG5jb25zdCBTSEFSRURfUkVTT1VSQ0VTX0dVQVJEID0gbmV3IEFzeW5jTG9jaygpO1xuXG5cbmNsYXNzIFdlYkRyaXZlckFnZW50IHtcbiAgY29uc3RydWN0b3IgKHhjb2RlVmVyc2lvbiwgYXJncyA9IHt9KSB7XG4gICAgdGhpcy54Y29kZVZlcnNpb24gPSB4Y29kZVZlcnNpb247XG5cbiAgICB0aGlzLmFyZ3MgPSBfLmNsb25lKGFyZ3MpO1xuXG4gICAgdGhpcy5kZXZpY2UgPSBhcmdzLmRldmljZTtcbiAgICB0aGlzLnBsYXRmb3JtVmVyc2lvbiA9IGFyZ3MucGxhdGZvcm1WZXJzaW9uO1xuICAgIHRoaXMucGxhdGZvcm1OYW1lID0gYXJncy5wbGF0Zm9ybU5hbWU7XG4gICAgdGhpcy5pb3NTZGtWZXJzaW9uID0gYXJncy5pb3NTZGtWZXJzaW9uO1xuICAgIHRoaXMuaG9zdCA9IGFyZ3MuaG9zdDtcbiAgICB0aGlzLnJlYWxEZXZpY2UgPSAhIWFyZ3MucmVhbERldmljZTtcblxuICAgIHRoaXMuc2V0V0RBUGF0aHMoYXJncy5ib290c3RyYXBQYXRoLCBhcmdzLmFnZW50UGF0aCk7XG5cbiAgICB0aGlzLndkYUxvY2FsUG9ydCA9IGFyZ3Mud2RhTG9jYWxQb3J0O1xuICAgIHRoaXMud2RhQmFzZVVybCA9IGFyZ3Mud2RhQmFzZVVybCB8fCBXREFfQkFTRV9VUkw7XG5cbiAgICB0aGlzLnByZWJ1aWxkV0RBID0gYXJncy5wcmVidWlsZFdEQTtcblxuICAgIHRoaXMud2ViRHJpdmVyQWdlbnRVcmwgPSBhcmdzLndlYkRyaXZlckFnZW50VXJsO1xuXG4gICAgdGhpcy5zdGFydGVkID0gZmFsc2U7XG5cbiAgICB0aGlzLndkYUNvbm5lY3Rpb25UaW1lb3V0ID0gYXJncy53ZGFDb25uZWN0aW9uVGltZW91dDtcblxuICAgIHRoaXMudXNlQ2FydGhhZ2VTc2wgPSBfLmlzQm9vbGVhbihhcmdzLnVzZUNhcnRoYWdlU3NsKSAmJiBhcmdzLnVzZUNhcnRoYWdlU3NsO1xuXG4gICAgdGhpcy51c2VYY3Rlc3RydW5GaWxlID0gYXJncy51c2VYY3Rlc3RydW5GaWxlO1xuXG4gICAgdGhpcy54Y29kZWJ1aWxkID0gbmV3IFhjb2RlQnVpbGQodGhpcy54Y29kZVZlcnNpb24sIHRoaXMuZGV2aWNlLCB7XG4gICAgICBwbGF0Zm9ybVZlcnNpb246IHRoaXMucGxhdGZvcm1WZXJzaW9uLFxuICAgICAgcGxhdGZvcm1OYW1lOiB0aGlzLnBsYXRmb3JtTmFtZSxcbiAgICAgIGlvc1Nka1ZlcnNpb246IHRoaXMuaW9zU2RrVmVyc2lvbixcbiAgICAgIGFnZW50UGF0aDogdGhpcy5hZ2VudFBhdGgsXG4gICAgICBib290c3RyYXBQYXRoOiB0aGlzLmJvb3RzdHJhcFBhdGgsXG4gICAgICByZWFsRGV2aWNlOiB0aGlzLnJlYWxEZXZpY2UsXG4gICAgICBzaG93WGNvZGVMb2c6IGFyZ3Muc2hvd1hjb2RlTG9nLFxuICAgICAgeGNvZGVDb25maWdGaWxlOiBhcmdzLnhjb2RlQ29uZmlnRmlsZSxcbiAgICAgIHhjb2RlT3JnSWQ6IGFyZ3MueGNvZGVPcmdJZCxcbiAgICAgIHhjb2RlU2lnbmluZ0lkOiBhcmdzLnhjb2RlU2lnbmluZ0lkLFxuICAgICAga2V5Y2hhaW5QYXRoOiBhcmdzLmtleWNoYWluUGF0aCxcbiAgICAgIGtleWNoYWluUGFzc3dvcmQ6IGFyZ3Mua2V5Y2hhaW5QYXNzd29yZCxcbiAgICAgIHVzZVNpbXBsZUJ1aWxkVGVzdDogYXJncy51c2VTaW1wbGVCdWlsZFRlc3QsXG4gICAgICB1c2VQcmVidWlsdFdEQTogYXJncy51c2VQcmVidWlsdFdEQSxcbiAgICAgIHVwZGF0ZWRXREFCdW5kbGVJZDogYXJncy51cGRhdGVkV0RBQnVuZGxlSWQsXG4gICAgICBsYXVuY2hUaW1lb3V0OiBhcmdzLndkYUxhdW5jaFRpbWVvdXQgfHwgV0RBX0xBVU5DSF9USU1FT1VULFxuICAgICAgd2RhUmVtb3RlUG9ydDogdGhpcy5yZWFsRGV2aWNlID8gV0RBX0FHRU5UX1BPUlQgOiAodGhpcy53ZGFMb2NhbFBvcnQgfHwgV0RBX0FHRU5UX1BPUlQpLFxuICAgICAgdXNlWGN0ZXN0cnVuRmlsZTogdGhpcy51c2VYY3Rlc3RydW5GaWxlLFxuICAgICAgZGVyaXZlZERhdGFQYXRoOiBhcmdzLmRlcml2ZWREYXRhUGF0aCxcbiAgICAgIG1qcGVnU2VydmVyUG9ydDogYXJncy5tanBlZ1NlcnZlclBvcnQsXG4gICAgfSk7XG4gIH1cblxuICBzZXRXREFQYXRocyAoYm9vdHN0cmFwUGF0aCwgYWdlbnRQYXRoKSB7XG4gICAgLy8gYWxsb3cgdGhlIHVzZXIgdG8gc3BlY2lmeSBhIHBsYWNlIGZvciBXREEuIFRoaXMgaXMgdW5kb2N1bWVudGVkIGFuZFxuICAgIC8vIG9ubHkgaGVyZSBmb3IgdGhlIHB1cnBvc2VzIG9mIHRlc3RpbmcgZGV2ZWxvcG1lbnQgb2YgV0RBXG4gICAgdGhpcy5ib290c3RyYXBQYXRoID0gYm9vdHN0cmFwUGF0aCB8fCBCT09UU1RSQVBfUEFUSDtcbiAgICBsb2cuaW5mbyhgVXNpbmcgV0RBIHBhdGg6ICcke3RoaXMuYm9vdHN0cmFwUGF0aH0nYCk7XG5cbiAgICAvLyBmb3IgYmFja3dhcmQgY29tcGF0aWJpbGl0eSB3ZSBuZWVkIHRvIGJlIGFibGUgdG8gc3BlY2lmeSBhZ2VudFBhdGggdG9vXG4gICAgdGhpcy5hZ2VudFBhdGggPSBhZ2VudFBhdGggfHwgcGF0aC5yZXNvbHZlKHRoaXMuYm9vdHN0cmFwUGF0aCwgJ1dlYkRyaXZlckFnZW50Lnhjb2RlcHJvaicpO1xuICAgIGxvZy5pbmZvKGBVc2luZyBXREEgYWdlbnQ6ICcke3RoaXMuYWdlbnRQYXRofSdgKTtcbiAgfVxuXG4gIGFzeW5jIGNsZWFudXBPYnNvbGV0ZVByb2Nlc3NlcyAoKSB7XG4gICAgY29uc3QgcGlkcyA9IGF3YWl0IGdldFBJRHNMaXN0ZW5pbmdPblBvcnQodGhpcy51cmwucG9ydCxcbiAgICAgIChjbWRMaW5lKSA9PiAoY21kTGluZS5pbmNsdWRlcygnL1dlYkRyaXZlckFnZW50UnVubmVyJykgfHwgY21kTGluZS5pbmNsdWRlcygnL2lwcm94eScpKSAmJlxuICAgICAgICAhY21kTGluZS50b0xvd2VyQ2FzZSgpLmluY2x1ZGVzKHRoaXMuZGV2aWNlLnVkaWQudG9Mb3dlckNhc2UoKSkpO1xuICAgIGlmICghcGlkcy5sZW5ndGgpIHtcbiAgICAgIGxvZy5kZWJ1ZyhgTm8gb2Jzb2xldGUgY2FjaGVkIHByb2Nlc3NlcyBmcm9tIHByZXZpb3VzIFdEQSBzZXNzaW9ucyBgICtcbiAgICAgICAgICAgICAgICBgbGlzdGVuaW5nIG9uIHBvcnQgJHt0aGlzLnVybC5wb3J0fSBoYXZlIGJlZW4gZm91bmRgKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBsb2cuaW5mbyhgRGV0ZWN0ZWQgJHtwaWRzLmxlbmd0aH0gb2Jzb2xldGUgY2FjaGVkIHByb2Nlc3Mke3BpZHMubGVuZ3RoID09PSAxID8gJycgOiAnZXMnfSBgICtcbiAgICAgICAgICAgICBgZnJvbSBwcmV2aW91cyBXREEgc2Vzc2lvbnMuIENsZWFuaW5nIHVwLi4uYCk7XG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IGV4ZWMoJ2tpbGwnLCBwaWRzKTtcbiAgICB9IGNhdGNoIChlKSB7XG4gICAgICBsb2cud2FybihgRmFpbGVkIHRvIGtpbGwgb2Jzb2xldGUgY2FjaGVkIHByb2Nlc3Mke3BpZHMubGVuZ3RoID09PSAxID8gJycgOiAnZXMnfSAnJHtwaWRzfScuIGAgK1xuICAgICAgICAgICAgICAgYE9yaWdpbmFsIGVycm9yOiAke2UubWVzc2FnZX1gKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJuIGJvb2xlYW4gaWYgV0RBIGlzIHJ1bm5pbmcgb3Igbm90XG4gICAqIEByZXR1cm4ge2Jvb2xlYW59IFRydWUgaWYgV0RBIGlzIHJ1bm5pbmdcbiAgICogQHRocm93cyB7RXJyb3J9IElmIHRoZXJlIHdhcyBpbnZhbGlkIHJlc3BvbnNlIGNvZGUgb3IgYm9keVxuICAgKi9cbiAgYXN5bmMgaXNSdW5uaW5nICgpIHtcbiAgICByZXR1cm4gISEoYXdhaXQgdGhpcy5nZXRTdGF0dXMoKSk7XG4gIH1cblxuICAvKipcbiAgICogUmV0dXJuIGN1cnJlbnQgcnVubmluZyBXREEncyBzdGF0dXMgbGlrZSBiZWxvd1xuICAgKiB7XG4gICAqICAgXCJzdGF0ZVwiOiBcInN1Y2Nlc3NcIixcbiAgICogICBcIm9zXCI6IHtcbiAgICogICAgIFwibmFtZVwiOiBcImlPU1wiLFxuICAgKiAgICAgXCJ2ZXJzaW9uXCI6IFwiMTEuNFwiLFxuICAgKiAgICAgXCJzZGtWZXJzaW9uXCI6IFwiMTEuM1wiXG4gICAqICAgfSxcbiAgICogICBcImlvc1wiOiB7XG4gICAqICAgICBcInNpbXVsYXRvclZlcnNpb25cIjogXCIxMS40XCIsXG4gICAqICAgICBcImlwXCI6IFwiMTcyLjI1NC45OS4zNFwiXG4gICAqICAgfSxcbiAgICogICBcImJ1aWxkXCI6IHtcbiAgICogICAgIFwidGltZVwiOiBcIkp1biAyNCAyMDE4IDE3OjA4OjIxXCIsXG4gICAqICAgICBcInByb2R1Y3RCdW5kbGVJZGVudGlmaWVyXCI6IFwiY29tLmZhY2Vib29rLldlYkRyaXZlckFnZW50UnVubmVyXCJcbiAgICogICB9XG4gICAqIH1cbiAgICpcbiAgICogQHJldHVybiB7P29iamVjdH0gU3RhdGUgT2JqZWN0XG4gICAqIEB0aHJvd3Mge0Vycm9yfSBJZiB0aGVyZSB3YXMgaW52YWxpZCByZXNwb25zZSBjb2RlIG9yIGJvZHlcbiAgICovXG4gIGFzeW5jIGdldFN0YXR1cyAoKSB7XG4gICAgY29uc3Qgbm9TZXNzaW9uUHJveHkgPSBuZXcgTm9TZXNzaW9uUHJveHkoe1xuICAgICAgc2VydmVyOiB0aGlzLnVybC5ob3N0bmFtZSxcbiAgICAgIHBvcnQ6IHRoaXMudXJsLnBvcnQsXG4gICAgICBiYXNlOiAnJyxcbiAgICAgIHRpbWVvdXQ6IDMwMDAsXG4gICAgfSk7XG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiBhd2FpdCBub1Nlc3Npb25Qcm94eS5jb21tYW5kKCcvc3RhdHVzJywgJ0dFVCcpO1xuICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgbG9nLmRlYnVnKGBXREEgaXMgbm90IGxpc3RlbmluZyBhdCAnJHt0aGlzLnVybC5ocmVmfSdgKTtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHVuaW5zdGFsbCAoKSB7XG4gICAgbG9nLmRlYnVnKGBSZW1vdmluZyBXREEgYXBwbGljYXRpb24gZnJvbSBkZXZpY2VgKTtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5kZXZpY2UucmVtb3ZlQXBwKFdEQV9CVU5ETEVfSUQpO1xuICAgIH0gY2F0Y2ggKGUpIHtcbiAgICAgIGxvZy53YXJuKGBXZWJEcml2ZXJBZ2VudCB1bmluc3RhbGwgZmFpbGVkLiBQZXJoYXBzLCBpdCBpcyBhbHJlYWR5IHVuaW5zdGFsbGVkPyBPcmlnaW5hbCBlcnJvcjogJHtKU09OLnN0cmluZ2lmeShlKX1gKTtcbiAgICB9XG4gIH1cblxuXG4gIC8qKlxuICAgKiBSZXR1cm4gY3VycmVudCBydW5uaW5nIFdEQSdzIHN0YXR1cyBsaWtlIGJlbG93IGFmdGVyIGxhdW5jaGluZyBXREFcbiAgICoge1xuICAgKiAgIFwic3RhdGVcIjogXCJzdWNjZXNzXCIsXG4gICAqICAgXCJvc1wiOiB7XG4gICAqICAgICBcIm5hbWVcIjogXCJpT1NcIixcbiAgICogICAgIFwidmVyc2lvblwiOiBcIjExLjRcIixcbiAgICogICAgIFwic2RrVmVyc2lvblwiOiBcIjExLjNcIlxuICAgKiAgIH0sXG4gICAqICAgXCJpb3NcIjoge1xuICAgKiAgICAgXCJzaW11bGF0b3JWZXJzaW9uXCI6IFwiMTEuNFwiLFxuICAgKiAgICAgXCJpcFwiOiBcIjE3Mi4yNTQuOTkuMzRcIlxuICAgKiAgIH0sXG4gICAqICAgXCJidWlsZFwiOiB7XG4gICAqICAgICBcInRpbWVcIjogXCJKdW4gMjQgMjAxOCAxNzowODoyMVwiLFxuICAgKiAgICAgXCJwcm9kdWN0QnVuZGxlSWRlbnRpZmllclwiOiBcImNvbS5mYWNlYm9vay5XZWJEcml2ZXJBZ2VudFJ1bm5lclwiXG4gICAqICAgfVxuICAgKiB9XG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBzZXNzaW9uSWQgTGF1bmNoIFdEQSBhbmQgZXN0YWJsaXNoIHRoZSBzZXNzaW9uIHdpdGggdGhpcyBzZXNzaW9uSWRcbiAgICogQHJldHVybiB7P29iamVjdH0gU3RhdGUgT2JqZWN0XG4gICAqIEB0aHJvd3Mge0Vycm9yfSBJZiB0aGVyZSB3YXMgaW52YWxpZCByZXNwb25zZSBjb2RlIG9yIGJvZHlcbiAgICovXG4gIGFzeW5jIGxhdW5jaCAoc2Vzc2lvbklkKSB7XG4gICAgaWYgKHRoaXMud2ViRHJpdmVyQWdlbnRVcmwpIHtcbiAgICAgIGxvZy5pbmZvKGBVc2luZyBwcm92aWRlZCBXZWJkcml2ZXJBZ2VudCBhdCAnJHt0aGlzLndlYkRyaXZlckFnZW50VXJsfSdgKTtcbiAgICAgIHRoaXMudXJsID0gdGhpcy53ZWJEcml2ZXJBZ2VudFVybDtcbiAgICAgIHRoaXMuc2V0dXBQcm94aWVzKHNlc3Npb25JZCk7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy5nZXRTdGF0dXMoKTtcbiAgICB9XG5cbiAgICBsb2cuaW5mbygnTGF1bmNoaW5nIFdlYkRyaXZlckFnZW50IG9uIHRoZSBkZXZpY2UnKTtcblxuICAgIHRoaXMuc2V0dXBQcm94aWVzKHNlc3Npb25JZCk7XG5cbiAgICBpZiAoIXRoaXMudXNlWGN0ZXN0cnVuRmlsZSAmJiAhYXdhaXQgZnMuZXhpc3RzKHRoaXMuYWdlbnRQYXRoKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBUcnlpbmcgdG8gdXNlIFdlYkRyaXZlckFnZW50IHByb2plY3QgYXQgJyR7dGhpcy5hZ2VudFBhdGh9JyBidXQgdGhlIGAgK1xuICAgICAgICAgICAgICAgICAgICAgICdmaWxlIGRvZXMgbm90IGV4aXN0Jyk7XG4gICAgfVxuXG4gICAgaWYgKCF0aGlzLnVzZVhjdGVzdHJ1bkZpbGUpIHtcbiAgICAgIC8vIG1ha2Ugc3VyZSB0aGF0IHRoZSBXREEgZGVwZW5kZW5jaWVzIGhhdmUgYmVlbiBidWlsdFxuICAgICAgY29uc3Qgc3luY2hyb25pemF0aW9uS2V5ID0gcGF0aC5ub3JtYWxpemUodGhpcy5ib290c3RyYXBQYXRoKTtcbiAgICAgIGF3YWl0IFNIQVJFRF9SRVNPVVJDRVNfR1VBUkQuYWNxdWlyZShzeW5jaHJvbml6YXRpb25LZXksIGFzeW5jICgpID0+IHtcbiAgICAgICAgY29uc3QgZGlkUGVyZm9ybVVwZ3JhZGUgPSBhd2FpdCBjaGVja0ZvckRlcGVuZGVuY2llcyh0aGlzLmJvb3RzdHJhcFBhdGgsIHRoaXMudXNlQ2FydGhhZ2VTc2wpO1xuICAgICAgICBpZiAoZGlkUGVyZm9ybVVwZ3JhZGUpIHtcbiAgICAgICAgICAvLyBPbmx5IHBlcmZvcm0gdGhlIGNsZWFudXAgYWZ0ZXIgV0RBIHVwZ3JhZGVcbiAgICAgICAgICBhd2FpdCB0aGlzLnhjb2RlYnVpbGQuY2xlYW5Qcm9qZWN0KCk7XG4gICAgICAgIH1cbiAgICAgIH0pO1xuICAgIH1cbiAgICAvLyBXZSBuZWVkIHRvIHByb3ZpZGUgV0RBIGxvY2FsIHBvcnQsIGJlY2F1c2UgaXQgbWlnaHQgYmUgb2NjdXBpZWQgd2l0aFxuICAgIC8vIGlwcm94eSBpbnN0YW5jZSBpbml0aWF0ZWQgYnkgc29tZSBwcmVjZWVkaW5nIHJ1biB3aXRoIGEgcmVhbCBkZXZpY2VcbiAgICAvLyAoaXByb3h5IGluc3RhbmNlcyBhcmUgbm90IGtpbGxlZCBvbiBzZXNzaW9uIHRlcm1pbmF0aW9uIGJ5IGRlZmF1bHQpXG4gICAgYXdhaXQgcmVzZXRYQ1Rlc3RQcm9jZXNzZXModGhpcy5kZXZpY2UudWRpZCwgIXRoaXMucmVhbERldmljZSwge3dkYUxvY2FsUG9ydDogdGhpcy51cmwucG9ydH0pO1xuXG4gICAgaWYgKHRoaXMucmVhbERldmljZSkge1xuICAgICAgaWYgKGlzTG9jYWxIb3N0KHRoaXMud2RhQmFzZVVybCkpIHtcbiAgICAgICAgdGhpcy5pcHJveHkgPSBuZXcgaVByb3h5KHRoaXMuZGV2aWNlLnVkaWQsIHRoaXMudXJsLnBvcnQsIFdEQV9BR0VOVF9QT1JUKTtcbiAgICAgICAgYXdhaXQgdGhpcy5pcHJveHkuc3RhcnQoKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGxvZy5pbmZvKGBTa2lwIHN0YXJ0aW5nIGlwcm94eSBzaW5jZSBBcHBpdW0gd2lsbCBjb21tdW5pY2F0ZSB3aXRoIFdEQSB2aWEgJyR7dGhpcy53ZGFCYXNlVXJsfSdgKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBhd2FpdCB0aGlzLnhjb2RlYnVpbGQuaW5pdCh0aGlzLm5vU2Vzc2lvblByb3h5KTtcblxuICAgIC8vIFN0YXJ0IHRoZSB4Y29kZWJ1aWxkIHByb2Nlc3NcbiAgICBpZiAodGhpcy5wcmVidWlsZFdEQSkge1xuICAgICAgYXdhaXQgdGhpcy54Y29kZWJ1aWxkLnByZWJ1aWxkKCk7XG4gICAgfVxuICAgIHJldHVybiBhd2FpdCB0aGlzLnhjb2RlYnVpbGQuc3RhcnQoKTtcbiAgfVxuXG4gIGFzeW5jIGlzU291cmNlRnJlc2ggKCkge1xuICAgIGZvciAoY29uc3Qgc3ViUGF0aCBvZiBbXG4gICAgICBDQVJUSEFHRV9ST09ULFxuICAgICAgJ1Jlc291cmNlcycsXG4gICAgICBgUmVzb3VyY2VzJHtwYXRoLnNlcH1XZWJEcml2ZXJBZ2VudC5idW5kbGVgLFxuICAgIF0pIHtcbiAgICAgIGlmICghYXdhaXQgZnMuZXhpc3RzKHBhdGgucmVzb2x2ZSh0aGlzLmJvb3RzdHJhcFBhdGgsIHN1YlBhdGgpKSkge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH1cbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG5cbiAgc2V0dXBQcm94aWVzIChzZXNzaW9uSWQpIHtcbiAgICBjb25zdCBwcm94eU9wdHMgPSB7XG4gICAgICBzZXJ2ZXI6IHRoaXMudXJsLmhvc3RuYW1lLFxuICAgICAgcG9ydDogdGhpcy51cmwucG9ydCxcbiAgICAgIGJhc2U6ICcnLFxuICAgICAgdGltZW91dDogdGhpcy53ZGFDb25uZWN0aW9uVGltZW91dCxcbiAgICB9O1xuXG4gICAgdGhpcy5qd3Byb3h5ID0gbmV3IEpXUHJveHkocHJveHlPcHRzKTtcbiAgICB0aGlzLmp3cHJveHkuc2Vzc2lvbklkID0gc2Vzc2lvbklkO1xuICAgIHRoaXMucHJveHlSZXFSZXMgPSB0aGlzLmp3cHJveHkucHJveHlSZXFSZXMuYmluZCh0aGlzLmp3cHJveHkpO1xuXG4gICAgdGhpcy5ub1Nlc3Npb25Qcm94eSA9IG5ldyBOb1Nlc3Npb25Qcm94eShwcm94eU9wdHMpO1xuICAgIHRoaXMubm9TZXNzaW9uUHJveHlSZXFSZXMgPSB0aGlzLm5vU2Vzc2lvblByb3h5LnByb3h5UmVxUmVzLmJpbmQodGhpcy5ub1Nlc3Npb25Qcm94eSk7XG4gIH1cblxuICBhc3luYyBxdWl0ICgpIHtcbiAgICBsb2cuaW5mbygnU2h1dHRpbmcgZG93biBzdWItcHJvY2Vzc2VzJyk7XG5cbiAgICBpZiAodGhpcy5pcHJveHkpIHtcbiAgICAgIGF3YWl0IHRoaXMuaXByb3h5LnF1aXQoKTtcbiAgICB9XG5cbiAgICBhd2FpdCB0aGlzLnhjb2RlYnVpbGQucXVpdCgpO1xuICAgIGF3YWl0IHRoaXMueGNvZGVidWlsZC5yZXNldCgpO1xuXG4gICAgaWYgKHRoaXMuandwcm94eSkge1xuICAgICAgdGhpcy5qd3Byb3h5LnNlc3Npb25JZCA9IG51bGw7XG4gICAgfVxuXG4gICAgdGhpcy5zdGFydGVkID0gZmFsc2U7XG5cbiAgICBpZiAoIXRoaXMuYXJncy53ZWJEcml2ZXJBZ2VudFVybCkge1xuICAgICAgLy8gaWYgd2UgcG9wdWxhdGVkIHRoZSB1cmwgb3Vyc2VsdmVzIChkdXJpbmcgYHNldHVwQ2FjaGluZ2AgY2FsbCwgZm9yIGluc3RhbmNlKVxuICAgICAgLy8gdGhlbiBjbGVhbiB0aGF0IHVwLiBJZiB0aGUgdXJsIHdhcyBzdXBwbGllZCwgd2Ugd2FudCB0byBrZWVwIGl0XG4gICAgICB0aGlzLndlYkRyaXZlckFnZW50VXJsID0gbnVsbDtcbiAgICB9XG4gIH1cblxuICBnZXQgdXJsICgpIHtcbiAgICBpZiAoIXRoaXMuX3VybCkge1xuICAgICAgY29uc3QgcG9ydCA9IHRoaXMud2RhTG9jYWxQb3J0IHx8IFdEQV9BR0VOVF9QT1JUO1xuICAgICAgY29uc3Qge3Byb3RvY29sLCBob3N0bmFtZX0gPSB1cmwucGFyc2UodGhpcy53ZGFCYXNlVXJsIHx8IFdEQV9CQVNFX1VSTCk7XG4gICAgICB0aGlzLl91cmwgPSB1cmwucGFyc2UoYCR7cHJvdG9jb2x9Ly8ke2hvc3RuYW1lfToke3BvcnR9YCk7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLl91cmw7XG4gIH1cblxuICBzZXQgdXJsIChfdXJsKSB7XG4gICAgdGhpcy5fdXJsID0gdXJsLnBhcnNlKF91cmwpO1xuICB9XG5cbiAgZ2V0IGZ1bGx5U3RhcnRlZCAoKSB7XG4gICAgcmV0dXJuIHRoaXMuc3RhcnRlZDtcbiAgfVxuXG4gIHNldCBmdWxseVN0YXJ0ZWQgKHN0YXJ0ZWQgPSBmYWxzZSkge1xuICAgIC8vIGJlZm9yZSBXREEgaXMgc3RhcnRlZCB3ZSBleHBlY3QgZXJyb3JzIGZyb20gaXByb3h5LCBzaW5jZSBpdCBpcyBub3RcbiAgICAvLyBjb21tdW5pY2F0aW5nIHdpdGggYW55dGhpbmcgeWV0XG4gICAgdGhpcy5zdGFydGVkID0gc3RhcnRlZDtcbiAgICBpZiAodGhpcy5pcHJveHkpIHtcbiAgICAgIHRoaXMuaXByb3h5LmV4cGVjdElQcm94eUVycm9ycyA9ICFzdGFydGVkO1xuICAgIH1cbiAgfVxuXG4gIGFzeW5jIHJldHJpZXZlRGVyaXZlZERhdGFQYXRoICgpIHtcbiAgICByZXR1cm4gYXdhaXQgdGhpcy54Y29kZWJ1aWxkLnJldHJpZXZlRGVyaXZlZERhdGFQYXRoKCk7XG4gIH1cblxuICAvKipcbiAgICogUmV1c2UgcnVubmluZyBXREEgaWYgaXQgaGFzIHRoZSBzYW1lIGJ1bmRsZSBpZCB3aXRoIHVwZGF0ZWRXREFCdW5kbGVJZC5cbiAgICogT3IgcmV1c2UgaXQgaWYgaXQgaGFzIHRoZSBkZWZhdWx0IGlkIHdpdGhvdXQgdXBkYXRlZFdEQUJ1bmRsZUlkLlxuICAgKiBVbmluc3RhbGwgaXQgaWYgdGhlIG1ldGhvZCBmYWNlcyBhbiBleGNlcHRpb24gZm9yIHRoZSBhYm92ZSBzaXR1YXRpb24uXG4gICAqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSB1cGRhdGVkV0RBQnVuZGxlSWQgQnVuZGxlSWQgeW91J2QgbGlrZSB0byB1c2VcbiAgICovXG4gIGFzeW5jIHNldHVwQ2FjaGluZyAodXBkYXRlZFdEQUJ1bmRsZUlkKSB7XG4gICAgY29uc3Qgc3RhdHVzID0gYXdhaXQgdGhpcy5nZXRTdGF0dXMoKTtcbiAgICBpZiAoIXN0YXR1cyB8fCAhc3RhdHVzLmJ1aWxkKSB7XG4gICAgICBsb2cuZGVidWcoJ1dEQSBpcyBjdXJyZW50bHkgbm90IHJ1bm5pbmcuIFRoZXJlIGlzIG5vdGhpbmcgdG8gY2FjaGUnKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICBjb25zdCB7XG4gICAgICBwcm9kdWN0QnVuZGxlSWRlbnRpZmllcixcbiAgICAgIHVwZ3JhZGVkQXQsXG4gICAgfSA9IHN0YXR1cy5idWlsZDtcbiAgICBpZiAodXRpbC5oYXNWYWx1ZShwcm9kdWN0QnVuZGxlSWRlbnRpZmllcikgJiYgdXRpbC5oYXNWYWx1ZSh1cGRhdGVkV0RBQnVuZGxlSWQpICYmIHVwZGF0ZWRXREFCdW5kbGVJZCAhPT0gcHJvZHVjdEJ1bmRsZUlkZW50aWZpZXIpIHtcbiAgICAgIGxvZy5pbmZvKGBXaWxsIHVuaW5zdGFsbCBydW5uaW5nIFdEQSBzaW5jZSBpdCBoYXMgZGlmZmVyZW50IGJ1bmRsZSBpZC4gVGhlIGFjdHVhbCB2YWx1ZSBpcyAnJHtwcm9kdWN0QnVuZGxlSWRlbnRpZmllcn0nLmApO1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMudW5pbnN0YWxsKCk7XG4gICAgfVxuICAgIGlmICh1dGlsLmhhc1ZhbHVlKHByb2R1Y3RCdW5kbGVJZGVudGlmaWVyKSAmJiAhdXRpbC5oYXNWYWx1ZSh1cGRhdGVkV0RBQnVuZGxlSWQpICYmIFdEQV9SVU5ORVJfQlVORExFX0lEICE9PSBwcm9kdWN0QnVuZGxlSWRlbnRpZmllcikge1xuICAgICAgbG9nLmluZm8oYFdpbGwgdW5pbnN0YWxsIHJ1bm5pbmcgV0RBIHNpbmNlIGl0cyBidW5kbGUgaWQgaXMgbm90IGVxdWFsIHRvIHRoZSBkZWZhdWx0IHZhbHVlICR7V0RBX1JVTk5FUl9CVU5ETEVfSUR9YCk7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy51bmluc3RhbGwoKTtcbiAgICB9XG5cbiAgICBjb25zdCBhY3R1YWxVcGdyYWRlVGltZXN0YW1wID0gYXdhaXQgZ2V0V0RBVXBncmFkZVRpbWVzdGFtcCh0aGlzLmJvb3RzdHJhcFBhdGgpO1xuICAgIGxvZy5kZWJ1ZyhgVXBncmFkZSB0aW1lc3RhbXAgb2YgdGhlIGN1cnJlbnRseSBidW5kbGVkIFdEQTogJHthY3R1YWxVcGdyYWRlVGltZXN0YW1wfWApO1xuICAgIGxvZy5kZWJ1ZyhgVXBncmFkZSB0aW1lc3RhbXAgb2YgdGhlIFdEQSBvbiB0aGUgZGV2aWNlOiAke3VwZ3JhZGVkQXR9YCk7XG4gICAgaWYgKGFjdHVhbFVwZ3JhZGVUaW1lc3RhbXAgJiYgdXBncmFkZWRBdCAmJiBfLnRvTG93ZXIoYCR7YWN0dWFsVXBncmFkZVRpbWVzdGFtcH1gKSAhPT0gXy50b0xvd2VyKGAke3VwZ3JhZGVkQXR9YCkpIHtcbiAgICAgIGxvZy5pbmZvKCdXaWxsIHVuaW5zdGFsbCBydW5uaW5nIFdEQSBzaW5jZSBpdCBoYXMgZGlmZmVyZW50IHZlcnNpb24gaW4gY29tcGFyaXNvbiB0byB0aGUgb25lICcgK1xuICAgICAgICBgd2hpY2ggaXMgYnVuZGxlZCB3aXRoIGFwcGl1bS14Y3VpdGVzdC1kcml2ZXIgbW9kdWxlICgke2FjdHVhbFVwZ3JhZGVUaW1lc3RhbXB9ICE9ICR7dXBncmFkZWRBdH0pYCk7XG4gICAgICByZXR1cm4gYXdhaXQgdGhpcy51bmluc3RhbGwoKTtcbiAgICB9XG5cbiAgICBjb25zdCBtZXNzYWdlID0gdXRpbC5oYXNWYWx1ZShwcm9kdWN0QnVuZGxlSWRlbnRpZmllcilcbiAgICAgID8gYFdpbGwgcmV1c2UgcHJldmlvdXNseSBjYWNoZWQgV0RBIGluc3RhbmNlIGF0ICcke3RoaXMudXJsLmhyZWZ9JyB3aXRoICcke3Byb2R1Y3RCdW5kbGVJZGVudGlmaWVyfSdgXG4gICAgICA6IGBXaWxsIHJldXNlIHByZXZpb3VzbHkgY2FjaGVkIFdEQSBpbnN0YW5jZSBhdCAnJHt0aGlzLnVybC5ocmVmfSdgO1xuICAgIGxvZy5pbmZvKGAke21lc3NhZ2V9LiBTZXQgdGhlIHdkYUxvY2FsUG9ydCBjYXBhYmlsaXR5IHRvIGEgdmFsdWUgZGlmZmVyZW50IGZyb20gJHt0aGlzLnVybC5wb3J0fSBpZiB0aGlzIGlzIGFuIHVuZGVzaXJlZCBiZWhhdmlvci5gKTtcbiAgICB0aGlzLndlYkRyaXZlckFnZW50VXJsID0gdGhpcy51cmwuaHJlZjtcbiAgfVxuXG4gIGFzeW5jIHF1aXRBbmRVbmluc3RhbGwgKCkge1xuICAgIGF3YWl0IHRoaXMucXVpdCgpO1xuICAgIGF3YWl0IHRoaXMudW5pbnN0YWxsKCk7XG4gIH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgV2ViRHJpdmVyQWdlbnQ7XG5leHBvcnQgeyBXZWJEcml2ZXJBZ2VudCwgV0RBX0JVTkRMRV9JRCwgQk9PVFNUUkFQX1BBVEgsIFdEQV9CQVNFX1VSTCB9O1xuIl0sImZpbGUiOiJsaWIvd2RhL3dlYmRyaXZlcmFnZW50LmpzIiwic291cmNlUm9vdCI6Ii4uLy4uLy4uIn0=
