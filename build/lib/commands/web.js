"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

require("source-map-support/register");

var _appiumIosDriver = require("appium-ios-driver");

var _asyncbox = require("asyncbox");

var _appiumSupport = require("appium-support");

var _logger = _interopRequireDefault(require("../logger"));

var _lodash = _interopRequireDefault(require("lodash"));

var _bluebird = _interopRequireDefault(require("bluebird"));

const IPHONE_EXTRA_WEB_COORD_SCROLL_OFFSET = -15;
const IPHONE_EXTRA_WEB_COORD_NON_SCROLL_OFFSET = 10;
const IPHONE_WEB_COORD_OFFSET = -10;
const IPHONE_WEB_COORD_SMART_APP_BANNER_OFFSET = 84;
const IPHONE_X_EXTRA_WEB_COORD_SCROLL_OFFSET = -90;
const IPHONE_X_EXTRA_WEB_COORD_NON_SCROLL_OFFSET = -10;
const IPHONE_X_WEB_COORD_OFFSET = 40;
const IPAD_EXTRA_WEB_COORD_SCROLL_OFFSET = -10;
const IPAD_EXTRA_WEB_COORD_NON_SCROLL_OFFSET = 0;
const IPAD_WEB_COORD_OFFSET = 10;
const IPAD_WEB_COORD_SMART_APP_BANNER_OFFSET = 95;
const IPHONE_X_WIDTH = 375;
const IPHONE_X_HEIGHT = 812;
const ATOM_WAIT_TIMEOUT = 5 * 60000;
let extensions = {};
Object.assign(extensions, _appiumIosDriver.iosCommands.web);

extensions.getSafariIsIphone = async function getSafariIsIphone() {
  try {
    const userAgent = await this.execute('return navigator.userAgent');
    return userAgent.toLowerCase().includes('iphone');
  } catch (err) {
    _logger.default.warn(`Unable to find device type from useragent. Assuming iPhone`);

    _logger.default.debug(`Error: ${err.message}`);
  }

  return true;
};

extensions.getSafariIsIphoneX = async function getSafariIsIphone() {
  try {
    const script = 'return {height: window.screen.availHeight, width: window.screen.availWidth};';
    const {
      height,
      width
    } = await this.execute(script);
    return height === IPHONE_X_HEIGHT && width === IPHONE_X_WIDTH || height === IPHONE_X_WIDTH && width === IPHONE_X_HEIGHT;
  } catch (err) {
    _logger.default.warn(`Unable to find device type from useragent. Assuming not iPhone X`);

    _logger.default.debug(`Error: ${err.message}`);
  }

  return false;
};

const getElementHeightMemoized = _lodash.default.memoize(async function getElementHeightMemoized(key, driver, el) {
  el = _appiumSupport.util.unwrapElement(el);
  return (await driver.getNativeRect(el)).height;
});

extensions.getExtraTranslateWebCoordsOffset = async function getExtraTranslateWebCoordsOffset(coords, webviewRect) {
  let offset = 0;
  const implicitWaitMs = this.implicitWaitMs;
  const isIphone = await this.getSafariIsIphone();
  const isIphoneX = isIphone && (await this.getSafariIsIphoneX());

  try {
    this.setImplicitWait(0);
    await this.findNativeElementOrElements('accessibility id', 'ReloadButton', false);

    if (isIphoneX) {
      offset += IPHONE_X_EXTRA_WEB_COORD_NON_SCROLL_OFFSET;
    } else if (isIphone) {
      offset += IPHONE_EXTRA_WEB_COORD_NON_SCROLL_OFFSET;
    } else {
      offset += IPAD_EXTRA_WEB_COORD_NON_SCROLL_OFFSET;
    }
  } catch (err) {
    try {
      const el = await this.findNativeElementOrElements('accessibility id', 'URL', false);
      offset -= await getElementHeightMemoized('URLBar', this, el);
    } catch (ign) {}
  } finally {
    this.setImplicitWait(implicitWaitMs);
  }

  if (coords.y > webviewRect.height) {
    if (isIphoneX) {
      offset += IPHONE_X_EXTRA_WEB_COORD_SCROLL_OFFSET;
    } else if (isIphone) {
      offset += IPHONE_EXTRA_WEB_COORD_SCROLL_OFFSET;
    } else {
      offset += IPAD_EXTRA_WEB_COORD_SCROLL_OFFSET;
    }
  }

  offset += isIphone ? IPHONE_WEB_COORD_OFFSET : IPAD_WEB_COORD_OFFSET;
  offset += isIphoneX ? IPHONE_X_WEB_COORD_OFFSET : 0;

  _logger.default.debug(`Extra translated web coordinates offset: ${offset}`);

  return offset;
};

extensions.getExtraNativeWebTapOffset = async function getExtraNativeWebTapOffset() {
  let offset = 0;
  const implicitWaitMs = this.implicitWaitMs;

  try {
    this.setImplicitWait(0);

    try {
      const el = await this.findNativeElementOrElements('-ios predicate string', `name LIKE '*, Tab' AND visible = 1`, false);
      offset += await getElementHeightMemoized('TabBar', this, el);
    } catch (ign) {}

    try {
      await this.findNativeElementOrElements('accessibility id', 'Close app download offer', false);
      offset += (await this.getSafariIsIphone()) ? IPHONE_WEB_COORD_SMART_APP_BANNER_OFFSET : IPAD_WEB_COORD_SMART_APP_BANNER_OFFSET;
    } catch (ign) {}
  } finally {
    this.setImplicitWait(implicitWaitMs);
  }

  _logger.default.debug(`Additional native web tap offset computed: ${offset}`);

  return offset;
};

async function tapWebElementNatively(driver, atomsElement) {
  try {
    let text = await driver.executeAtom('get_text', [atomsElement]);

    if (!text) {
      text = await driver.executeAtom('get_attribute_value', [atomsElement, 'value']);
    }

    if (text) {
      const el = await driver.findNativeElementOrElements('accessibility id', text, false);
      const rect = await driver.proxyCommand(`/element/${el.ELEMENT}/rect`, 'GET');
      const coords = {
        x: Math.round(rect.x + rect.width / 2),
        y: Math.round(rect.y + rect.height / 2)
      };
      await driver.clickCoords(coords);
      return true;
    }
  } catch (err) {
    _logger.default.warn(`Error attempting to click: ${err.message}`);
  }

  return false;
}

extensions.nativeWebTap = async function nativeWebTap(el) {
  const atomsElement = this.useAtomsElement(el);

  if (await tapWebElementNatively(this, atomsElement)) {
    return;
  }

  _logger.default.warn('Unable to do simple native web tap. Attempting to convert coordinates');

  await this.executeAtom('get_size', [atomsElement]);
  await this.executeAtom('get_top_left_coordinates', [atomsElement]);
  const {
    width,
    height
  } = await this.executeAtom('get_size', [atomsElement]);
  let {
    x,
    y
  } = await this.executeAtom('get_top_left_coordinates', [atomsElement]);
  x += width / 2;
  y += height / 2;
  this.curWebCoords = {
    x,
    y
  };
  await this.clickWebCoords();
};

extensions.clickCoords = async function clickCoords(coords) {
  await this.performTouch([{
    action: 'tap',
    options: coords
  }]);
};

extensions.translateWebCoords = async function translateWebCoords(coords) {
  _logger.default.debug(`Translating coordinates (${JSON.stringify(coords)}) to web coordinates`);

  const implicitWaitMs = this.implicitWaitMs;
  let webview;

  try {
    this.setImplicitWait(0);
    webview = await (0, _asyncbox.retryInterval)(5, 100, async () => {
      return await this.findNativeElementOrElements('-ios predicate string', `type = 'XCUIElementTypeWebView' AND visible = 1`, false);
    });
  } finally {
    this.setImplicitWait(implicitWaitMs);
  }

  webview = _appiumSupport.util.unwrapElement(webview);
  const rect = await this.proxyCommand(`/element/${webview}/rect`, 'GET');
  const wvPos = {
    x: rect.x,
    y: rect.y
  };
  const realDims = {
    w: rect.width,
    h: rect.height
  };
  const cmd = '(function () { return {w: document.documentElement.clientWidth, h: document.documentElement.clientHeight}; })()';
  const wvDims = await this.remote.execute(cmd);
  const urlBarHeight = 64;
  wvPos.y += urlBarHeight;
  const realDimensionHeight = 108;
  realDims.h -= realDimensionHeight;
  let yOffset = this.opts.curOrientation === 'LANDSCAPE' ? this.landscapeWebCoordsOffset : 0;
  yOffset += await this.getExtraNativeWebTapOffset();
  coords.y += await this.getExtraTranslateWebCoordsOffset(coords, rect);

  if (wvDims && realDims && wvPos) {
    let xRatio = realDims.w / wvDims.w;
    let yRatio = realDims.h / wvDims.h;
    let newCoords = {
      x: wvPos.x + Math.round(xRatio * coords.x),
      y: wvPos.y + yOffset + Math.round(yRatio * coords.y)
    };

    _logger.default.debug(`Converted coordinates: ${JSON.stringify(newCoords)}`);

    _logger.default.debug(`    rect: ${JSON.stringify(rect)}`);

    _logger.default.debug(`    wvPos: ${JSON.stringify(wvPos)}`);

    _logger.default.debug(`    realDims: ${JSON.stringify(realDims)}`);

    _logger.default.debug(`    wvDims: ${JSON.stringify(wvDims)}`);

    _logger.default.debug(`    xRatio: ${JSON.stringify(xRatio)}`);

    _logger.default.debug(`    yRatio: ${JSON.stringify(yRatio)}`);

    _logger.default.debug(`    yOffset: ${JSON.stringify(yOffset)}`);

    _logger.default.debug(`Converted web coords ${JSON.stringify(coords)} ` + `into real coords ${JSON.stringify(newCoords)}`);

    return newCoords;
  }
};

extensions.checkForAlert = async function checkForAlert() {
  return false;
};

extensions.waitForAtom = async function waitForAtom(promise) {
  const started = process.hrtime();

  try {
    return this.parseExecuteResponse((await _bluebird.default.resolve(promise).timeout(ATOM_WAIT_TIMEOUT)));
  } catch (err) {
    if (err instanceof _bluebird.default.TimeoutError) {
      throw new Error(`Did not get any response after ${process.hrtime(started)[0]}s`);
    }

    throw err;
  }
};

var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy93ZWIuanMiXSwibmFtZXMiOlsiSVBIT05FX0VYVFJBX1dFQl9DT09SRF9TQ1JPTExfT0ZGU0VUIiwiSVBIT05FX0VYVFJBX1dFQl9DT09SRF9OT05fU0NST0xMX09GRlNFVCIsIklQSE9ORV9XRUJfQ09PUkRfT0ZGU0VUIiwiSVBIT05FX1dFQl9DT09SRF9TTUFSVF9BUFBfQkFOTkVSX09GRlNFVCIsIklQSE9ORV9YX0VYVFJBX1dFQl9DT09SRF9TQ1JPTExfT0ZGU0VUIiwiSVBIT05FX1hfRVhUUkFfV0VCX0NPT1JEX05PTl9TQ1JPTExfT0ZGU0VUIiwiSVBIT05FX1hfV0VCX0NPT1JEX09GRlNFVCIsIklQQURfRVhUUkFfV0VCX0NPT1JEX1NDUk9MTF9PRkZTRVQiLCJJUEFEX0VYVFJBX1dFQl9DT09SRF9OT05fU0NST0xMX09GRlNFVCIsIklQQURfV0VCX0NPT1JEX09GRlNFVCIsIklQQURfV0VCX0NPT1JEX1NNQVJUX0FQUF9CQU5ORVJfT0ZGU0VUIiwiSVBIT05FX1hfV0lEVEgiLCJJUEhPTkVfWF9IRUlHSFQiLCJBVE9NX1dBSVRfVElNRU9VVCIsImV4dGVuc2lvbnMiLCJPYmplY3QiLCJhc3NpZ24iLCJpb3NDb21tYW5kcyIsIndlYiIsImdldFNhZmFyaUlzSXBob25lIiwidXNlckFnZW50IiwiZXhlY3V0ZSIsInRvTG93ZXJDYXNlIiwiaW5jbHVkZXMiLCJlcnIiLCJsb2ciLCJ3YXJuIiwiZGVidWciLCJtZXNzYWdlIiwiZ2V0U2FmYXJpSXNJcGhvbmVYIiwic2NyaXB0IiwiaGVpZ2h0Iiwid2lkdGgiLCJnZXRFbGVtZW50SGVpZ2h0TWVtb2l6ZWQiLCJfIiwibWVtb2l6ZSIsImtleSIsImRyaXZlciIsImVsIiwidXRpbCIsInVud3JhcEVsZW1lbnQiLCJnZXROYXRpdmVSZWN0IiwiZ2V0RXh0cmFUcmFuc2xhdGVXZWJDb29yZHNPZmZzZXQiLCJjb29yZHMiLCJ3ZWJ2aWV3UmVjdCIsIm9mZnNldCIsImltcGxpY2l0V2FpdE1zIiwiaXNJcGhvbmUiLCJpc0lwaG9uZVgiLCJzZXRJbXBsaWNpdFdhaXQiLCJmaW5kTmF0aXZlRWxlbWVudE9yRWxlbWVudHMiLCJpZ24iLCJ5IiwiZ2V0RXh0cmFOYXRpdmVXZWJUYXBPZmZzZXQiLCJ0YXBXZWJFbGVtZW50TmF0aXZlbHkiLCJhdG9tc0VsZW1lbnQiLCJ0ZXh0IiwiZXhlY3V0ZUF0b20iLCJyZWN0IiwicHJveHlDb21tYW5kIiwiRUxFTUVOVCIsIngiLCJNYXRoIiwicm91bmQiLCJjbGlja0Nvb3JkcyIsIm5hdGl2ZVdlYlRhcCIsInVzZUF0b21zRWxlbWVudCIsImN1cldlYkNvb3JkcyIsImNsaWNrV2ViQ29vcmRzIiwicGVyZm9ybVRvdWNoIiwiYWN0aW9uIiwib3B0aW9ucyIsInRyYW5zbGF0ZVdlYkNvb3JkcyIsIkpTT04iLCJzdHJpbmdpZnkiLCJ3ZWJ2aWV3Iiwid3ZQb3MiLCJyZWFsRGltcyIsInciLCJoIiwiY21kIiwid3ZEaW1zIiwicmVtb3RlIiwidXJsQmFySGVpZ2h0IiwicmVhbERpbWVuc2lvbkhlaWdodCIsInlPZmZzZXQiLCJvcHRzIiwiY3VyT3JpZW50YXRpb24iLCJsYW5kc2NhcGVXZWJDb29yZHNPZmZzZXQiLCJ4UmF0aW8iLCJ5UmF0aW8iLCJuZXdDb29yZHMiLCJjaGVja0ZvckFsZXJ0Iiwid2FpdEZvckF0b20iLCJwcm9taXNlIiwic3RhcnRlZCIsInByb2Nlc3MiLCJocnRpbWUiLCJwYXJzZUV4ZWN1dGVSZXNwb25zZSIsIkIiLCJyZXNvbHZlIiwidGltZW91dCIsIlRpbWVvdXRFcnJvciIsIkVycm9yIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUNBOztBQUdBLE1BQU1BLG9DQUFvQyxHQUFHLENBQUMsRUFBOUM7QUFDQSxNQUFNQyx3Q0FBd0MsR0FBRyxFQUFqRDtBQUNBLE1BQU1DLHVCQUF1QixHQUFHLENBQUMsRUFBakM7QUFDQSxNQUFNQyx3Q0FBd0MsR0FBRyxFQUFqRDtBQUNBLE1B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RSxLQUFKLENBQVcsZ0JBQWU4QyxJQUFJLENBQUNDLFNBQUwsQ0FBZVcsT0FBZixDQUF3QixFQUFsRDs7QUFFQTVELG9CQUFJRSxLQUFKLENBQVcsd0JBQXVCOEMsSUFBSSxDQUFDQyxTQUFMLENBQWUvQixNQUFmLENBQXVCLEdBQS9DLEdBQ0Msb0JBQW1COEIsSUFBSSxDQUFDQyxTQUFMLENBQWVpQixTQUFmLENBQTBCLEVBRHhEOztBQUVBLFdBQU9BLFNBQVA7QUFDRDtBQUNGLENBNUREOztBQThEQTdFLFVBQVUsQ0FBQzhFLGFBQVgsR0FBMkIsZUFBZUEsYUFBZixHQUFnQztBQUN6RCxTQUFPLEtBQVA7QUFDRCxDQUZEOztBQUlBOUUsVUFBVSxDQUFDK0UsV0FBWCxHQUF5QixlQUFlQSxXQUFmLENBQTRCQyxPQUE1QixFQUFxQztBQUM1RCxRQUFNQyxPQUFPLEdBQUdDLE9BQU8sQ0FBQ0MsTUFBUixFQUFoQjs7QUFDQSxNQUFJO0FBQ0YsV0FBTyxLQUFLQyxvQkFBTCxFQUEwQixNQUFNQyxrQkFBRUMsT0FBRixDQUFVTixPQUFWLEVBQ3BDTyxPQURvQyxDQUM1QnhGLGlCQUQ0QixDQUFoQyxFQUFQO0FBRUQsR0FIRCxDQUdFLE9BQU9XLEdBQVAsRUFBWTtBQUNaLFFBQUlBLEdBQUcsWUFBWTJFLGtCQUFFRyxZQUFyQixFQUFtQztBQUNqQyxZQUFNLElBQUlDLEtBQUosQ0FBVyxrQ0FBaUNQLE9BQU8sQ0FBQ0MsTUFBUixDQUFlRixPQUFmLEVBQXdCLENBQXhCLENBQTJCLEdBQXZFLENBQU47QUFDRDs7QUFDRCxVQUFNdkUsR0FBTjtBQUNEO0FBQ0YsQ0FYRDs7ZUFhZVYsVSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGlvc0NvbW1hbmRzIH0gZnJvbSAnYXBwaXVtLWlvcy1kcml2ZXInO1xuaW1wb3J0IHsgcmV0cnlJbnRlcnZhbCB9IGZyb20gJ2FzeW5jYm94JztcbmltcG9ydCB7IHV0aWwgfSBmcm9tICdhcHBpdW0tc3VwcG9ydCc7XG5pbXBvcnQgbG9nIGZyb20gJy4uL2xvZ2dlcic7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IEIgZnJvbSAnYmx1ZWJpcmQnO1xuXG5cbmNvbnN0IElQSE9ORV9FWFRSQV9XRUJfQ09PUkRfU0NST0xMX09GRlNFVCA9IC0xNTtcbmNvbnN0IElQSE9ORV9FWFRSQV9XRUJfQ09PUkRfTk9OX1NDUk9MTF9PRkZTRVQgPSAxMDtcbmNvbnN0IElQSE9ORV9XRUJfQ09PUkRfT0ZGU0VUID0gLTEwO1xuY29uc3QgSVBIT05FX1dFQl9DT09SRF9TTUFSVF9BUFBfQkFOTkVSX09GRlNFVCA9IDg0O1xuY29uc3QgSVBIT05FX1hfRVhUUkFfV0VCX0NPT1JEX1NDUk9MTF9PRkZTRVQgPSAtOTA7XG5jb25zdCBJUEhPTkVfWF9FWFRSQV9XRUJfQ09PUkRfTk9OX1NDUk9MTF9PRkZTRVQgPSAtMTA7XG5jb25zdCBJUEhPTkVfWF9XRUJfQ09PUkRfT0ZGU0VUID0gNDA7XG5jb25zdCBJUEFEX0VYVFJBX1dFQl9DT09SRF9TQ1JPTExfT0ZGU0VUID0gLTEwO1xuY29uc3QgSVBBRF9FWFRSQV9XRUJfQ09PUkRfTk9OX1NDUk9MTF9PRkZTRVQgPSAwO1xuY29uc3QgSVBBRF9XRUJfQ09PUkRfT0ZGU0VUID0gMTA7XG5jb25zdCBJUEFEX1dFQl9DT09SRF9TTUFSVF9BUFBfQkFOTkVSX09GRlNFVCA9IDk1O1xuXG5jb25zdCBJUEhPTkVfWF9XSURUSCA9IDM3NTtcbmNvbnN0IElQSE9ORV9YX0hFSUdIVCA9IDgxMjtcblxuY29uc3QgQVRPTV9XQUlUX1RJTUVPVVQgPSA1ICogNjAwMDA7XG5cbmxldCBleHRlbnNpb25zID0ge307XG5cbk9iamVjdC5hc3NpZ24oZXh0ZW5zaW9ucywgaW9zQ29tbWFuZHMud2ViKTtcblxuXG5cbmV4dGVuc2lvbnMuZ2V0U2FmYXJpSXNJcGhvbmUgPSBhc3luYyBmdW5jdGlvbiBnZXRTYWZhcmlJc0lwaG9uZSAoKSB7XG4gIHRyeSB7XG4gICAgY29uc3QgdXNlckFnZW50ID0gYXdhaXQgdGhpcy5leGVjdXRlKCdyZXR1cm4gbmF2aWdhdG9yLnVzZXJBZ2VudCcpO1xuICAgIHJldHVybiB1c2VyQWdlbnQudG9Mb3dlckNhc2UoKS5pbmNsdWRlcygnaXBob25lJyk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGxvZy53YXJuKGBVbmFibGUgdG8gZmluZCBkZXZpY2UgdHlwZSBmcm9tIHVzZXJhZ2VudC4gQXNzdW1pbmcgaVBob25lYCk7XG4gICAgbG9nLmRlYnVnKGBFcnJvcjogJHtlcnIubWVzc2FnZX1gKTtcbiAgfVxuICByZXR1cm4gdHJ1ZTtcbn07XG5cbmV4dGVuc2lvbnMuZ2V0U2FmYXJpSXNJcGhvbmVYID0gYXN5bmMgZnVuY3Rpb24gZ2V0U2FmYXJpSXNJcGhvbmUgKCkge1xuICB0cnkge1xuICAgIGNvbnN0IHNjcmlwdCA9ICdyZXR1cm4ge2hlaWdodDogd2luZG93LnNjcmVlbi5hdmFpbEhlaWdodCwgd2lkdGg6IHdpbmRvdy5zY3JlZW4uYXZhaWxXaWR0aH07JztcbiAgICBjb25zdCB7aGVpZ2h0LCB3aWR0aH0gPSBhd2FpdCB0aGlzLmV4ZWN1dGUoc2NyaXB0KTtcbiAgICAvLyBjaGVjayBmb3IgdGhlIGNvcnJlY3QgaGVpZ2h0IGFuZCB3aWR0aFxuICAgIHJldHVybiAoaGVpZ2h0ID09PSBJUEhPTkVfWF9IRUlHSFQgJiYgd2lkdGggPT09IElQSE9ORV9YX1dJRFRIKSB8fFxuICAgICAgICAgICAoaGVpZ2h0ID09PSBJUEhPTkVfWF9XSURUSCAmJiB3aWR0aCA9PT0gSVBIT05FX1hfSEVJR0hUKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgbG9nLndhcm4oYFVuYWJsZSB0byBmaW5kIGRldmljZSB0eXBlIGZyb20gdXNlcmFnZW50LiBBc3N1bWluZyBub3QgaVBob25lIFhgKTtcbiAgICBsb2cuZGVidWcoYEVycm9yOiAke2Vyci5tZXNzYWdlfWApO1xuICB9XG4gIHJldHVybiBmYWxzZTtcbn07XG5cbmNvbnN0IGdldEVsZW1lbnRIZWlnaHRNZW1vaXplZCA9IF8ubWVtb2l6ZShhc3luYyBmdW5jdGlvbiBnZXRFbGVtZW50SGVpZ2h0TWVtb2l6ZWQgKGtleSwgZHJpdmVyLCBlbCkge1xuICBlbCA9IHV0aWwudW53cmFwRWxlbWVudChlbCk7XG4gIHJldHVybiAoYXdhaXQgZHJpdmVyLmdldE5hdGl2ZVJlY3QoZWwpKS5oZWlnaHQ7XG59KTtcblxuZXh0ZW5zaW9ucy5nZXRFeHRyYVRyYW5zbGF0ZVdlYkNvb3Jkc09mZnNldCA9IGFzeW5jIGZ1bmN0aW9uIGdldEV4dHJhVHJhbnNsYXRlV2ViQ29vcmRzT2Zmc2V0IChjb29yZHMsIHdlYnZpZXdSZWN0KSB7XG4gIGxldCBvZmZzZXQgPSAwO1xuXG4gIC8vIGtlZXAgdHJhY2sgb2YgaW1wbGljaXQgd2FpdCwgYW5kIHNldCBsb2NhbGx5IHRvIDBcbiAgY29uc3QgaW1wbGljaXRXYWl0TXMgPSB0aGlzLmltcGxpY2l0V2FpdE1zO1xuXG4gIGNvbnN0IGlzSXBob25lID0gYXdhaXQgdGhpcy5nZXRTYWZhcmlJc0lwaG9uZSgpO1xuICBjb25zdCBpc0lwaG9uZVggPSBpc0lwaG9uZSAmJiBhd2FpdCB0aGlzLmdldFNhZmFyaUlzSXBob25lWCgpO1xuXG4gIHRyeSB7XG4gICAgdGhpcy5zZXRJbXBsaWNpdFdhaXQoMCk7XG5cbiAgICAvLyBjaGVjayBpZiB0aGUgZnVsbCB1cmwgYmFyIGlzIHVwXG4gICAgYXdhaXQgdGhpcy5maW5kTmF0aXZlRWxlbWVudE9yRWxlbWVudHMoJ2FjY2Vzc2liaWxpdHkgaWQnLCAnUmVsb2FkQnV0dG9uJywgZmFsc2UpO1xuXG4gICAgLy8gcmVsb2FkIGJ1dHRvbiBmb3VuZCwgd2hpY2ggbWVhbnMgc2Nyb2xsaW5nIGhhcyBub3QgaGFwcGVuZWRcbiAgICBpZiAoaXNJcGhvbmVYKSB7XG4gICAgICBvZmZzZXQgKz0gSVBIT05FX1hfRVhUUkFfV0VCX0NPT1JEX05PTl9TQ1JPTExfT0ZGU0VUO1xuICAgIH0gZWxzZSBpZiAoaXNJcGhvbmUpIHtcbiAgICAgIG9mZnNldCArPSBJUEhPTkVfRVhUUkFfV0VCX0NPT1JEX05PTl9TQ1JPTExfT0ZGU0VUO1xuICAgIH0gZWxzZSB7XG4gICAgICBvZmZzZXQgKz0gSVBBRF9FWFRSQV9XRUJfQ09PUkRfTk9OX1NDUk9MTF9PRkZTRVQ7XG4gICAgfVxuICB9IGNhdGNoIChlcnIpIHtcbiAgICAvLyBubyByZWxvYWQgYnV0dG9uLCB3aGljaCBpbmRpY2F0ZXMgc2Nyb2xsaW5nIGhhcyBoYXBwZW5lZFxuICAgIC8vIHRoZSBVUkwgYmFyIG1heSBvciBtYXkgbm90IGJlIHZpc2libGVcbiAgICB0cnkge1xuICAgICAgY29uc3QgZWwgPSBhd2FpdCB0aGlzLmZpbmROYXRpdmVFbGVtZW50T3JFbGVtZW50cygnYWNjZXNzaWJpbGl0eSBpZCcsICdVUkwnLCBmYWxzZSk7XG4gICAgICBvZmZzZXQgLT0gYXdhaXQgZ2V0RWxlbWVudEhlaWdodE1lbW9pemVkKCdVUkxCYXInLCB0aGlzLCBlbCk7XG4gICAgfSBjYXRjaCAoaWduKSB7XG4gICAgICAvLyBubyBVUkwgZWxlbWVudHMgZm91bmQsIHNvIGNvbnRpbnVlXG4gICAgfVxuICB9IGZpbmFsbHkge1xuICAgIC8vIHJldHVybiBpbXBsaWNpdCB3YWl0IHRvIHdoYXQgaXQgd2FzXG4gICAgdGhpcy5zZXRJbXBsaWNpdFdhaXQoaW1wbGljaXRXYWl0TXMpO1xuICB9XG5cbiAgaWYgKGNvb3Jkcy55ID4gd2Vidmlld1JlY3QuaGVpZ2h0KSB7XG4gICAgLy8gd2hlbiBzY3JvbGxpbmcgaGFzIGhhcHBlbmVkLCB0aGVyZSBpcyBhIHRpY2sgbW9yZSBvZmZzZXQgbmVlZGVkXG4gICAgaWYgKGlzSXBob25lWCkge1xuICAgICAgb2Zmc2V0ICs9IElQSE9ORV9YX0VYVFJBX1dFQl9DT09SRF9TQ1JPTExfT0ZGU0VUO1xuICAgIH0gZWxzZSBpZiAoaXNJcGhvbmUpIHtcbiAgICAgIG9mZnNldCArPSBJUEhPTkVfRVhUUkFfV0VCX0NPT1JEX1NDUk9MTF9PRkZTRVQ7XG4gICAgfSBlbHNlIHtcbiAgICAgIG9mZnNldCArPSBJUEFEX0VYVFJBX1dFQl9DT09SRF9TQ1JPTExfT0ZGU0VUO1xuICAgIH1cbiAgfVxuXG4gIC8vIGV4dHJhIG9mZnNldCBuZWNlc3NhcnlcbiAgb2Zmc2V0ICs9IGlzSXBob25lID8gSVBIT05FX1dFQl9DT09SRF9PRkZTRVQgOiBJUEFEX1dFQl9DT09SRF9PRkZTRVQ7XG5cbiAgb2Zmc2V0ICs9IGlzSXBob25lWCA/IElQSE9ORV9YX1dFQl9DT09SRF9PRkZTRVQgOiAwO1xuXG4gIGxvZy5kZWJ1ZyhgRXh0cmEgdHJhbnNsYXRlZCB3ZWIgY29vcmRpbmF0ZXMgb2Zmc2V0OiAke29mZnNldH1gKTtcbiAgcmV0dXJuIG9mZnNldDtcbn07XG5cbmV4dGVuc2lvbnMuZ2V0RXh0cmFOYXRpdmVXZWJUYXBPZmZzZXQgPSBhc3luYyBmdW5jdGlvbiBnZXRFeHRyYU5hdGl2ZVdlYlRhcE9mZnNldCAoKSB7XG4gIGxldCBvZmZzZXQgPSAwO1xuXG4gIC8vIGtlZXAgdHJhY2sgb2YgaW1wbGljaXQgd2FpdCwgYW5kIHNldCBsb2NhbGx5IHRvIDBcbiAgY29uc3QgaW1wbGljaXRXYWl0TXMgPSB0aGlzLmltcGxpY2l0V2FpdE1zO1xuICB0cnkge1xuICAgIHRoaXMuc2V0SW1wbGljaXRXYWl0KDApO1xuXG4gICAgLy8gZmlyc3QgdHJ5IHRvIGdldCB0YWIgb2Zmc2V0XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGVsID0gYXdhaXQgdGhpcy5maW5kTmF0aXZlRWxlbWVudE9yRWxlbWVudHMoJy1pb3MgcHJlZGljYXRlIHN0cmluZycsIGBuYW1lIExJS0UgJyosIFRhYicgQU5EIHZpc2libGUgPSAxYCwgZmFsc2UpO1xuICAgICAgb2Zmc2V0ICs9IGF3YWl0IGdldEVsZW1lbnRIZWlnaHRNZW1vaXplZCgnVGFiQmFyJywgdGhpcywgZWwpO1xuICAgIH0gY2F0Y2ggKGlnbikge1xuICAgICAgLy8gbm8gZWxlbWVudCBmb3VuZCwgc28gbm8gdGFicyBhbmQgbm8gbmVlZCB0byBkZWFsIHdpdGggb2Zmc2V0XG4gICAgfVxuXG4gICAgLy8gbmV4dCB0cnkgdG8gc2VlIGlmIHRoZXJlIGlzIGFuIFNtYXJ0IEFwcCBCYW5uZXJcbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5maW5kTmF0aXZlRWxlbWVudE9yRWxlbWVudHMoJ2FjY2Vzc2liaWxpdHkgaWQnLCAnQ2xvc2UgYXBwIGRvd25sb2FkIG9mZmVyJywgZmFsc2UpO1xuICAgICAgb2Zmc2V0ICs9IGF3YWl0IHRoaXMuZ2V0U2FmYXJpSXNJcGhvbmUoKSA/XG4gICAgICAgIElQSE9ORV9XRUJfQ09PUkRfU01BUlRfQVBQX0JBTk5FUl9PRkZTRVQgOlxuICAgICAgICBJUEFEX1dFQl9DT09SRF9TTUFSVF9BUFBfQkFOTkVSX09GRlNFVDtcbiAgICB9IGNhdGNoIChpZ24pIHtcbiAgICAgIC8vIG5vIHNtYXJ0IGFwcCBiYW5uZXIgZm91bmQsIHNvIGNvbnRpbnVlXG4gICAgfVxuICB9IGZpbmFsbHkge1xuICAgIC8vIHJldHVybiBpbXBsaWNpdCB3YWl0IHRvIHdoYXQgaXQgd2FzXG4gICAgdGhpcy5zZXRJbXBsaWNpdFdhaXQoaW1wbGljaXRXYWl0TXMpO1xuICB9XG5cbiAgbG9nLmRlYnVnKGBBZGRpdGlvbmFsIG5hdGl2ZSB3ZWIgdGFwIG9mZnNldCBjb21wdXRlZDogJHtvZmZzZXR9YCk7XG4gIHJldHVybiBvZmZzZXQ7XG59O1xuXG5hc3luYyBmdW5jdGlvbiB0YXBXZWJFbGVtZW50TmF0aXZlbHkgKGRyaXZlciwgYXRvbXNFbGVtZW50KSB7XG4gIC8vIHRyeSB0byBnZXQgdGhlIHRleHQgb2YgdGhlIGVsZW1lbnQsIHdoaWNoIHdpbGwgYmUgYWNjZXNzaWJsZSBpbiB0aGVcbiAgLy8gbmF0aXZlIGNvbnRleHRcbiAgdHJ5IHtcbiAgICBsZXQgdGV4dCA9IGF3YWl0IGRyaXZlci5leGVjdXRlQXRvbSgnZ2V0X3RleHQnLCBbYXRvbXNFbGVtZW50XSk7XG4gICAgaWYgKCF0ZXh0KSB7XG4gICAgICB0ZXh0ID0gYXdhaXQgZHJpdmVyLmV4ZWN1dGVBdG9tKCdnZXRfYXR0cmlidXRlX3ZhbHVlJywgW2F0b21zRWxlbWVudCwgJ3ZhbHVlJ10pO1xuICAgIH1cblxuICAgIGlmICh0ZXh0KSB7XG4gICAgICBjb25zdCBlbCA9IGF3YWl0IGRyaXZlci5maW5kTmF0aXZlRWxlbWVudE9yRWxlbWVudHMoJ2FjY2Vzc2liaWxpdHkgaWQnLCB0ZXh0LCBmYWxzZSk7XG4gICAgICAvLyB1c2UgdGFwIGJlY2F1c2Ugb24gaU9TIDExLjIgYW5kIGJlbG93IGBuYXRpdmVDbGlja2AgY3Jhc2hlcyBXREFcbiAgICAgIGNvbnN0IHJlY3QgPSBhd2FpdCBkcml2ZXIucHJveHlDb21tYW5kKGAvZWxlbWVudC8ke2VsLkVMRU1FTlR9L3JlY3RgLCAnR0VUJyk7XG4gICAgICBjb25zdCBjb29yZHMgPSB7XG4gICAgICAgIHg6IE1hdGgucm91bmQocmVjdC54ICsgcmVjdC53aWR0aCAvIDIpLFxuICAgICAgICB5OiBNYXRoLnJvdW5kKHJlY3QueSArIHJlY3QuaGVpZ2h0IC8gMiksXG4gICAgICB9O1xuICAgICAgYXdhaXQgZHJpdmVyLmNsaWNrQ29vcmRzKGNvb3Jkcyk7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIC8vIGFueSBmYWlsdXJlIHNob3VsZCBmYWxsIHRocm91Z2ggYW5kIHRyaWdnZXIgdGhlIG1vcmUgZWxhYm9yYXRlXG4gICAgLy8gbWV0aG9kIG9mIGNsaWNraW5nXG4gICAgbG9nLndhcm4oYEVycm9yIGF0dGVtcHRpbmcgdG8gY2xpY2s6ICR7ZXJyLm1lc3NhZ2V9YCk7XG4gIH1cbiAgcmV0dXJuIGZhbHNlO1xufVxuXG5leHRlbnNpb25zLm5hdGl2ZVdlYlRhcCA9IGFzeW5jIGZ1bmN0aW9uIG5hdGl2ZVdlYlRhcCAoZWwpIHtcbiAgY29uc3QgYXRvbXNFbGVtZW50ID0gdGhpcy51c2VBdG9tc0VsZW1lbnQoZWwpO1xuXG4gIGlmIChhd2FpdCB0YXBXZWJFbGVtZW50TmF0aXZlbHkodGhpcywgYXRvbXNFbGVtZW50KSkge1xuICAgIHJldHVybjtcbiAgfVxuICBsb2cud2FybignVW5hYmxlIHRvIGRvIHNpbXBsZSBuYXRpdmUgd2ViIHRhcC4gQXR0ZW1wdGluZyB0byBjb252ZXJ0IGNvb3JkaW5hdGVzJyk7XG5cbiAgLy8gYGdldF90b3BfbGVmdF9jb29yZGluYXRlc2AgcmV0dXJucyB0aGUgd3JvbmcgdmFsdWUgc29tZXRpbWVzLFxuICAvLyB1bmxlc3Mgd2UgcHJlLWNhbGwgYm90aCBvZiB0aGVzZSBmdW5jdGlvbnMgYmVmb3JlIHRoZSBhY3R1YWwgY2FsbHNcbiAgYXdhaXQgdGhpcy5leGVjdXRlQXRvbSgnZ2V0X3NpemUnLCBbYXRvbXNFbGVtZW50XSk7XG4gIGF3YWl0IHRoaXMuZXhlY3V0ZUF0b20oJ2dldF90b3BfbGVmdF9jb29yZGluYXRlcycsIFthdG9tc0VsZW1lbnRdKTtcblxuICBjb25zdCB7d2lkdGgsIGhlaWdodH0gPSBhd2FpdCB0aGlzLmV4ZWN1dGVBdG9tKCdnZXRfc2l6ZScsIFthdG9tc0VsZW1lbnRdKTtcbiAgbGV0IHt4LCB5fSA9IGF3YWl0IHRoaXMuZXhlY3V0ZUF0b20oJ2dldF90b3BfbGVmdF9jb29yZGluYXRlcycsIFthdG9tc0VsZW1lbnRdKTtcbiAgeCArPSB3aWR0aCAvIDI7XG4gIHkgKz0gaGVpZ2h0IC8gMjtcblxuICB0aGlzLmN1cldlYkNvb3JkcyA9IHt4LCB5fTtcbiAgYXdhaXQgdGhpcy5jbGlja1dlYkNvb3JkcygpO1xufTtcblxuZXh0ZW5zaW9ucy5jbGlja0Nvb3JkcyA9IGFzeW5jIGZ1bmN0aW9uIGNsaWNrQ29vcmRzIChjb29yZHMpIHtcbiAgYXdhaXQgdGhpcy5wZXJmb3JtVG91Y2goW1xuICAgIHtcbiAgICAgIGFjdGlvbjogJ3RhcCcsXG4gICAgICBvcHRpb25zOiBjb29yZHMsXG4gICAgfSxcbiAgXSk7XG59O1xuXG5leHRlbnNpb25zLnRyYW5zbGF0ZVdlYkNvb3JkcyA9IGFzeW5jIGZ1bmN0aW9uIHRyYW5zbGF0ZVdlYkNvb3JkcyAoY29vcmRzKSB7XG4gIGxvZy5kZWJ1ZyhgVHJhbnNsYXRpbmcgY29vcmRpbmF0ZXMgKCR7SlNPTi5zdHJpbmdpZnkoY29vcmRzKX0pIHRvIHdlYiBjb29yZGluYXRlc2ApO1xuXG4gIC8vIGFic29sdXRpemUgd2ViIGNvb3Jkc1xuICBjb25zdCBpbXBsaWNpdFdhaXRNcyA9IHRoaXMuaW1wbGljaXRXYWl0TXM7XG4gIGxldCB3ZWJ2aWV3O1xuICB0cnkge1xuICAgIHRoaXMuc2V0SW1wbGljaXRXYWl0KDApO1xuICAgIHdlYnZpZXcgPSBhd2FpdCByZXRyeUludGVydmFsKDUsIDEwMCwgYXN5bmMgKCkgPT4ge1xuICAgICAgcmV0dXJuIGF3YWl0IHRoaXMuZmluZE5hdGl2ZUVsZW1lbnRPckVsZW1lbnRzKCctaW9zIHByZWRpY2F0ZSBzdHJpbmcnLCBgdHlwZSA9ICdYQ1VJRWxlbWVudFR5cGVXZWJWaWV3JyBBTkQgdmlzaWJsZSA9IDFgLCBmYWxzZSk7XG4gICAgfSk7XG4gIH0gZmluYWxseSB7XG4gICAgdGhpcy5zZXRJbXBsaWNpdFdhaXQoaW1wbGljaXRXYWl0TXMpO1xuICB9XG5cbiAgd2VidmlldyA9IHV0aWwudW53cmFwRWxlbWVudCh3ZWJ2aWV3KTtcbiAgY29uc3QgcmVjdCA9IGF3YWl0IHRoaXMucHJveHlDb21tYW5kKGAvZWxlbWVudC8ke3dlYnZpZXd9L3JlY3RgLCAnR0VUJyk7XG4gIGNvbnN0IHd2UG9zID0ge3g6IHJlY3QueCwgeTogcmVjdC55fTtcbiAgY29uc3QgcmVhbERpbXMgPSB7dzogcmVjdC53aWR0aCwgaDogcmVjdC5oZWlnaHR9O1xuXG4gIGNvbnN0IGNtZCA9ICcoZnVuY3Rpb24gKCkgeyByZXR1cm4ge3c6IGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5jbGllbnRXaWR0aCwgaDogZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LmNsaWVudEhlaWdodH07IH0pKCknO1xuICBjb25zdCB3dkRpbXMgPSBhd2FpdCB0aGlzLnJlbW90ZS5leGVjdXRlKGNtZCk7XG5cbiAgLy8gVE9ETzogaW52ZXN0aWdhdGUgd2hlcmUgdGhlc2UgY29tZSBmcm9tLiBUaGV5IGFwcGVhciB0byBiZSBjb25zdGFudHMgaW4gbXkgdGVzdHNcbiAgY29uc3QgdXJsQmFySGVpZ2h0ID0gNjQ7XG4gIHd2UG9zLnkgKz0gdXJsQmFySGVpZ2h0O1xuXG4gIGNvbnN0IHJlYWxEaW1lbnNpb25IZWlnaHQgPSAxMDg7XG4gIHJlYWxEaW1zLmggLT0gcmVhbERpbWVuc2lvbkhlaWdodDtcblxuICAvLyBhZGQgc3RhdGljIG9mZnNldCBmb3Igc2FmYXJpIGluIGxhbmRzY2FwZSBtb2RlXG4gIGxldCB5T2Zmc2V0ID0gdGhpcy5vcHRzLmN1ck9yaWVudGF0aW9uID09PSAnTEFORFNDQVBFJyA/IHRoaXMubGFuZHNjYXBlV2ViQ29vcmRzT2Zmc2V0IDogMDtcblxuICAvLyBhZGQgZXh0cmEgb2Zmc2V0IGZvciBwb3NzaWJsZSBleHRyYSB0aGluZ3MgaW4gdGhlIHRvcCBvZiB0aGUgcGFnZVxuICB5T2Zmc2V0ICs9IGF3YWl0IHRoaXMuZ2V0RXh0cmFOYXRpdmVXZWJUYXBPZmZzZXQoKTtcbiAgY29vcmRzLnkgKz0gYXdhaXQgdGhpcy5nZXRFeHRyYVRyYW5zbGF0ZVdlYkNvb3Jkc09mZnNldChjb29yZHMsIHJlY3QpO1xuXG4gIGlmICh3dkRpbXMgJiYgcmVhbERpbXMgJiYgd3ZQb3MpIHtcbiAgICBsZXQgeFJhdGlvID0gcmVhbERpbXMudyAvIHd2RGltcy53O1xuICAgIGxldCB5UmF0aW8gPSByZWFsRGltcy5oIC8gd3ZEaW1zLmg7XG4gICAgbGV0IG5ld0Nvb3JkcyA9IHtcbiAgICAgIHg6IHd2UG9zLnggKyBNYXRoLnJvdW5kKHhSYXRpbyAqIGNvb3Jkcy54KSxcbiAgICAgIHk6IHd2UG9zLnkgKyB5T2Zmc2V0ICsgTWF0aC5yb3VuZCh5UmF0aW8gKiBjb29yZHMueSksXG4gICAgfTtcblxuICAgIC8vIGFkZGl0aW9uYWwgbG9nZ2luZyBmb3IgY29vcmRpbmF0ZXMsIHNpbmNlIGl0IGlzIHNvbWV0aW1lcyBicm9rZW5cbiAgICAvLyAgIHNlZSBodHRwczovL2dpdGh1Yi5jb20vYXBwaXVtL2FwcGl1bS9pc3N1ZXMvOTE1OVxuICAgIGxvZy5kZWJ1ZyhgQ29udmVydGVkIGNvb3JkaW5hdGVzOiAke0pTT04uc3RyaW5naWZ5KG5ld0Nvb3Jkcyl9YCk7XG4gICAgbG9nLmRlYnVnKGAgICAgcmVjdDogJHtKU09OLnN0cmluZ2lmeShyZWN0KX1gKTtcbiAgICBsb2cuZGVidWcoYCAgICB3dlBvczogJHtKU09OLnN0cmluZ2lmeSh3dlBvcyl9YCk7XG4gICAgbG9nLmRlYnVnKGAgICAgcmVhbERpbXM6ICR7SlNPTi5zdHJpbmdpZnkocmVhbERpbXMpfWApO1xuICAgIGxvZy5kZWJ1ZyhgICAgIHd2RGltczogJHtKU09OLnN0cmluZ2lmeSh3dkRpbXMpfWApO1xuICAgIGxvZy5kZWJ1ZyhgICAgIHhSYXRpbzogJHtKU09OLnN0cmluZ2lmeSh4UmF0aW8pfWApO1xuICAgIGxvZy5kZWJ1ZyhgICAgIHlSYXRpbzogJHtKU09OLnN0cmluZ2lmeSh5UmF0aW8pfWApO1xuICAgIGxvZy5kZWJ1ZyhgICAgIHlPZmZzZXQ6ICR7SlNPTi5zdHJpbmdpZnkoeU9mZnNldCl9YCk7XG5cbiAgICBsb2cuZGVidWcoYENvbnZlcnRlZCB3ZWIgY29vcmRzICR7SlNPTi5zdHJpbmdpZnkoY29vcmRzKX0gYCArXG4gICAgICAgICAgICAgIGBpbnRvIHJlYWwgY29vcmRzICR7SlNPTi5zdHJpbmdpZnkobmV3Q29vcmRzKX1gKTtcbiAgICByZXR1cm4gbmV3Q29vcmRzO1xuICB9XG59O1xuXG5leHRlbnNpb25zLmNoZWNrRm9yQWxlcnQgPSBhc3luYyBmdW5jdGlvbiBjaGVja0ZvckFsZXJ0ICgpIHsgLy8gZXNsaW50LWRpc2FibGUtbGluZSByZXF1aXJlLWF3YWl0XG4gIHJldHVybiBmYWxzZTtcbn07XG5cbmV4dGVuc2lvbnMud2FpdEZvckF0b20gPSBhc3luYyBmdW5jdGlvbiB3YWl0Rm9yQXRvbSAocHJvbWlzZSkge1xuICBjb25zdCBzdGFydGVkID0gcHJvY2Vzcy5ocnRpbWUoKTtcbiAgdHJ5IHtcbiAgICByZXR1cm4gdGhpcy5wYXJzZUV4ZWN1dGVSZXNwb25zZShhd2FpdCBCLnJlc29sdmUocHJvbWlzZSlcbiAgICAgIC50aW1lb3V0KEFUT01fV0FJVF9USU1FT1VUKSk7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGlmIChlcnIgaW5zdGFuY2VvZiBCLlRpbWVvdXRFcnJvcikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBEaWQgbm90IGdldCBhbnkgcmVzcG9uc2UgYWZ0ZXIgJHtwcm9jZXNzLmhydGltZShzdGFydGVkKVswXX1zYCk7XG4gICAgfVxuICAgIHRocm93IGVycjtcbiAgfVxufTtcblxuZXhwb3J0IGRlZmF1bHQgZXh0ZW5zaW9ucztcbiJdLCJmaWxlIjoibGliL2NvbW1hbmRzL3dlYi5qcyIsInNvdXJjZVJvb3QiOiIuLi8uLi8uLiJ9
