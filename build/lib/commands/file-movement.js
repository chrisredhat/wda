"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.commands = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumSupport = require("appium-support");

var _path = _interopRequireDefault(require("path"));

var _appiumIosDriver = require("appium-ios-driver");

var _logger = _interopRequireDefault(require("../logger"));

var _teen_process = require("teen_process");

var _nodeSimctl = require("node-simctl");

const CONTAINER_PATH_MARKER = '@';
const CONTAINER_PATH_PATTERN = new RegExp(`^${CONTAINER_PATH_MARKER}([^/]+)/(.+)`);
const CONTAINER_TYPE_SEPARATOR = ':';
let commands = _appiumIosDriver.iosCommands.file;
exports.commands = commands;

async function verifyIFusePresence() {
  if (!(await _appiumSupport.fs.which('ifuse'))) {
    _logger.default.errorAndThrow(`'ifuse' tool is required to be installed on the machine. ` + `Install it using 'brew cask install osxfuse && brew install ifuse' or check ` + `if it is available in PATH environment variable if the tool is already installed. ` + `Current PATH value: ${process.env.PATH}`);
  }
}

async function mountDevice(device, iFuseArgs) {
  _logger.default.debug(`Starting ifuse with args '${iFuseArgs}'...`);

  try {
    await (0, _teen_process.exec)('ifuse', iFuseArgs);
  } catch (e) {
    _logger.default.errorAndThrow(`Cannot mount the media folder of the device with UDID ${device.udid}. ` + `Make sure osxfuse plugin has necessary permissions in System Preferences->Security & Privacy. ` + `Error code: ${e.code}; stderr output: ${e.stderr}`);
  }
}

function verifyIsSubPath(originalPath, root) {
  const normalizedRoot = _path.default.normalize(root);

  const normalizedPath = _path.default.normalize(_path.default.dirname(originalPath));

  if (!normalizedPath.startsWith(normalizedRoot)) {
    _logger.default.errorAndThrow(`'${normalizedPath}' is expected to be a subpath of '${normalizedRoot}'`);
  }
}

async function parseContainerPath(remotePath, containerRootSupplier) {
  const match = CONTAINER_PATH_PATTERN.exec(remotePath);

  if (!match) {
    _logger.default.errorAndThrow(`It is expected that package identifier ` + `starts with '${CONTAINER_PATH_MARKER}' and is separated from the ` + `relative path with a single slash. '${remotePath}' is given instead`);
  }

  let [, bundleId, relativePath] = match;
  let containerType = null;
  const typeSeparatorPos = bundleId.indexOf(CONTAINER_TYPE_SEPARATOR);

  if (typeSeparatorPos > 0 && typeSeparatorPos < bundleId.length - 1) {
    containerType = bundleId.substring(typeSeparatorPos + 1);

    _logger.default.debug(`Parsed container type: ${containerType}`);

    bundleId = bundleId.substring(0, typeSeparatorPos);
  }

  const containerRoot = _lodash.default.isFunction(containerRootSupplier) ? await containerRootSupplier(bundleId, containerType) : containerRootSupplier;

  const resultPath = _path.default.posix.resolve(containerRoot, relativePath);

  verifyIsSubPath(resultPath, containerRoot);
  return [bundleId, resultPath];
}

async function pushFileToSimulator(device, remotePath, base64Data) {
  const buffer = Buffer.from(base64Data, 'base64');

  if (CONTAINER_PATH_PATTERN.test(remotePath)) {
    const [bundleId, dstPath] = await parseContainerPath(remotePath, async (appBundle, containerType) => await (0, _nodeSimctl.getAppContainer)(device.udid, appBundle, null, containerType));

    _logger.default.info(`Parsed bundle identifier '${bundleId}' from '${remotePath}'. ` + `Will put the data into '${dstPath}'`);

    if (!(await _appiumSupport.fs.exists(_path.default.dirname(dstPath)))) {
      _logger.default.debug(`The destination folder '${_path.default.dirname(dstPath)}' does not exist. Creating...`);

      await (0, _appiumSupport.mkdirp)(_path.default.dirname(dstPath));
    }

    await _appiumSupport.fs.writeFile(dstPath, buffer);
    return;
  }

  const dstFolder = await _appiumSupport.tempDir.openDir();

  const dstPath = _path.default.resolve(dstFolder, _path.default.basename(remotePath));

  try {
    await _appiumSupport.fs.writeFile(dstPath, buffer);
    await (0, _nodeSimctl.addMedia)(device.udid, dstPath);
  } finally {
    await _appiumSupport.fs.rimraf(dstFolder);
  }
}

async function pushFileToRealDevice(device, remotePath, base64Data) {
  await verifyIFusePresence();
  const mntRoot = await _appiumSupport.tempDir.openDir();
  let isUnmountSuccessful = true;

  try {
    let dstPath = _path.default.resolve(mntRoot, remotePath);

    let ifuseArgs = ['-u', device.udid, mntRoot];

    if (CONTAINER_PATH_PATTERN.test(remotePath)) {
      const [bundleId, pathInContainer] = await parseContainerPath(remotePath, mntRoot);
      dstPath = pathInContainer;

      _logger.default.info(`Parsed bundle identifier '${bundleId}' from '${remotePath}'. ` + `Will put the data into '${dstPath}'`);

      ifuseArgs = ['-u', device.udid, '--container', bundleId, mntRoot];
    } else {
      verifyIsSubPath(dstPath, mntRoot);
    }

    await mountDevice(device, ifuseArgs);
    isUnmountSuccessful = false;

    try {
      if (!(await _appiumSupport.fs.exists(_path.default.dirname(dstPath)))) {
        _logger.default.debug(`The destination folder '${_path.default.dirname(dstPath)}' does not exist. Creating...`);

        await (0, _appiumSupport.mkdirp)(_path.default.dirname(dstPath));
      }

      await _appiumSupport.fs.writeFile(dstPath, Buffer.from(base64Data, 'base64'));
    } finally {
      await (0, _teen_process.exec)('umount', [mntRoot]);
      isUnmountSuccessful = true;
    }
  } finally {
    if (isUnmountSuccessful) {
      await _appiumSupport.fs.rimraf(mntRoot);
    } else {
      _logger.default.warn(`Umount has failed, so not removing '${mntRoot}'`);
    }
  }
}

async function pullFromSimulator(device, remotePath, isFile) {
  let pathOnServer;

  if (CONTAINER_PATH_PATTERN.test(remotePath)) {
    const [bundleId, dstPath] = await parseContainerPath(remotePath, async (appBundle, containerType) => await (0, _nodeSimctl.getAppContainer)(device.udid, appBundle, null, containerType));

    _logger.default.info(`Parsed bundle identifier '${bundleId}' from '${remotePath}'. ` + `Will get the data from '${dstPath}'`);

    pathOnServer = dstPath;
  } else {
    const simRoot = device.getDir();
    pathOnServer = _path.default.posix.join(simRoot, remotePath);
    verifyIsSubPath(pathOnServer, simRoot);

    _logger.default.info(`Got the full item path: ${pathOnServer}`);
  }

  if (!(await _appiumSupport.fs.exists(pathOnServer))) {
    _logger.default.errorAndThrow(`The remote ${isFile ? 'file' : 'folder'} at '${pathOnServer}' does not exist`);
  }

  const buffer = isFile ? await _appiumSupport.fs.readFile(pathOnServer) : await _appiumSupport.zip.toInMemoryZip(pathOnServer);
  return Buffer.from(buffer).toString('base64');
}

async function pullFromRealDevice(device, remotePath, isFile) {
  await verifyIFusePresence();
  const mntRoot = await _appiumSupport.tempDir.openDir();
  let isUnmountSuccessful = true;

  try {
    let dstPath = _path.default.resolve(mntRoot, remotePath);

    let ifuseArgs = ['-u', device.udid, mntRoot];

    if (CONTAINER_PATH_PATTERN.test(remotePath)) {
      const [bundleId, pathInContainer] = await parseContainerPath(remotePath, mntRoot);
      dstPath = pathInContainer;

      _logger.default.info(`Parsed bundle identifier '${bundleId}' from '${remotePath}'. ` + `Will get the data from '${dstPath}'`);

      ifuseArgs = ['-u', device.udid, '--container', bundleId, mntRoot];
    } else {
      verifyIsSubPath(dstPath, mntRoot);
    }

    await mountDevice(device, ifuseArgs);
    isUnmountSuccessful = false;

    try {
      if (!(await _appiumSupport.fs.exists(dstPath))) {
        _logger.default.errorAndThrow(`The remote ${isFile ? 'file' : 'folder'} at '${dstPath}' does not exist`);
      }

      const buffer = isFile ? await _appiumSupport.fs.readFile(dstPath) : await _appiumSupport.zip.toInMemoryZip(dstPath);
      return Buffer.from(buffer).toString('base64');
    } finally {
      await (0, _teen_process.exec)('umount', [mntRoot]);
      isUnmountSuccessful = true;
    }
  } finally {
    if (isUnmountSuccessful) {
      await _appiumSupport.fs.rimraf(mntRoot);
    } else {
      _logger.default.warn(`Umount has failed, so not removing '${mntRoot}'`);
    }
  }
}

commands.pushFile = async function pushFile(remotePath, base64Data) {
  if (remotePath.endsWith('/')) {
    _logger.default.errorAndThrow(`It is expected that remote path points to a file and not to a folder. ` + `'${remotePath}' is given instead`);
  }

  if (_lodash.default.isArray(base64Data)) {
    base64Data = Buffer.from(base64Data).toString('utf8');
  }

  return this.isSimulator() ? await pushFileToSimulator(this.opts.device, remotePath, base64Data) : await pushFileToRealDevice(this.opts.device, remotePath, base64Data);
};

commands.pullFile = async function pullFile(remotePath) {
  if (remotePath.endsWith('/')) {
    _logger.default.errorAndThrow(`It is expected that remote path points to a file and not to a folder. ` + `'${remotePath}' is given instead`);
  }

  return this.isSimulator() ? await pullFromSimulator(this.opts.device, remotePath, true) : await pullFromRealDevice(this.opts.device, remotePath, true);
};

commands.getSimFileFullPath = async function getSimFileFullPath(remotePath) {
  let basePath = this.opts.device.getDir();
  let appName = null;

  if (this.opts.app) {
    let appNameRegex = new RegExp(`\\${_path.default.sep}([\\w-]+\\.app)`);
    let appNameMatches = appNameRegex.exec(this.opts.app);

    if (appNameMatches) {
      appName = appNameMatches[1];
    }
  }

  if (_appiumSupport.system.isWindows()) {
    if (remotePath.indexof('://') === 1) {
      remotePath = remotePath.slice(4);
    }
  } else {
    if (remotePath.indexOf('/') === 0) {
      remotePath = remotePath.slice(1);
    }
  }

  if (remotePath.startsWith(appName)) {
    let findPath = basePath;

    if (!this.opts.platformVersion || _appiumSupport.util.compareVersions(this.opts.platformVersion, '>=', '8.0')) {
      findPath = _path.default.resolve(basePath, 'Containers', 'Bundle');
    }

    findPath = findPath.replace(/\s/g, '\\ ');
    let {
      stdout
    } = await (0, _teen_process.exec)('find', [findPath, '-name', appName]);
    let appRoot = stdout.replace(/\n$/, '');
    let subPath = remotePath.substring(appName.length + 1);

    let fullPath = _path.default.resolve(appRoot, subPath);

    _logger.default.debug(`Finding app-relative file: '${fullPath}'`);

    return fullPath;
  }

  let fullPath = _path.default.resolve(basePath, remotePath);

  _logger.default.debug(`Finding sim-relative file: ${fullPath}`);

  return fullPath;
};

commands.pullFolder = async function pullFolder(remotePath) {
  if (!remotePath.endsWith('/')) {
    remotePath = `${remotePath}/`;
  }

  return this.isSimulator() ? await pullFromSimulator(this.opts.device, remotePath, false) : await pullFromRealDevice(this.opts.device, remotePath, false);
};

var _default = commands;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9maWxlLW1vdmVtZW50LmpzIl0sIm5hbWVzIjpbIkNPTlRBSU5FUl9QQVRIX01BUktFUiIsIkNPTlRBSU5FUl9QQVRIX1BBVFRFUk4iLCJSZWdFeHAiLCJDT05UQUlORVJfVFlQRV9TRVBBUkFUT1IiLCJjb21tYW5kcyIsImlvc0NvbW1hbmRzIiwiZmlsZSIsInZlcmlmeUlGdXNlUHJlc2VuY2UiLCJmcyIsIndoaWNoIiwibG9nIiwiZXJyb3JBbmRUaHJvdyIsInByb2Nlc3MiLCJlbnYiLCJQQVRIIiwibW91bnREZXZpY2UiLCJkZXZpY2UiLCJpRnVzZUFyZ3MiLCJkZWJ1ZyIsImUiLCJ1ZGlkIiwiY29kZSIsInN0ZGVyciIsInZlcmlmeUlzU3ViUGF0aCIsIm9yaWdpbmFsUGF0aCIsInJvb3QiLCJub3JtYWxpemVkUm9vdCIsInBhdGgiLCJub3JtYWxpemUiLCJub3JtYWxpemVkUGF0aCIsImRpcm5hbWUiLCJzdGFydHNXaXRoIiwicGFyc2VDb250YWluZXJQYXRoIiwicmVtb3RlUGF0aCIsImNvbnRhaW5lclJvb3RTdXBwbGllciIsIm1hdGNoIiwiZXhlYyIsImJ1bmRsZUlkIiwicmVsYXRpdmVQYXRoIiwiY29udGFpbmVyVHlwZSIsInR5cGVTZXBhcmF0b3JQb3MiLCJpbmRleE9mIiwibGVuZ3RoIiwic3Vic3RyaW5nIiwiY29udGFpbmVyUm9vdCIsIl8iLCJpc0Z1bmN0aW9uIiwicmVzdWx0UGF0aCIsInBvc2l4IiwicmVzb2x2ZSIsInB1c2hGaWxlVG9TaW11bGF0b3IiLCJiYXNlNjREYXRhIiwiYnVmZmVyIiwiQnVmZmVyIiwiZnJvbSIsInRlc3QiLCJkc3RQYXRoIiwiYXBwQnVuZGxlIiwiaW5mbyIsImV4aXN0cyIsIndyaXRlRmlsZSIsImRzdEZvbGRlciIsInRlbXBEaXIiLCJvcGVuRGlyIiwiYmFzZW5hbWUiLCJyaW1yYWYiLCJwdXNoRmlsZVRvUmVhbERldmljZSIsIm1udFJvb3QiLCJpc1VubW91bnRTdWNjZXNzZnVsIiwiaWZ1c2VBcmdzIiwicGF0aEluQ29udGFpbmVyIiwid2FybiIsInB1bGxGcm9tU2ltdWxhdG9yIiwiaXNGaWxlIiwicGF0aE9uU2VydmVyIiwic2ltUm9vdCIsImdldERpciIsImpvaW4iLCJyZWFkRmlsZSIsInppcCIsInRvSW5NZW1vcnlaaXAiLCJ0b1N0cmluZyIsInB1bGxGcm9tUmVhbERldmljZSIsInB1c2hGaWxlIiwiZW5kc1dpdGgiLCJpc0FycmF5IiwiaXNTaW11bGF0b3IiLCJvcHRzIiwicHVsbEZpbGUiLCJnZXRTaW1GaWxlRnVsbFBhdGgiLCJiYXNlUGF0aCIsImFwcE5hbWUiLCJhcHAiLCJhcHBOYW1lUmVnZXgiLCJzZXAiLCJhcHBOYW1lTWF0Y2hlcyIsInN5c3RlbSIsImlzV2luZG93cyIsImluZGV4b2YiLCJzbGljZSIsImZpbmRQYXRoIiwicGxhdGZvcm1WZXJzaW9uIiwidXRpbCIsImNvbXBhcmVWZXJzaW9ucyIsInJlcGxhY2UiLCJzdGRvdXQiLCJhcHBSb290Iiwic3ViUGF0aCIsImZ1bGxQYXRoIiwicHVsbEZvbGRlciJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7QUFBQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFDQTs7QUFFQSxNQUFNQSxxQkFBcUIsR0FBRyxHQUE5QjtBQUVBLE1BQU1DLHNCQUFzQixHQUFHLElBQUlDLE1BQUosQ0FBWSxJQUFHRixxQkFBc0IsY0FBckMsQ0FBL0I7QUFDQSxNQUFNRyx3QkFBd0IsR0FBRyxHQUFqQztBQUdBLElBQUlDLFFBQVEsR0FBR0MsNkJBQVlDLElBQTNCOzs7QUFFQSxlQUFlQyxtQkFBZixHQUFzQztBQUNwQyxNQUFJLEVBQUMsTUFBTUMsa0JBQUdDLEtBQUgsQ0FBUyxPQUFULENBQVAsQ0FBSixFQUE4QjtBQUM1QkMsb0JBQUlDLGFBQUosQ0FBbUIsMkRBQUQsR0FDQyw4RUFERCxHQUVDLG9GQUZELEdBR0MsdUJBQXNCQyxPQUFPLENBQUNDLEdBQVIsQ0FBWUMsSUFBSyxFQUgxRDtBQUlEO0FBQ0Y7O0FB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QUVBLFVBQVcsR0FBM0I7QUFDRDs7QUFDRCxTQUFPLEtBQUtxRCxXQUFMLEtBQ0gsTUFBTWQsaUJBQWlCLENBQUMsS0FBS2UsSUFBTCxDQUFVdkUsTUFBWCxFQUFtQmlCLFVBQW5CLEVBQStCLEtBQS9CLENBRHBCLEdBRUgsTUFBTWlELGtCQUFrQixDQUFDLEtBQUtLLElBQUwsQ0FBVXZFLE1BQVgsRUFBbUJpQixVQUFuQixFQUErQixLQUEvQixDQUY1QjtBQUdELENBUEQ7O2VBVWU3QixRIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IHN5c3RlbSwgZnMsIHRlbXBEaXIsIG1rZGlycCwgemlwLCB1dGlsIH0gZnJvbSAnYXBwaXVtLXN1cHBvcnQnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgeyBpb3NDb21tYW5kcyB9IGZyb20gJ2FwcGl1bS1pb3MtZHJpdmVyJztcbmltcG9ydCBsb2cgZnJvbSAnLi4vbG9nZ2VyJztcbmltcG9ydCB7IGV4ZWMgfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuaW1wb3J0IHsgYWRkTWVkaWEsIGdldEFwcENvbnRhaW5lciB9IGZyb20gJ25vZGUtc2ltY3RsJztcblxuY29uc3QgQ09OVEFJTkVSX1BBVEhfTUFSS0VSID0gJ0AnO1xuLy8gaHR0cHM6Ly9yZWdleDEwMS5jb20vci9QTGRCMEcvMlxuY29uc3QgQ09OVEFJTkVSX1BBVEhfUEFUVEVSTiA9IG5ldyBSZWdFeHAoYF4ke0NPTlRBSU5FUl9QQVRIX01BUktFUn0oW14vXSspLyguKylgKTtcbmNvbnN0IENPTlRBSU5FUl9UWVBFX1NFUEFSQVRPUiA9ICc6JztcblxuXG5sZXQgY29tbWFuZHMgPSBpb3NDb21tYW5kcy5maWxlO1xuXG5hc3luYyBmdW5jdGlvbiB2ZXJpZnlJRnVzZVByZXNlbmNlICgpIHtcbiAgaWYgKCFhd2FpdCBmcy53aGljaCgnaWZ1c2UnKSkge1xuICAgIGxvZy5lcnJvckFuZFRocm93KGAnaWZ1c2UnIHRvb2wgaXMgcmVxdWlyZWQgdG8gYmUgaW5zdGFsbGVkIG9uIHRoZSBtYWNoaW5lLiBgICtcbiAgICAgICAgICAgICAgICAgICAgICBgSW5zdGFsbCBpdCB1c2luZyAnYnJldyBjYXNrIGluc3RhbGwgb3N4ZnVzZSAmJiBicmV3IGluc3RhbGwgaWZ1c2UnIG9yIGNoZWNrIGAgK1xuICAgICAgICAgICAgICAgICAgICAgIGBpZiBpdCBpcyBhdmFpbGFibGUgaW4gUEFUSCBlbnZpcm9ubWVudCB2YXJpYWJsZSBpZiB0aGUgdG9vbCBpcyBhbHJlYWR5IGluc3RhbGxlZC4gYCArXG4gICAgICAgICAgICAgICAgICAgICAgYEN1cnJlbnQgUEFUSCB2YWx1ZTogJHtwcm9jZXNzLmVudi5QQVRIfWApO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIG1vdW50RGV2aWNlIChkZXZpY2UsIGlGdXNlQXJncykge1xuICBsb2cuZGVidWcoYFN0YXJ0aW5nIGlmdXNlIHdpdGggYXJncyAnJHtpRnVzZUFyZ3N9Jy4uLmApO1xuICB0cnkge1xuICAgIGF3YWl0IGV4ZWMoJ2lmdXNlJywgaUZ1c2VBcmdzKTtcbiAgfSBjYXRjaCAoZSkge1xuICAgIGxvZy5lcnJvckFuZFRocm93KGBDYW5ub3QgbW91bnQgdGhlIG1lZGlhIGZvbGRlciBvZiB0aGUgZGV2aWNlIHdpdGggVURJRCAke2RldmljZS51ZGlkfS4gYCArXG4gICAgICAgICAgICAgICAgICAgICAgYE1ha2Ugc3VyZSBvc3hmdXNlIHBsdWdpbiBoYXMgbmVjZXNzYXJ5IHBlcm1pc3Npb25zIGluIFN5c3RlbSBQcmVmZXJlbmNlcy0+U2VjdXJpdHkgJiBQcml2YWN5LiBgICtcbiAgICAgICAgICAgICAgICAgICAgICBgRXJyb3IgY29kZTogJHtlLmNvZGV9OyBzdGRlcnIgb3V0cHV0OiAke2Uuc3RkZXJyfWApO1xuICB9XG59XG5cbmZ1bmN0aW9uIHZlcmlmeUlzU3ViUGF0aCAob3JpZ2luYWxQYXRoLCByb290KSB7XG4gIGNvbnN0IG5vcm1hbGl6ZWRSb290ID0gcGF0aC5ub3JtYWxpemUocm9vdCk7XG4gIGNvbnN0IG5vcm1hbGl6ZWRQYXRoID0gcGF0aC5ub3JtYWxpemUocGF0aC5kaXJuYW1lKG9yaWdpbmFsUGF0aCkpO1xuICBpZiAoIW5vcm1hbGl6ZWRQYXRoLnN0YXJ0c1dpdGgobm9ybWFsaXplZFJvb3QpKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYCcke25vcm1hbGl6ZWRQYXRofScgaXMgZXhwZWN0ZWQgdG8gYmUgYSBzdWJwYXRoIG9mICcke25vcm1hbGl6ZWRSb290fSdgKTtcbiAgfVxufVxuXG4vKipcbiAqIFBhcnNlcyB0aGUgYWN0dWFsIHBhdGggYW5kIHRoZSBidW5kbGUgaWRlbnRpZmllciBmcm9tIHRoZSBnaXZlbiBwYXRoIHN0cmluZ1xuICpcbiAqIEBwYXJhbSB7c3RyaW5nfSByZW1vdGVQYXRoIC0gVGhlIGdpdmVuIHBhdGggc3RyaW5nLiBUaGUgc3RyaW5nIHNob3VsZFxuICogbWF0Y2ggYENPTlRBSU5FUl9QQVRIX1BBVFRFUk5gIHJlZ2V4cCwgb3RoZXJ3aXNlIGFuIGVycm9yIGlzIGdvaW5nXG4gKiB0byBiZSB0aHJvd24uIEEgdmFsaWQgc3RyaW5nIGV4YW1wbGU6IGBAYnVuZGxlLmlkZW50aWZpZXI6Y29udGFpbmVyX3R5cGUvcmVsYXRpdmVfcGF0aF9pbl9jb250YWluZXJgXG4gKiBAcGFyYW0ge0Z1bmN0aW9ufHN0cmluZ30gY29udGFpbmVyUm9vdFN1cHBsaWVyIC0gRWl0aGVyIGEgc3RyaW5nLCB0aGF0IGNvbnRhaW5zXG4gKiBmdWxsIHBhdGggdG8gdGhlIG1vdW50IHJvb3QgZm9yIHJlYWwgZGV2aWNlcyBvciBhIGZ1bmN0aW9uLCB3aGljaCBhY2NlcHRzIHR3byBwYXJhbWV0ZXJzXG4gKiAoYnVuZGxlIGlkZW50aWZpZXIgYW5kIG9wdGlvbmFsIGNvbnRhaW5lciB0eXBlKSBhbmQgcmV0dXJucyBmdWxsIHBhdGggdG8gY29udGFpbmVyXG4gKiByb290IGZvbGRlciBvbiB0aGUgbG9jYWwgZmlsZSBzeXN0ZW0sIGZvciBTaW11bGF0b3JcbiAqIEByZXR1cm5zIHtBcnJheTxzdHJpbmc+fSAtIEFuIGFycmF5IHdoZXJlIHRoZSBmaXJzdCBpdGVtIGlzIHRoZSBwYXJzZWQgYnVuZGxlXG4gKiBpZGVudGlmaWVyIGFuZCB0aGUgc2Vjb25kIG9uZSBpcyB0aGUgYWJzb2x1dGUgZnVsbCBwYXRoIG9mIHRoZSBpdGVtIG9uIHRoZSBsb2NhbFxuICogZmlsZSBzeXN0ZW1cbiAqL1xuYXN5bmMgZnVuY3Rpb24gcGFyc2VDb250YWluZXJQYXRoIChyZW1vdGVQYXRoLCBjb250YWluZXJSb290U3VwcGxpZXIpIHtcbiAgY29uc3QgbWF0Y2ggPSBDT05UQUlORVJfUEFUSF9QQVRURVJOLmV4ZWMocmVtb3RlUGF0aCk7XG4gIGlmICghbWF0Y2gpIHtcbiAgICBsb2cuZXJyb3JBbmRUaHJvdyhgSXQgaXMgZXhwZWN0ZWQgdGhhdCBwYWNrYWdlIGlkZW50aWZpZXIgYCArXG4gICAgICBgc3RhcnRzIHdpdGggJyR7Q09OVEFJTkVSX1BBVEhfTUFSS0VSfScgYW5kIGlzIHNlcGFyYXRlZCBmcm9tIHRoZSBgICtcbiAgICAgIGByZWxhdGl2ZSBwYXRoIHdpdGggYSBzaW5nbGUgc2xhc2guICcke3JlbW90ZVBhdGh9JyBpcyBnaXZlbiBpbnN0ZWFkYCk7XG4gIH1cbiAgbGV0IFssIGJ1bmRsZUlkLCByZWxhdGl2ZVBhdGhdID0gbWF0Y2g7XG4gIGxldCBjb250YWluZXJUeXBlID0gbnVsbDtcbiAgY29uc3QgdHlwZVNlcGFyYXRvclBvcyA9IGJ1bmRsZUlkLmluZGV4T2YoQ09OVEFJTkVSX1RZUEVfU0VQQVJBVE9SKTtcbiAgLy8gV2Ugb25seSBjb25zaWRlciBjb250YWluZXIgdHlwZSBleGlzdHMgaWYgaXRzIGxlbmd0aCBpcyBncmVhdGVyIHRoYW4gemVyb1xuICAvLyBub3QgY291bnRpbmcgdGhlIGNvbG9uXG4gIGlmICh0eXBlU2VwYXJhdG9yUG9zID4gMCAmJiB0eXBlU2VwYXJhdG9yUG9zIDwgYnVuZGxlSWQubGVuZ3RoIC0gMSkge1xuICAgIGNvbnRhaW5lclR5cGUgPSBidW5kbGVJZC5zdWJzdHJpbmcodHlwZVNlcGFyYXRvclBvcyArIDEpO1xuICAgIGxvZy5kZWJ1ZyhgUGFyc2VkIGNvbnRhaW5lciB0eXBlOiAke2NvbnRhaW5lclR5cGV9YCk7XG4gICAgYnVuZGxlSWQgPSBidW5kbGVJZC5zdWJzdHJpbmcoMCwgdHlwZVNlcGFyYXRvclBvcyk7XG4gIH1cbiAgY29uc3QgY29udGFpbmVyUm9vdCA9IF8uaXNGdW5jdGlvbihjb250YWluZXJSb290U3VwcGxpZXIpXG4gICAgPyBhd2FpdCBjb250YWluZXJSb290U3VwcGxpZXIoYnVuZGxlSWQsIGNvbnRhaW5lclR5cGUpXG4gICAgOiBjb250YWluZXJSb290U3VwcGxpZXI7XG4gIGNvbnN0IHJlc3VsdFBhdGggPSBwYXRoLnBvc2l4LnJlc29sdmUoY29udGFpbmVyUm9vdCwgcmVsYXRpdmVQYXRoKTtcbiAgdmVyaWZ5SXNTdWJQYXRoKHJlc3VsdFBhdGgsIGNvbnRhaW5lclJvb3QpO1xuICByZXR1cm4gW2J1bmRsZUlkLCByZXN1bHRQYXRoXTtcbn1cblxuLyoqXG4gKiBTYXZlIHRoZSBnaXZlbiBiYXNlNjQgZGF0YSBjaHVuayBhcyBhIGJpbmFyeSBmaWxlIG9uIHRoZSBTaW11bGF0b3IgdW5kZXIgdGVzdC5cbiAqXG4gKiBAcGFyYW0ge09iamVjdH0gZGV2aWNlIC0gVGhlIGRldmljZSBvYmplY3QsIHdoaWNoIHJlcHJlc2VudHMgdGhlIGRldmljZSB1bmRlciB0ZXN0LlxuICogICAgICAgICAgICAgICAgICAgICAgICAgIFRoaXMgb2JqZWN0IGlzIGV4cGVjdGVkIHRvIGhhdmUgdGhlIGB1ZGlkYCBwcm9wZXJ0eSBjb250YWluaW5nIHRoZVxuICogICAgICAgICAgICAgICAgICAgICAgICAgIHZhbGlkIGRldmljZSBJRC5cbiAqIEBwYXJhbSB7c3RyaW5nfSByZW1vdGVQYXRoIC0gVGhlIHJlbW90ZSBwYXRoIG9uIHRoZSBkZXZpY2UuIFRoaXMgdmFyaWFibGUgY2FuIGJlIHByZWZpeGVkIHdpdGhcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnVuZGxlIGlkLCBzbyB0aGVuIHRoZSBmaWxlIHdpbGwgYmUgdXBsb2FkZWQgdG8gdGhlIGNvcnJlc3BvbmRpbmdcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwbGljYXRpb24gY29udGFpbmVyIGluc3RlYWQgb2YgdGhlIGRlZmF1bHQgbWVkaWEgZm9sZGVyLCBmb3IgZXhhbXBsZVxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnQGNvbS5teWFwcC5ibGE6ZGF0YS9SZWxhdGl2ZVBhdGhJbkNvbnRhaW5lci8xMTEucG5nJy4gVGhlICdAJyBjaGFyYWN0ZXIgYXQgdGhlXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJlZ2lubmluZyBvZiB0aGUgYXJndW1lbnQgaXMgbWFuZGF0b3J5IGluIHN1Y2ggY2FzZS4gVGhlIGNvbG9uIGF0IHRoZSBlbmQgb2YgYnVuZGxlIGlkZW50aWZpZXJcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgaXMgb3B0aW9uYWwgYW5kIGlzIHVzZWQgdG8gZGlzdGluZ3Vpc2ggdGhlIGNvbnRhaW5lciB0eXBlLlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBQb3NzaWJsZSB2YWx1ZXMgdGhlcmUgYXJlICdhcHAnLCAnZGF0YScsICdncm91cHMnLCAnPEEgc3BlY2lmaWMgQXBwIEdyb3VwIGNvbnRhaW5lcj4nLlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBUaGUgZGVmYXVsdCB2YWx1ZSBpcyAnYXBwJy5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgVGhlIHJlbGF0aXZlIGZvbGRlciBwYXRoIGlzIGlnbm9yZWQgaWYgdGhlIGZpbGUgaXMgZ29pbmcgdG8gYmUgdXBsb2FkZWRcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdG8gdGhlIGRlZmF1bHQgbWVkaWEgZm9sZGVyIGFuZCBvbmx5IHRoZSBmaWxlIG5hbWUgaXMgY29uc2lkZXJlZCBpbXBvcnRhbnQuXG4gKiBAcGFyYW0ge3N0cmluZ30gYmFzZTY0RGF0YSAtIEJhc2UtNjQgZW5jb2RlZCBjb250ZW50IG9mIHRoZSBmaWxlIHRvIGJlIHVwbG9hZGVkLlxuICovXG5hc3luYyBmdW5jdGlvbiBwdXNoRmlsZVRvU2ltdWxhdG9yIChkZXZpY2UsIHJlbW90ZVBhdGgsIGJhc2U2NERhdGEpIHtcbiAgY29uc3QgYnVmZmVyID0gQnVmZmVyLmZyb20oYmFzZTY0RGF0YSwgJ2Jhc2U2NCcpO1xuICBpZiAoQ09OVEFJTkVSX1BBVEhfUEFUVEVSTi50ZXN0KHJlbW90ZVBhdGgpKSB7XG4gICAgY29uc3QgW2J1bmRsZUlkLCBkc3RQYXRoXSA9IGF3YWl0IHBhcnNlQ29udGFpbmVyUGF0aChyZW1vdGVQYXRoLFxuICAgICAgYXN5bmMgKGFwcEJ1bmRsZSwgY29udGFpbmVyVHlwZSkgPT4gYXdhaXQgZ2V0QXBwQ29udGFpbmVyKGRldmljZS51ZGlkLCBhcHBCdW5kbGUsIG51bGwsIGNvbnRhaW5lclR5cGUpKTtcbiAgICBsb2cuaW5mbyhgUGFyc2VkIGJ1bmRsZSBpZGVudGlmaWVyICcke2J1bmRsZUlkfScgZnJvbSAnJHtyZW1vdGVQYXRofScuIGAgK1xuICAgICAgYFdpbGwgcHV0IHRoZSBkYXRhIGludG8gJyR7ZHN0UGF0aH0nYCk7XG4gICAgaWYgKCFhd2FpdCBmcy5leGlzdHMocGF0aC5kaXJuYW1lKGRzdFBhdGgpKSkge1xuICAgICAgbG9nLmRlYnVnKGBUaGUgZGVzdGluYXRpb24gZm9sZGVyICcke3BhdGguZGlybmFtZShkc3RQYXRoKX0nIGRvZXMgbm90IGV4aXN0LiBDcmVhdGluZy4uLmApO1xuICAgICAgYXdhaXQgbWtkaXJwKHBhdGguZGlybmFtZShkc3RQYXRoKSk7XG4gICAgfVxuICAgIGF3YWl0IGZzLndyaXRlRmlsZShkc3RQYXRoLCBidWZmZXIpO1xuICAgIHJldHVybjtcbiAgfVxuICBjb25zdCBkc3RGb2xkZXIgPSBhd2FpdCB0ZW1wRGlyLm9wZW5EaXIoKTtcbiAgY29uc3QgZHN0UGF0aCA9IHBhdGgucmVzb2x2ZShkc3RGb2xkZXIsIHBhdGguYmFzZW5hbWUocmVtb3RlUGF0aCkpO1xuICB0cnkge1xuICAgIGF3YWl0IGZzLndyaXRlRmlsZShkc3RQYXRoLCBidWZmZXIpO1xuICAgIGF3YWl0IGFkZE1lZGlhKGRldmljZS51ZGlkLCBkc3RQYXRoKTtcbiAgfSBmaW5hbGx5IHtcbiAgICBhd2FpdCBmcy5yaW1yYWYoZHN0Rm9sZGVyKTtcbiAgfVxufVxuXG4vKipcbiAqIFNhdmUgdGhlIGdpdmVuIGJhc2U2NCBkYXRhIGNodW5rIGFzIGEgYmluYXJ5IGZpbGUgb24gdGhlIGRldmljZSB1bmRlciB0ZXN0LlxuICogaWZ1c2Uvb3N4ZnVzZSBzaG91bGQgYmUgaW5zdGFsbGVkIGFuZCBjb25maWd1cmVkIG9uIHRoZSB0YXJnZXQgbWFjaGluZSBpbiBvcmRlclxuICogZm9yIHRoaXMgZnVuY3Rpb24gdG8gd29yayBwcm9wZXJseS4gUmVhZCBodHRwczovL2dpdGh1Yi5jb20vbGliaW1vYmlsZWRldmljZS9pZnVzZVxuICogYW5kIGh0dHBzOi8vZ2l0aHViLmNvbS9vc3hmdXNlL29zeGZ1c2Uvd2lraS9GQVEgZm9yIG1vcmUgZGV0YWlscy5cbiAqXG4gKiBAcGFyYW0ge09iamVjdH0gZGV2aWNlIC0gVGhlIGRldmljZSBvYmplY3QsIHdoaWNoIHJlcHJlc2VudHMgdGhlIGRldmljZSB1bmRlciB0ZXN0LlxuICogICAgICAgICAgICAgICAgICAgICAgICAgIFRoaXMgb2JqZWN0IGlzIGV4cGVjdGVkIHRvIGhhdmUgdGhlIGB1ZGlkYCBwcm9wZXJ0eSBjb250YWluaW5nIHRoZVxuICogICAgICAgICAgICAgICAgICAgICAgICAgIHZhbGlkIGRldmljZSBJRC5cbiAqIEBwYXJhbSB7c3RyaW5nfSByZW1vdGVQYXRoIC0gVGhlIHJlbW90ZSBwYXRoIG9uIHRoZSBkZXZpY2UuIFRoaXMgdmFyaWFibGUgY2FuIGJlIHByZWZpeGVkIHdpdGhcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYnVuZGxlIGlkLCBzbyB0aGVuIHRoZSBmaWxlIHdpbGwgYmUgdXBsb2FkZWQgdG8gdGhlIGNvcnJlc3BvbmRpbmdcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXBwbGljYXRpb24gY29udGFpbmVyIGluc3RlYWQgb2YgdGhlIGRlZmF1bHQgbWVkaWEgZm9sZGVyLCBmb3IgZXhhbXBsZVxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnQGNvbS5teWFwcC5ibGEvUmVsYXRpdmVQYXRoSW5Db250YWluZXIvMTExLnBuZycuIFRoZSAnQCcgY2hhcmFjdGVyIGF0IHRoZVxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBiZWdpbm5pbmcgb2YgdGhlIGFyZ3VtZW50IGlzIG1hbmRhdG9yeSBpbiBzdWNoIGNhc2UuXG4gKiBAcGFyYW0ge3N0cmluZ30gYmFzZTY0RGF0YSAtIEJhc2UtNjQgZW5jb2RlZCBjb250ZW50IG9mIHRoZSBmaWxlIHRvIGJlIHVwbG9hZGVkLlxuICovXG5hc3luYyBmdW5jdGlvbiBwdXNoRmlsZVRvUmVhbERldmljZSAoZGV2aWNlLCByZW1vdGVQYXRoLCBiYXNlNjREYXRhKSB7XG4gIGF3YWl0IHZlcmlmeUlGdXNlUHJlc2VuY2UoKTtcbiAgY29uc3QgbW50Um9vdCA9IGF3YWl0IHRlbXBEaXIub3BlbkRpcigpO1xuICBsZXQgaXNVbm1vdW50U3VjY2Vzc2Z1bCA9IHRydWU7XG4gIHRyeSB7XG4gICAgbGV0IGRzdFBhdGggPSBwYXRoLnJlc29sdmUobW50Um9vdCwgcmVtb3RlUGF0aCk7XG4gICAgbGV0IGlmdXNlQXJncyA9IFsnLXUnLCBkZXZpY2UudWRpZCwgbW50Um9vdF07XG4gICAgaWYgKENPTlRBSU5FUl9QQVRIX1BBVFRFUk4udGVzdChyZW1vdGVQYXRoKSkge1xuICAgICAgY29uc3QgW2J1bmRsZUlkLCBwYXRoSW5Db250YWluZXJdID0gYXdhaXQgcGFyc2VDb250YWluZXJQYXRoKHJlbW90ZVBhdGgsIG1udFJvb3QpO1xuICAgICAgZHN0UGF0aCA9IHBhdGhJbkNvbnRhaW5lcjtcbiAgICAgIGxvZy5pbmZvKGBQYXJzZWQgYnVuZGxlIGlkZW50aWZpZXIgJyR7YnVuZGxlSWR9JyBmcm9tICcke3JlbW90ZVBhdGh9Jy4gYCArXG4gICAgICAgIGBXaWxsIHB1dCB0aGUgZGF0YSBpbnRvICcke2RzdFBhdGh9J2ApO1xuICAgICAgaWZ1c2VBcmdzID0gWyctdScsIGRldmljZS51ZGlkLCAnLS1jb250YWluZXInLCBidW5kbGVJZCwgbW50Um9vdF07XG4gICAgfSBlbHNlIHtcbiAgICAgIHZlcmlmeUlzU3ViUGF0aChkc3RQYXRoLCBtbnRSb290KTtcbiAgICB9XG4gICAgYXdhaXQgbW91bnREZXZpY2UoZGV2aWNlLCBpZnVzZUFyZ3MpO1xuICAgIGlzVW5tb3VudFN1Y2Nlc3NmdWwgPSBmYWxzZTtcbiAgICB0cnkge1xuICAgICAgaWYgKCFhd2FpdCBmcy5leGlzdHMocGF0aC5kaXJuYW1lKGRzdFBhdGgpKSkge1xuICAgICAgICBsb2cuZGVidWcoYFRoZSBkZXN0aW5hdGlvbiBmb2xkZXIgJyR7cGF0aC5kaXJuYW1lKGRzdFBhdGgpfScgZG9lcyBub3QgZXhpc3QuIENyZWF0aW5nLi4uYCk7XG4gICAgICAgIGF3YWl0IG1rZGlycChwYXRoLmRpcm5hbWUoZHN0UGF0aCkpO1xuICAgICAgfVxuICAgICAgYXdhaXQgZnMud3JpdGVGaWxlKGRzdFBhdGgsIEJ1ZmZlci5mcm9tKGJhc2U2NERhdGEsICdiYXNlNjQnKSk7XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIGF3YWl0IGV4ZWMoJ3Vtb3VudCcsIFttbnRSb290XSk7XG4gICAgICBpc1VubW91bnRTdWNjZXNzZnVsID0gdHJ1ZTtcbiAgICB9XG4gIH0gZmluYWxseSB7XG4gICAgaWYgKGlzVW5tb3VudFN1Y2Nlc3NmdWwpIHtcbiAgICAgIGF3YWl0IGZzLnJpbXJhZihtbnRSb290KTtcbiAgICB9IGVsc2Uge1xuICAgICAgbG9nLndhcm4oYFVtb3VudCBoYXMgZmFpbGVkLCBzbyBub3QgcmVtb3ZpbmcgJyR7bW50Um9vdH0nYCk7XG4gICAgfVxuICB9XG59XG5cbi8qKlxuICogR2V0IHRoZSBjb250ZW50IG9mIGdpdmVuIGZpbGUgb3IgZm9sZGVyIGZyb20gaU9TIFNpbXVsYXRvciBhbmQgcmV0dXJuIGl0IGFzIGJhc2UtNjQgZW5jb2RlZCBzdHJpbmcuXG4gKiBGb2xkZXIgY29udGVudCBpcyByZWN1cnNpdmVseSBwYWNrZWQgaW50byBhIHppcCBhcmNoaXZlLlxuICpcbiAqIEBwYXJhbSB7T2JqZWN0fSBkZXZpY2UgLSBUaGUgZGV2aWNlIG9iamVjdCwgd2hpY2ggcmVwcmVzZW50cyB0aGUgZGV2aWNlIHVuZGVyIHRlc3QuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgVGhpcyBvYmplY3QgaXMgZXhwZWN0ZWQgdG8gaGF2ZSB0aGUgYHVkaWRgIHByb3BlcnR5IGNvbnRhaW5pbmcgdGhlXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsaWQgZGV2aWNlIElELlxuICogQHBhcmFtIHtzdHJpbmd9IHJlbW90ZVBhdGggLSBUaGUgcGF0aCB0byBhIGZpbGUgb3IgYSBmb2xkZXIsIHdoaWNoIGV4aXN0cyBpbiB0aGUgY29ycmVzcG9uZGluZyBhcHBsaWNhdGlvblxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjb250YWluZXIgb24gU2ltdWxhdG9yLiBVc2VcbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgQDxhcHBfYnVuZGxlX2lkPjo8b3B0aW9uYWxfY29udGFpbmVyX3R5cGU+LzxwYXRoX3RvX3RoZV9maWxlX29yX2ZvbGRlcl9pbnNpZGVfY29udGFpbmVyPlxuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBmb3JtYXQgdG8gcHVsbCBhIGZpbGUgb3IgYSBmb2xkZXIgZnJvbSBhbiBhcHBsaWNhdGlvbiBjb250YWluZXIgb2YgdGhlIGdpdmVuIHR5cGUuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFBvc3NpYmxlIGNvbnRhaW5lciB0eXBlcyBhcmUgJ2FwcCcsICdkYXRhJywgJ2dyb3VwcycsICc8QSBzcGVjaWZpYyBBcHAgR3JvdXAgY29udGFpbmVyPicuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFRoZSBkZWZhdWx0IHR5cGUgaXMgJ2FwcCcuXG4gKiBAcGFyYW0ge2Jvb2xlYW59IGlzRmlsZSAtIFdoZXRoZXIgdGhlIGRlc3RpbmF0aW9uIGl0ZW0gaXMgYSBmaWxlIG9yIGEgZm9sZGVyXG4gKiBAcmV0dXJucyB7c3RyaW5nfSBCYXNlLTY0IGVuY29kZWQgY29udGVudCBvZiB0aGUgZmlsZS5cbiAqL1xuYXN5bmMgZnVuY3Rpb24gcHVsbEZyb21TaW11bGF0b3IgKGRldmljZSwgcmVtb3RlUGF0aCwgaXNGaWxlKSB7XG4gIGxldCBwYXRoT25TZXJ2ZXI7XG4gIGlmIChDT05UQUlORVJfUEFUSF9QQVRURVJOLnRlc3QocmVtb3RlUGF0aCkpIHtcbiAgICBjb25zdCBbYnVuZGxlSWQsIGRzdFBhdGhdID0gYXdhaXQgcGFyc2VDb250YWluZXJQYXRoKHJlbW90ZVBhdGgsXG4gICAgICBhc3luYyAoYXBwQnVuZGxlLCBjb250YWluZXJUeXBlKSA9PiBhd2FpdCBnZXRBcHBDb250YWluZXIoZGV2aWNlLnVkaWQsIGFwcEJ1bmRsZSwgbnVsbCwgY29udGFpbmVyVHlwZSkpO1xuICAgIGxvZy5pbmZvKGBQYXJzZWQgYnVuZGxlIGlkZW50aWZpZXIgJyR7YnVuZGxlSWR9JyBmcm9tICcke3JlbW90ZVBhdGh9Jy4gYCArXG4gICAgICBgV2lsbCBnZXQgdGhlIGRhdGEgZnJvbSAnJHtkc3RQYXRofSdgKTtcbiAgICBwYXRoT25TZXJ2ZXIgPSBkc3RQYXRoO1xuICB9IGVsc2Uge1xuICAgIGNvbnN0IHNpbVJvb3QgPSBkZXZpY2UuZ2V0RGlyKCk7XG4gICAgcGF0aE9uU2VydmVyID0gcGF0aC5wb3NpeC5qb2luKHNpbVJvb3QsIHJlbW90ZVBhdGgpO1xuICAgIHZlcmlmeUlzU3ViUGF0aChwYXRoT25TZXJ2ZXIsIHNpbVJvb3QpO1xuICAgIGxvZy5pbmZvKGBHb3QgdGhlIGZ1bGwgaXRlbSBwYXRoOiAke3BhdGhPblNlcnZlcn1gKTtcbiAgfVxuICBpZiAoIWF3YWl0IGZzLmV4aXN0cyhwYXRoT25TZXJ2ZXIpKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYFRoZSByZW1vdGUgJHtpc0ZpbGUgPyAnZmlsZScgOiAnZm9sZGVyJ30gYXQgJyR7cGF0aE9uU2VydmVyfScgZG9lcyBub3QgZXhpc3RgKTtcbiAgfVxuICBjb25zdCBidWZmZXIgPSBpc0ZpbGVcbiAgICA/IGF3YWl0IGZzLnJlYWRGaWxlKHBhdGhPblNlcnZlcilcbiAgICA6IGF3YWl0IHppcC50b0luTWVtb3J5WmlwKHBhdGhPblNlcnZlcik7XG4gIHJldHVybiBCdWZmZXIuZnJvbShidWZmZXIpLnRvU3RyaW5nKCdiYXNlNjQnKTtcbn1cblxuLyoqXG4gKiBHZXQgdGhlIGNvbnRlbnQgb2YgZ2l2ZW4gZmlsZSBvciBmb2xkZXIgZnJvbSB0aGUgcmVhbCBkZXZpY2UgdW5kZXIgdGVzdCBhbmQgcmV0dXJuIGl0IGFzIGJhc2UtNjQgZW5jb2RlZCBzdHJpbmcuXG4gKiBGb2xkZXIgY29udGVudCBpcyByZWN1cnNpdmVseSBwYWNrZWQgaW50byBhIHppcCBhcmNoaXZlLlxuICpcbiAqIEBwYXJhbSB7T2JqZWN0fSBkZXZpY2UgLSBUaGUgZGV2aWNlIG9iamVjdCwgd2hpY2ggcmVwcmVzZW50cyB0aGUgZGV2aWNlIHVuZGVyIHRlc3QuXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgVGhpcyBvYmplY3QgaXMgZXhwZWN0ZWQgdG8gaGF2ZSB0aGUgYHVkaWRgIHByb3BlcnR5IGNvbnRhaW5pbmcgdGhlXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgdmFsaWQgZGV2aWNlIElELlxuICogQHBhcmFtIHtzdHJpbmd9IHJlbW90ZVBhdGggLSBUaGUgcGF0aCB0byBhbiBleGlzdGluZyByZW1vdGUgZmlsZSBvbiB0aGUgZGV2aWNlLiBUaGlzIHZhcmlhYmxlIGNhbiBiZSBwcmVmaXhlZCB3aXRoXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJ1bmRsZSBpZCwgc28gdGhlbiB0aGUgZmlsZSB3aWxsIGJlIGRvd25sb2FkZWQgZnJvbSB0aGUgY29ycmVzcG9uZGluZ1xuICogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhcHBsaWNhdGlvbiBjb250YWluZXIgaW5zdGVhZCBvZiB0aGUgZGVmYXVsdCBtZWRpYSBmb2xkZXIsIGZvciBleGFtcGxlXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdAY29tLm15YXBwLmJsYS9SZWxhdGl2ZVBhdGhJbkNvbnRhaW5lci8xMTEucG5nJy4gVGhlICdAJyBjaGFyYWN0ZXIgYXQgdGhlXG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGJlZ2lubmluZyBvZiB0aGUgYXJndW1lbnQgaXMgbWFuZGF0b3J5IGluIHN1Y2ggY2FzZS5cbiAqIEBwYXJhbSB7Ym9vbGVhbn0gaXNGaWxlIC0gV2hldGhlciB0aGUgZGVzdGluYXRpb24gaXRlbSBpcyBhIGZpbGUgb3IgYSBmb2xkZXJcbiAqIEByZXR1cm4ge3N0cmluZ30gQmFzZS02NCBlbmNvZGVkIGNvbnRlbnQgb2YgdGhlIHJlbW90ZSBmaWxlXG4gKi9cbmFzeW5jIGZ1bmN0aW9uIHB1bGxGcm9tUmVhbERldmljZSAoZGV2aWNlLCByZW1vdGVQYXRoLCBpc0ZpbGUpIHtcbiAgYXdhaXQgdmVyaWZ5SUZ1c2VQcmVzZW5jZSgpO1xuICBjb25zdCBtbnRSb290ID0gYXdhaXQgdGVtcERpci5vcGVuRGlyKCk7XG4gIGxldCBpc1VubW91bnRTdWNjZXNzZnVsID0gdHJ1ZTtcbiAgdHJ5IHtcbiAgICBsZXQgZHN0UGF0aCA9IHBhdGgucmVzb2x2ZShtbnRSb290LCByZW1vdGVQYXRoKTtcbiAgICBsZXQgaWZ1c2VBcmdzID0gWyctdScsIGRldmljZS51ZGlkLCBtbnRSb290XTtcbiAgICBpZiAoQ09OVEFJTkVSX1BBVEhfUEFUVEVSTi50ZXN0KHJlbW90ZVBhdGgpKSB7XG4gICAgICBjb25zdCBbYnVuZGxlSWQsIHBhdGhJbkNvbnRhaW5lcl0gPSBhd2FpdCBwYXJzZUNvbnRhaW5lclBhdGgocmVtb3RlUGF0aCwgbW50Um9vdCk7XG4gICAgICBkc3RQYXRoID0gcGF0aEluQ29udGFpbmVyO1xuICAgICAgbG9nLmluZm8oYFBhcnNlZCBidW5kbGUgaWRlbnRpZmllciAnJHtidW5kbGVJZH0nIGZyb20gJyR7cmVtb3RlUGF0aH0nLiBgICtcbiAgICAgICAgYFdpbGwgZ2V0IHRoZSBkYXRhIGZyb20gJyR7ZHN0UGF0aH0nYCk7XG4gICAgICBpZnVzZUFyZ3MgPSBbJy11JywgZGV2aWNlLnVkaWQsICctLWNvbnRhaW5lcicsIGJ1bmRsZUlkLCBtbnRSb290XTtcbiAgICB9IGVsc2Uge1xuICAgICAgdmVyaWZ5SXNTdWJQYXRoKGRzdFBhdGgsIG1udFJvb3QpO1xuICAgIH1cbiAgICBhd2FpdCBtb3VudERldmljZShkZXZpY2UsIGlmdXNlQXJncyk7XG4gICAgaXNVbm1vdW50U3VjY2Vzc2Z1bCA9IGZhbHNlO1xuICAgIHRyeSB7XG4gICAgICBpZiAoIWF3YWl0IGZzLmV4aXN0cyhkc3RQYXRoKSkge1xuICAgICAgICBsb2cuZXJyb3JBbmRUaHJvdyhgVGhlIHJlbW90ZSAke2lzRmlsZSA/ICdmaWxlJyA6ICdmb2xkZXInfSBhdCAnJHtkc3RQYXRofScgZG9lcyBub3QgZXhpc3RgKTtcbiAgICAgIH1cbiAgICAgIGNvbnN0IGJ1ZmZlciA9IGlzRmlsZVxuICAgICAgICA/IGF3YWl0IGZzLnJlYWRGaWxlKGRzdFBhdGgpXG4gICAgICAgIDogYXdhaXQgemlwLnRvSW5NZW1vcnlaaXAoZHN0UGF0aCk7XG4gICAgICByZXR1cm4gQnVmZmVyLmZyb20oYnVmZmVyKS50b1N0cmluZygnYmFzZTY0Jyk7XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIGF3YWl0IGV4ZWMoJ3Vtb3VudCcsIFttbnRSb290XSk7XG4gICAgICBpc1VubW91bnRTdWNjZXNzZnVsID0gdHJ1ZTtcbiAgICB9XG4gIH0gZmluYWxseSB7XG4gICAgaWYgKGlzVW5tb3VudFN1Y2Nlc3NmdWwpIHtcbiAgICAgIGF3YWl0IGZzLnJpbXJhZihtbnRSb290KTtcbiAgICB9IGVsc2Uge1xuICAgICAgbG9nLndhcm4oYFVtb3VudCBoYXMgZmFpbGVkLCBzbyBub3QgcmVtb3ZpbmcgJyR7bW50Um9vdH0nYCk7XG4gICAgfVxuICB9XG59XG5cblxuY29tbWFuZHMucHVzaEZpbGUgPSBhc3luYyBmdW5jdGlvbiBwdXNoRmlsZSAocmVtb3RlUGF0aCwgYmFzZTY0RGF0YSkge1xuICBpZiAocmVtb3RlUGF0aC5lbmRzV2l0aCgnLycpKSB7XG4gICAgbG9nLmVycm9yQW5kVGhyb3coYEl0IGlzIGV4cGVjdGVkIHRoYXQgcmVtb3RlIHBhdGggcG9pbnRzIHRvIGEgZmlsZSBhbmQgbm90IHRvIGEgZm9sZGVyLiBgICtcbiAgICAgICAgICAgICAgICAgICAgICBgJyR7cmVtb3RlUGF0aH0nIGlzIGdpdmVuIGluc3RlYWRgKTtcbiAgfVxuICBpZiAoXy5pc0FycmF5KGJhc2U2NERhdGEpKSB7XG4gICAgLy8gc29tZSBjbGllbnRzIChhaGVtKSBqYXZhLCBzZW5kIGEgYnl0ZSBhcnJheSBlbmNvZGluZyB1dGY4IGNoYXJhY3RlcnNcbiAgICAvLyBpbnN0ZWFkIG9mIGEgc3RyaW5nLCB3aGljaCB3b3VsZCBiZSBpbmZpbml0ZWx5IGJldHRlciFcbiAgICBiYXNlNjREYXRhID0gQnVmZmVyLmZyb20oYmFzZTY0RGF0YSkudG9TdHJpbmcoJ3V0ZjgnKTtcbiAgfVxuICByZXR1cm4gdGhpcy5pc1NpbXVsYXRvcigpXG4gICAgPyBhd2FpdCBwdXNoRmlsZVRvU2ltdWxhdG9yKHRoaXMub3B0cy5kZXZpY2UsIHJlbW90ZVBhdGgsIGJhc2U2NERhdGEpXG4gICAgOiBhd2FpdCBwdXNoRmlsZVRvUmVhbERldmljZSh0aGlzLm9wdHMuZGV2aWNlLCByZW1vdGVQYXRoLCBiYXNlNjREYXRhKTtcbn07XG5cbmNvbW1hbmRzLnB1bGxGaWxlID0gYXN5bmMgZnVuY3Rpb24gcHVsbEZpbGUgKHJlbW90ZVBhdGgpIHtcbiAgaWYgKHJlbW90ZVBhdGguZW5kc1dpdGgoJy8nKSkge1xuICAgIGxvZy5lcnJvckFuZFRocm93KGBJdCBpcyBleHBlY3RlZCB0aGF0IHJlbW90ZSBwYXRoIHBvaW50cyB0byBhIGZpbGUgYW5kIG5vdCB0byBhIGZvbGRlci4gYCArXG4gICAgICAgICAgICAgICAgICAgICAgYCcke3JlbW90ZVBhdGh9JyBpcyBnaXZlbiBpbnN0ZWFkYCk7XG4gIH1cbiAgcmV0dXJuIHRoaXMuaXNTaW11bGF0b3IoKVxuICAgID8gYXdhaXQgcHVsbEZyb21TaW11bGF0b3IodGhpcy5vcHRzLmRldmljZSwgcmVtb3RlUGF0aCwgdHJ1ZSlcbiAgICA6IGF3YWl0IHB1bGxGcm9tUmVhbERldmljZSh0aGlzLm9wdHMuZGV2aWNlLCByZW1vdGVQYXRoLCB0cnVlKTtcbn07XG5cbmNvbW1hbmRzLmdldFNpbUZpbGVGdWxsUGF0aCA9IGFzeW5jIGZ1bmN0aW9uIGdldFNpbUZpbGVGdWxsUGF0aCAocmVtb3RlUGF0aCkge1xuICBsZXQgYmFzZVBhdGggPSB0aGlzLm9wdHMuZGV2aWNlLmdldERpcigpO1xuICBsZXQgYXBwTmFtZSA9IG51bGw7XG5cbiAgaWYgKHRoaXMub3B0cy5hcHApIHtcbiAgICBsZXQgYXBwTmFtZVJlZ2V4ID0gbmV3IFJlZ0V4cChgXFxcXCR7cGF0aC5zZXB9KFtcXFxcdy1dK1xcXFwuYXBwKWApO1xuICAgIGxldCBhcHBOYW1lTWF0Y2hlcyA9IGFwcE5hbWVSZWdleC5leGVjKHRoaXMub3B0cy5hcHApO1xuICAgIGlmIChhcHBOYW1lTWF0Y2hlcykge1xuICAgICAgYXBwTmFtZSA9IGFwcE5hbWVNYXRjaGVzWzFdO1xuICAgIH1cbiAgfVxuICAvLyBkZS1hYnNvbHV0aXplIHRoZSBwYXRoXG4gIGlmIChzeXN0ZW0uaXNXaW5kb3dzKCkpIHtcbiAgICBpZiAocmVtb3RlUGF0aC5pbmRleG9mKCc6Ly8nKSA9PT0gMSkge1xuICAgICAgcmVtb3RlUGF0aCA9IHJlbW90ZVBhdGguc2xpY2UoNCk7XG4gICAgfVxuICB9IGVsc2Uge1xuICAgIGlmIChyZW1vdGVQYXRoLmluZGV4T2YoJy8nKSA9PT0gMCkge1xuICAgICAgcmVtb3RlUGF0aCA9IHJlbW90ZVBhdGguc2xpY2UoMSk7XG4gICAgfVxuICB9XG5cbiAgaWYgKHJlbW90ZVBhdGguc3RhcnRzV2l0aChhcHBOYW1lKSkge1xuICAgIGxldCBmaW5kUGF0aCA9IGJhc2VQYXRoO1xuICAgIGlmICghdGhpcy5vcHRzLnBsYXRmb3JtVmVyc2lvbiB8fCB1dGlsLmNvbXBhcmVWZXJzaW9ucyh0aGlzLm9wdHMucGxhdGZvcm1WZXJzaW9uLCAnPj0nLCAnOC4wJykpIHtcbiAgICAgIC8vIHRoZSAuYXBwIGZpbGUgYXBwZWFycyBpbiAvQ29udGFpbmVycy9EYXRhIGFuZCAvQ29udGFpbmVycy9CdW5kbGUgYm90aC4gV2Ugb25seSB3YW50IC9CdW5kbGVcbiAgICAgIGZpbmRQYXRoID0gcGF0aC5yZXNvbHZlKGJhc2VQYXRoLCAnQ29udGFpbmVycycsICdCdW5kbGUnKTtcbiAgICB9XG4gICAgZmluZFBhdGggPSBmaW5kUGF0aC5yZXBsYWNlKC9cXHMvZywgJ1xcXFwgJyk7XG5cbiAgICBsZXQgeyBzdGRvdXQgfSA9IGF3YWl0IGV4ZWMoJ2ZpbmQnLCBbZmluZFBhdGgsICctbmFtZScsIGFwcE5hbWVdKTtcbiAgICBsZXQgYXBwUm9vdCA9IHN0ZG91dC5yZXBsYWNlKC9cXG4kLywgJycpO1xuICAgIGxldCBzdWJQYXRoID0gcmVtb3RlUGF0aC5zdWJzdHJpbmcoYXBwTmFtZS5sZW5ndGggKyAxKTtcbiAgICBsZXQgZnVsbFBhdGggPSBwYXRoLnJlc29sdmUoYXBwUm9vdCwgc3ViUGF0aCk7XG4gICAgbG9nLmRlYnVnKGBGaW5kaW5nIGFwcC1yZWxhdGl2ZSBmaWxlOiAnJHtmdWxsUGF0aH0nYCk7XG4gICAgcmV0dXJuIGZ1bGxQYXRoO1xuICB9XG5cbiAgbGV0IGZ1bGxQYXRoID0gcGF0aC5yZXNvbHZlKGJhc2VQYXRoLCByZW1vdGVQYXRoKTtcbiAgbG9nLmRlYnVnKGBGaW5kaW5nIHNpbS1yZWxhdGl2ZSBmaWxlOiAke2Z1bGxQYXRofWApO1xuICByZXR1cm4gZnVsbFBhdGg7XG59O1xuXG5jb21tYW5kcy5wdWxsRm9sZGVyID0gYXN5bmMgZnVuY3Rpb24gcHVsbEZvbGRlciAocmVtb3RlUGF0aCkge1xuICBpZiAoIXJlbW90ZVBhdGguZW5kc1dpdGgoJy8nKSkge1xuICAgIHJlbW90ZVBhdGggPSBgJHtyZW1vdGVQYXRofS9gO1xuICB9XG4gIHJldHVybiB0aGlzLmlzU2ltdWxhdG9yKClcbiAgICA/IGF3YWl0IHB1bGxGcm9tU2ltdWxhdG9yKHRoaXMub3B0cy5kZXZpY2UsIHJlbW90ZVBhdGgsIGZhbHNlKVxuICAgIDogYXdhaXQgcHVsbEZyb21SZWFsRGV2aWNlKHRoaXMub3B0cy5kZXZpY2UsIHJlbW90ZVBhdGgsIGZhbHNlKTtcbn07XG5cbmV4cG9ydCB7IGNvbW1hbmRzIH07XG5leHBvcnQgZGVmYXVsdCBjb21tYW5kcztcbiJdLCJmaWxlIjoibGliL2NvbW1hbmRzL2ZpbGUtbW92ZW1lbnQuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
