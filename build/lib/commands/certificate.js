"use strict";

var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = exports.commands = void 0;

require("source-map-support/register");

var _lodash = _interopRequireDefault(require("lodash"));

var _appiumSupport = require("appium-support");

var _appiumIosDriver = require("appium-ios-driver");

var _appiumBaseDriver = require("appium-base-driver");

var _nodeSimctl = require("node-simctl");

var _asyncbox = require("asyncbox");

var _bluebird = _interopRequireDefault(require("bluebird"));

var _logger = _interopRequireDefault(require("../logger"));

var _os = _interopRequireDefault(require("os"));

var _path = _interopRequireDefault(require("path"));

var _uuidJs = _interopRequireDefault(require("uuid-js"));

var _teen_process = require("teen_process");

let extensions = {},
    commands = {};
exports.commands = commands;
const CONFIG_EXTENSION = 'mobileconfig';

async function extractCommonName(certBuffer) {
  const tempCert = await _appiumSupport.tempDir.open({
    prefix: 'cert',
    suffix: '.cer'
  });

  try {
    await _appiumSupport.fs.writeFile(tempCert.path, certBuffer);
    const {
      stdout
    } = await (0, _teen_process.exec)('openssl', ['x509', '-noout', '-subject', '-in', tempCert.path]);
    const cnMatch = /\/CN=([^\/]+)/.exec(stdout);

    if (cnMatch) {
      return cnMatch[1].trim();
    }

    throw new Error(`There is no common name value in '${stdout}' output`);
  } catch (err) {
    throw new Error(`Cannot parse common name value from the certificate. Is it valid and base64-encoded? ` + `Original error: ${err.message}`);
  } finally {
    await _appiumSupport.fs.rimraf(tempCert.path);
  }
}

function toMobileConfig(certBuffer, commonName) {
  const getUUID = () => _uuidJs.default.create().hex.toUpperCase();

  const contentUuid = getUUID();
  return {
    PayloadContent: [{
      PayloadCertificateFileName: `${commonName}.cer`,
      PayloadContent: certBuffer,
      PayloadDescription: 'Adds a CA root certificate',
      PayloadDisplayName: commonName,
      PayloadIdentifier: `com.apple.security.root.${contentUuid}`,
      PayloadType: 'com.apple.security.root',
      PayloadUUID: contentUuid,
      PayloadVersion: 1
    }],
    PayloadDisplayName: commonName,
    PayloadIdentifier: `${_os.default.hostname().split('.')[0]}.${getUUID()}`,
    PayloadRemovalDisallowed: false,
    PayloadType: 'Configuration',
    PayloadUUID: getUUID(),
    PayloadVersion: 1
  };
}

async function clickElement(driver, locator, options = {}) {
  let element = null;
  const {
    timeout = 5000,
    skipIfInvisible = false
  } = options;
  const lookupDelay = 500;

  try {
    element = await (0, _asyncbox.retryInterval)(timeout < lookupDelay ? 1 : timeout / lookupDelay, lookupDelay, () => driver.findNativeElementOrElements(locator.type, locator.value, false));
  } catch (err) {
    if (skipIfInvisible) {
      return false;
    }

    throw new Error(`Cannot find ${JSON.stringify(locator)} within ${timeout}ms timeout`);
  }

  await driver.nativeClick(element);
  return true;
}

async function installCertificateInPreferences(driver) {
  await clickElement(driver, {
    type: 'accessibility id',
    value: 'Allow'
  }, {
    timeout: 15000
  });
  await _bluebird.default.delay(2000);

  if (!(await clickElement(driver, {
    type: 'accessibility id',
    value: 'Install'
  }, {
    skipIfInvisible: true
  }))) {
    return false;
  }

  await _bluebird.default.delay(1500);
  await clickElement(driver, {
    type: 'accessibility id',
    value: 'Install'
  });
  await clickElement(driver, {
    type: '-ios class chain',
    value: '**/XCUIElementTypeSheet/**/XCUIElementTypeButton[`label == \'Install\'`]'
  });
  await clickElement(driver, {
    type: 'accessibility id',
    value: 'Done'
  });
  return true;
}

async function trustCertificateInPreferences(driver, name) {
  await clickElement(driver, {
    type: 'accessibility id',
    value: 'Return to Settings'
  });
  await clickElement(driver, {
    type: 'accessibility id',
    value: 'General'
  });
  await clickElement(driver, {
    type: 'accessibility id',
    value: 'About'
  });
  const switchLocator = {
    type: '-ios class chain',
    value: `**/XCUIElementTypeCell[\`label == '${name}'\`]/**/XCUIElementTypeSwitch`
  };
  await (0, _asyncbox.retry)(5, async () => {
    await driver.mobileSwipe({
      element: await driver.findNativeElementOrElements('class name', 'XCUIElementTypeTable', false),
      direction: 'up'
    });
    await clickElement(driver, {
      type: 'accessibility id',
      value: 'Certificate Trust Settings'
    }, {
      timeout: 500
    });
    await driver.findNativeElementOrElements(switchLocator.type, switchLocator.value, false);
  });

  if (await clickElement(driver, {
    type: switchLocator.type,
    value: `${switchLocator.value}[\`value == '0'\`]`
  }, {
    timeout: 1000,
    skipIfInvisible: true
  })) {
    await driver.postAcceptAlert();
  }
}

commands.mobileInstallCertificate = async function mobileInstallCertificate(opts = {}) {
  const {
    content,
    commonName
  } = opts;

  if (_lodash.default.isEmpty(content)) {
    throw new Error('Certificate content should not be empty');
  }

  if (!(await _appiumSupport.fs.exists(_appiumBaseDriver.STATIC_DIR))) {
    throw new Error(`The static content root '${_appiumBaseDriver.STATIC_DIR}' ` + `does not exist or is not accessible`);
  }

  const configName = `${(Math.random() * 0x100000000 + 1).toString(36)}.${CONFIG_EXTENSION}`;

  const configPath = _path.default.resolve(_appiumBaseDriver.STATIC_DIR, configName);

  const certBuffer = Buffer.from(content, 'base64');
  const cn = commonName || (await extractCommonName(certBuffer));
  const mobileConfig = toMobileConfig(certBuffer, cn);

  try {
    await _appiumSupport.plist.updatePlistFile(configPath, mobileConfig, false, false);
  } catch (err) {
    throw new Error(`Cannot store the generated config as '${configPath}'. ` + `Original error: ${err.message}`);
  }

  try {
    const {
      address,
      port
    } = this.server.address();
    const certUrl = `http://${address ? address : _os.default.hostname()}:${port ? port : 4723}/${configName}`;

    try {
      if (this.isRealDevice()) {
        try {
          await this.proxyCommand('/url', 'POST', {
            url: certUrl
          });
        } catch (err) {
          if (this.isWebContext()) {
            await _appiumIosDriver.iosCommands.general.setUrl.call(this, certUrl);
          } else {
            throw err;
          }
        }
      } else {
        await (0, _nodeSimctl.openUrl)(this.opts.udid || this.sim.udid, certUrl);
      }

      if (await installCertificateInPreferences(this)) {
        await trustCertificateInPreferences(this, cn);
      } else {
        _logger.default.info(`It looks like the '${cn}' certificate has been already added to the CA root`);
      }
    } finally {
      try {
        await this.activateApp(this.opts.bundleId);
      } catch (e) {
        _logger.default.warn(`Cannot restore the application '${this.opts.bundleId}'. Original error: ${e.message}`);
      }
    }

    return (await _appiumSupport.fs.readFile(configPath)).toString('base64');
  } finally {
    await _appiumSupport.fs.rimraf(configPath);
  }
};

Object.assign(extensions, commands);
var _default = extensions;
exports.default = _default;require('source-map-support').install();


//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImxpYi9jb21tYW5kcy9jZXJ0aWZpY2F0ZS5qcyJdLCJuYW1lcyI6WyJleHRlbnNpb25zIiwiY29tbWFuZHMiLCJDT05GSUdfRVhURU5TSU9OIiwiZXh0cmFjdENvbW1vbk5hbWUiLCJjZXJ0QnVmZmVyIiwidGVtcENlcnQiLCJ0ZW1wRGlyIiwib3BlbiIsInByZWZpeCIsInN1ZmZpeCIsImZzIiwid3JpdGVGaWxlIiwicGF0aCIsInN0ZG91dCIsImNuTWF0Y2giLCJleGVjIiwidHJpbSIsIkVycm9yIiwiZXJyIiwibWVzc2FnZSIsInJpbXJhZiIsInRvTW9iaWxlQ29uZmlnIiwiY29tbW9uTmFtZSIsImdldFVVSUQiLCJVVUlEIiwiY3JlYXRlIiwiaGV4IiwidG9VcHBlckNhc2UiLCJjb250ZW50VXVpZCIsIlBheWxvYWRDb250ZW50IiwiUGF5bG9hZENlcnRpZmljYXRlRmlsZU5hbWUiLCJQYXlsb2FkRGVzY3JpcHRpb24iLCJQYXlsb2FkRGlzcGxheU5hbWUiLCJQYXlsb2FkSWRlbnRpZmllciIsIlBheWxvYWRUeXBlIiwiUGF5bG9hZFVVSUQiLCJQYXlsb2FkVmVyc2lvbiIsIm9zIiwiaG9zdG5hbWUiLCJzcGxpdCIsIlBheWxvYWRSZW1vdmFsRGlzYWxsb3dlZCIsImNsaWNrRWxlbWVudCIsImRyaXZlciIsImxvY2F0b3IiLCJvcHRpb25zIiwiZWxlbWVudCIsInRpbWVvdXQiLCJza2lwSWZJbnZpc2libGUiLCJsb29rdXBEZWxheSIsImZpbmROYXRpdmVFbGVtZW50T3JFbGVtZW50cyIsInR5cGUiLCJ2YWx1ZSIsIkpTT04iLCJzdHJpbmdpZnkiLCJuYXRpdmVDbGljayIsImluc3RhbGxDZXJ0aWZpY2F0ZUluUHJlZmVyZW5jZXMiLCJCIiwiZGVsYXkiLCJ0cnVzdENlcnRpZmljYXRlSW5QcmVmZXJlbmNlcyIsIm5hbWUiLCJzd2l0Y2hMb2NhdG9yIiwibW9iaWxlU3dpcGUiLCJkaXJlY3Rpb24iLCJwb3N0QWNjZXB0QWxlcnQiLCJtb2JpbGVJbnN0YWxsQ2VydGlmaWNhdGUiLCJvcHRzIiwiY29udGVudCIsIl8iLCJpc0VtcHR5IiwiZXhpc3RzIiwiU1RBVElDX0RJUiIsImNvbmZpZ05hbWUiLCJNYXRoIiwicmFuZG9tIiwidG9TdHJpbmciLCJjb25maWdQYXRoIiwicmVzb2x2ZSIsIkJ1ZmZlciIsImZyb20iLCJjbiIsIm1vYmlsZUNvbmZpZyIsInBsaXN0IiwidXBkYXRlUGxpc3RGaWxlIiwiYWRkcmVzcyIsInBvcnQiLCJzZXJ2ZXIiLCJjZXJ0VXJsIiwiaXNSZWFsRGV2aWNlIiwicHJveHlDb21tYW5kIiwidXJsIiwiaXNXZWJDb250ZXh0IiwiaW9zQ29tbWFuZHMiLCJnZW5lcmFsIiwic2V0VXJsIiwiY2FsbCIsInVkaWQiLCJzaW0iLCJsb2ciLCJpbmZvIiwiYWN0aXZhdGVBcHAiLCJidW5kbGVJZCIsImUiLCJ3YXJuIiwicmVhZEZpbGUiLCJPYmplY3QiLCJhc3NpZ24iXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7O0FBQUE7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBQ0E7O0FBRUEsSUFBSUEsVUFBVSxHQUFHLEVBQWpCO0FBQUEsSUFBcUJDLFFBQVEsR0FBRyxFQUFoQzs7QUFFQSxNQUFNQyxnQkFBZ0IsR0FBRyxjQUF6Qjs7QUFHQSxlQUFlQyxpQkFBZixDQUFrQ0MsVUFBbEMsRUFBOEM7QUFDNUMsUUFBTUMsUUFBUSxHQUFHLE1BQU1DLHVCQUFRQyxJQUFSLENBQWE7QUFDbENDLElBQUFBLE1BQU0sRUFBRSxNQUQwQjtBQUVsQ0MsSUFBQUEsTUFBTSxFQUFFO0FBRjBCLEdBQWIsQ0FBdkI7O0FBSUEsTUFBSTtBQUNGLFVBQU1DLGtCQUFHQyxTQUFILENBQWFOLFFBQVEsQ0FBQ08sSUFBdEIsRUFBNEJSLFVBQTVCLENBQU47QUFDQSxVQUFNO0FBQUNTLE1BQUFBO0FBQUQsUUFBVyxNQUFNLHdCQUFLLFNBQUwsRUFBZ0IsQ0FBQyxNQUFELEVBQVMsUUFBVCxFQUFtQixV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Q0FBbkM7QUFDRCxPQUZELE1BRU87QUFDTGtCLHdCQUFJQyxJQUFKLENBQVUsc0JBQXFCbkIsRUFBRyxxREFBbEM7QUFDRDtBQUNGLEtBckJELFNBcUJVO0FBQ1IsVUFBSTtBQUNGLGNBQU0sS0FBS29CLFdBQUwsQ0FBaUIsS0FBS2xDLElBQUwsQ0FBVW1DLFFBQTNCLENBQU47QUFDRCxPQUZELENBRUUsT0FBT0MsQ0FBUCxFQUFVO0FBQ1ZKLHdCQUFJSyxJQUFKLENBQVUsbUNBQWtDLEtBQUtyQyxJQUFMLENBQVVtQyxRQUFTLHNCQUFxQkMsQ0FBQyxDQUFDbEYsT0FBUSxFQUE5RjtBQUNEO0FBQ0Y7O0FBRUQsV0FBTyxDQUFDLE1BQU1ULGtCQUFHNkYsUUFBSCxDQUFZNUIsVUFBWixDQUFQLEVBQWdDRCxRQUFoQyxDQUF5QyxRQUF6QyxDQUFQO0FBQ0QsR0FqQ0QsU0FpQ1U7QUFDUixVQUFNaEUsa0JBQUdVLE1BQUgsQ0FBVXVELFVBQVYsQ0FBTjtBQUNEO0FBQ0YsQ0F6REQ7O0FBMkRBNkIsTUFBTSxDQUFDQyxNQUFQLENBQWN6RyxVQUFkLEVBQTBCQyxRQUExQjtlQUVlRCxVIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7IGZzLCBwbGlzdCwgdGVtcERpciB9IGZyb20gJ2FwcGl1bS1zdXBwb3J0JztcbmltcG9ydCB7IGlvc0NvbW1hbmRzIH0gZnJvbSAnYXBwaXVtLWlvcy1kcml2ZXInO1xuaW1wb3J0IHsgU1RBVElDX0RJUiB9IGZyb20gJ2FwcGl1bS1iYXNlLWRyaXZlcic7XG5pbXBvcnQgeyBvcGVuVXJsIH0gZnJvbSAnbm9kZS1zaW1jdGwnO1xuaW1wb3J0IHsgcmV0cnlJbnRlcnZhbCwgcmV0cnkgfSBmcm9tICdhc3luY2JveCc7XG5pbXBvcnQgQiBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgbG9nIGZyb20gJy4uL2xvZ2dlcic7XG5pbXBvcnQgb3MgZnJvbSAnb3MnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgVVVJRCBmcm9tICd1dWlkLWpzJztcbmltcG9ydCB7IGV4ZWMgfSBmcm9tICd0ZWVuX3Byb2Nlc3MnO1xuXG5sZXQgZXh0ZW5zaW9ucyA9IHt9LCBjb21tYW5kcyA9IHt9O1xuXG5jb25zdCBDT05GSUdfRVhURU5TSU9OID0gJ21vYmlsZWNvbmZpZyc7XG5cblxuYXN5bmMgZnVuY3Rpb24gZXh0cmFjdENvbW1vbk5hbWUgKGNlcnRCdWZmZXIpIHtcbiAgY29uc3QgdGVtcENlcnQgPSBhd2FpdCB0ZW1wRGlyLm9wZW4oe1xuICAgIHByZWZpeDogJ2NlcnQnLFxuICAgIHN1ZmZpeDogJy5jZXInXG4gIH0pO1xuICB0cnkge1xuICAgIGF3YWl0IGZzLndyaXRlRmlsZSh0ZW1wQ2VydC5wYXRoLCBjZXJ0QnVmZmVyKTtcbiAgICBjb25zdCB7c3Rkb3V0fSA9IGF3YWl0IGV4ZWMoJ29wZW5zc2wnLCBbJ3g1MDknLCAnLW5vb3V0JywgJy1zdWJqZWN0JywgJy1pbicsIHRlbXBDZXJ0LnBhdGhdKTtcbiAgICBjb25zdCBjbk1hdGNoID0gL1xcL0NOPShbXlxcL10rKS8uZXhlYyhzdGRvdXQpOyAvLyBlc2xpbnQtZGlzYWJsZS1saW5lIG5vLXVzZWxlc3MtZXNjYXBlXG4gICAgaWYgKGNuTWF0Y2gpIHtcbiAgICAgIHJldHVybiBjbk1hdGNoWzFdLnRyaW0oKTtcbiAgICB9XG4gICAgdGhyb3cgbmV3IEVycm9yKGBUaGVyZSBpcyBubyBjb21tb24gbmFtZSB2YWx1ZSBpbiAnJHtzdGRvdXR9JyBvdXRwdXRgKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3QgcGFyc2UgY29tbW9uIG5hbWUgdmFsdWUgZnJvbSB0aGUgY2VydGlmaWNhdGUuIElzIGl0IHZhbGlkIGFuZCBiYXNlNjQtZW5jb2RlZD8gYCArXG4gICAgICAgICAgICAgICAgICAgIGBPcmlnaW5hbCBlcnJvcjogJHtlcnIubWVzc2FnZX1gKTtcbiAgfSBmaW5hbGx5IHtcbiAgICBhd2FpdCBmcy5yaW1yYWYodGVtcENlcnQucGF0aCk7XG4gIH1cbn1cblxuLyoqXG4gKiBHZW5lcmF0ZXMgQXBwbGUncyBvdmVyLXRoZS1haXIgY29uZmlndXJhdGlvbiBwcm9maWxlXG4gKiBmb3IgY2VydGlmaWNhdGUgZGVwbG95bWVudCBiYXNlZCBvbiB0aGUgZ2l2ZW4gUEVNIGNlcnRpZmljYXRlIGNvbnRlbnQuXG4gKiBSZWFkIGh0dHBzOi8vZGV2ZWxvcGVyLmFwcGxlLmNvbS9saWJyYXJ5L2NvbnRlbnQvZG9jdW1lbnRhdGlvbi9OZXR3b3JraW5nSW50ZXJuZXQvQ29uY2VwdHVhbC9pUGhvbmVPVEFDb25maWd1cmF0aW9uL0ludHJvZHVjdGlvbi9JbnRyb2R1Y3Rpb24uaHRtbFxuICogZm9yIG1vcmUgZGV0YWlscyBvbiBzdWNoIHByb2ZpbGVzLlxuICpcbiAqIEBwYXJhbSB7QnVmZmVyfSBjZXJ0QnVmZmVyIC0gVGhlIGFjdHVhbCBjb250ZW50IG9mIFBFTSBjZXJ0aWZpY2F0ZSBlbmNvZGVkIGludG8gTm9kZUpTIGJ1ZmZlclxuICogQHBhcmFtIHtzdHJpbmd9IGNvbW1vbk5hbWUgLSBDZXJ0aWZpY2F0ZSdzIGNvbW1vbiBuYW1lXG4gKiBAcmV0dXJucyB7T2JqZWN0fSBUaGUgZW5jb2RlZCBzdHJ1Y3R1cmUgb2YgdGhlIGdpdmVuIGNlcnRpZmljYXRlLCB3aGljaCBpcyByZWFkeSB0byBiZSBwYXNzZWRcbiAqIGFzIGFuIGFyZ3VtZW50IHRvIHBsaXN0IGJ1aWxkZXJcbiAqIEB0aHJvd3Mge0Vycm9yfSBJZiB0aGUgZ2l2ZW4gY2VydGlmaWNhdGUgY2Fubm90IGJlIHBhcnNlZFxuICovXG5mdW5jdGlvbiB0b01vYmlsZUNvbmZpZyAoY2VydEJ1ZmZlciwgY29tbW9uTmFtZSkge1xuICBjb25zdCBnZXRVVUlEID0gKCkgPT4gVVVJRC5jcmVhdGUoKS5oZXgudG9VcHBlckNhc2UoKTtcbiAgY29uc3QgY29udGVudFV1aWQgPSBnZXRVVUlEKCk7XG4gIHJldHVybiB7XG4gICAgUGF5bG9hZENvbnRlbnQ6IFt7XG4gICAgICBQYXlsb2FkQ2VydGlmaWNhdGVGaWxlTmFtZTogYCR7Y29tbW9uTmFtZX0uY2VyYCxcbiAgICAgIFBheWxvYWRDb250ZW50OiBjZXJ0QnVmZmVyLFxuICAgICAgUGF5bG9hZERlc2NyaXB0aW9uOiAnQWRkcyBhIENBIHJvb3QgY2VydGlmaWNhdGUnLFxuICAgICAgUGF5bG9hZERpc3BsYXlOYW1lOiBjb21tb25OYW1lLFxuICAgICAgUGF5bG9hZElkZW50aWZpZXI6IGBjb20uYXBwbGUuc2VjdXJpdHkucm9vdC4ke2NvbnRlbnRVdWlkfWAsXG4gICAgICBQYXlsb2FkVHlwZTogJ2NvbS5hcHBsZS5zZWN1cml0eS5yb290JyxcbiAgICAgIFBheWxvYWRVVUlEOiBjb250ZW50VXVpZCxcbiAgICAgIFBheWxvYWRWZXJzaW9uOiAxXG4gICAgfV0sXG4gICAgUGF5bG9hZERpc3BsYXlOYW1lOiBjb21tb25OYW1lLFxuICAgIFBheWxvYWRJZGVudGlmaWVyOiBgJHtvcy5ob3N0bmFtZSgpLnNwbGl0KCcuJylbMF19LiR7Z2V0VVVJRCgpfWAsXG4gICAgUGF5bG9hZFJlbW92YWxEaXNhbGxvd2VkOiBmYWxzZSxcbiAgICBQYXlsb2FkVHlwZTogJ0NvbmZpZ3VyYXRpb24nLFxuICAgIFBheWxvYWRVVUlEOiBnZXRVVUlEKCksXG4gICAgUGF5bG9hZFZlcnNpb246IDFcbiAgfTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gY2xpY2tFbGVtZW50IChkcml2ZXIsIGxvY2F0b3IsIG9wdGlvbnMgPSB7fSkge1xuICBsZXQgZWxlbWVudCA9IG51bGw7XG4gIGNvbnN0IHtcbiAgICB0aW1lb3V0ID0gNTAwMCxcbiAgICBza2lwSWZJbnZpc2libGUgPSBmYWxzZVxuICB9ID0gb3B0aW9ucztcbiAgY29uc3QgbG9va3VwRGVsYXkgPSA1MDA7XG4gIHRyeSB7XG4gICAgZWxlbWVudCA9IGF3YWl0IHJldHJ5SW50ZXJ2YWwodGltZW91dCA8IGxvb2t1cERlbGF5ID8gMSA6IHRpbWVvdXQgLyBsb29rdXBEZWxheSwgbG9va3VwRGVsYXksXG4gICAgICAoKSA9PiBkcml2ZXIuZmluZE5hdGl2ZUVsZW1lbnRPckVsZW1lbnRzKGxvY2F0b3IudHlwZSwgbG9jYXRvci52YWx1ZSwgZmFsc2UpXG4gICAgKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgaWYgKHNraXBJZkludmlzaWJsZSkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICB0aHJvdyBuZXcgRXJyb3IoYENhbm5vdCBmaW5kICR7SlNPTi5zdHJpbmdpZnkobG9jYXRvcil9IHdpdGhpbiAke3RpbWVvdXR9bXMgdGltZW91dGApO1xuICB9XG4gIGF3YWl0IGRyaXZlci5uYXRpdmVDbGljayhlbGVtZW50KTtcbiAgcmV0dXJuIHRydWU7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGluc3RhbGxDZXJ0aWZpY2F0ZUluUHJlZmVyZW5jZXMgKGRyaXZlcikge1xuICAvLyBBY2NlcHQgU2FmYXJpIGFsZXJ0XG4gIGF3YWl0IGNsaWNrRWxlbWVudChkcml2ZXIsIHtcbiAgICB0eXBlOiAnYWNjZXNzaWJpbGl0eSBpZCcsXG4gICAgdmFsdWU6ICdBbGxvdycsXG4gIH0sIHtcbiAgICAvLyBjZXJ0aWZpY2F0ZSBsb2FkIG1pZ2h0IHRha2Ugc29tZSB0aW1lIG9uIHNsb3cgbWFjaGluZXNcbiAgICB0aW1lb3V0OiAxNTAwMCxcbiAgfSk7XG4gIC8vIFdhaXQgdW50aWwgUHJlZmVyZW5jZXMgYXJlIG9wZW5lZFxuICBhd2FpdCBCLmRlbGF5KDIwMDApO1xuXG4gIC8vIEdvIHRocm91Z2ggUHJlZmVyZW5jZXMgd2l6YXJkXG4gIGlmICghYXdhaXQgY2xpY2tFbGVtZW50KGRyaXZlciwge1xuICAgIHR5cGU6ICdhY2Nlc3NpYmlsaXR5IGlkJyxcbiAgICB2YWx1ZTogJ0luc3RhbGwnXG4gIH0sIHtcbiAgICBza2lwSWZJbnZpc2libGU6IHRydWUsXG4gIH0pKSB7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG4gIC8vIFdlIG5lZWQgdG8gY2xpY2sgSW5zdGFsbCBidXR0b24gb24gdHdvIGRpZmZlcmVudCB0YWJzXG4gIC8vIFRoZSBzZWNvbmQgb25lIGNvbmZpcm1zIHRoZSBwcmV2aW91c1xuICBhd2FpdCBCLmRlbGF5KDE1MDApO1xuICBhd2FpdCBjbGlja0VsZW1lbnQoZHJpdmVyLCB7XG4gICAgdHlwZTogJ2FjY2Vzc2liaWxpdHkgaWQnLFxuICAgIHZhbHVlOiAnSW5zdGFsbCdcbiAgfSk7XG4gIC8vIEFjY2VwdCBzaGVldCBhbGVydFxuICBhd2FpdCBjbGlja0VsZW1lbnQoZHJpdmVyLCB7XG4gICAgdHlwZTogJy1pb3MgY2xhc3MgY2hhaW4nLFxuICAgIHZhbHVlOiAnKiovWENVSUVsZW1lbnRUeXBlU2hlZXQvKiovWENVSUVsZW1lbnRUeXBlQnV0dG9uW2BsYWJlbCA9PSBcXCdJbnN0YWxsXFwnYF0nXG4gIH0pO1xuICAvLyBGaW5pc2ggYWRkaW5nIGNlcnRpZmljYXRlXG4gIGF3YWl0IGNsaWNrRWxlbWVudChkcml2ZXIsIHtcbiAgICB0eXBlOiAnYWNjZXNzaWJpbGl0eSBpZCcsXG4gICAgdmFsdWU6ICdEb25lJ1xuICB9KTtcbiAgcmV0dXJuIHRydWU7XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHRydXN0Q2VydGlmaWNhdGVJblByZWZlcmVuY2VzIChkcml2ZXIsIG5hbWUpIHtcbiAgYXdhaXQgY2xpY2tFbGVtZW50KGRyaXZlciwge1xuICAgIHR5cGU6ICdhY2Nlc3NpYmlsaXR5IGlkJyxcbiAgICB2YWx1ZTogJ1JldHVybiB0byBTZXR0aW5ncydcbiAgfSk7XG4gIGF3YWl0IGNsaWNrRWxlbWVudChkcml2ZXIsIHtcbiAgICB0eXBlOiAnYWNjZXNzaWJpbGl0eSBpZCcsXG4gICAgdmFsdWU6ICdHZW5lcmFsJ1xuICB9KTtcbiAgYXdhaXQgY2xpY2tFbGVtZW50KGRyaXZlciwge1xuICAgIHR5cGU6ICdhY2Nlc3NpYmlsaXR5IGlkJyxcbiAgICB2YWx1ZTogJ0Fib3V0J1xuICB9KTtcbiAgY29uc3Qgc3dpdGNoTG9jYXRvciA9IHtcbiAgICB0eXBlOiAnLWlvcyBjbGFzcyBjaGFpbicsXG4gICAgdmFsdWU6IGAqKi9YQ1VJRWxlbWVudFR5cGVDZWxsW1xcYGxhYmVsID09ICcke25hbWV9J1xcYF0vKiovWENVSUVsZW1lbnRUeXBlU3dpdGNoYCxcbiAgfTtcbiAgYXdhaXQgcmV0cnkoNSwgYXN5bmMgKCkgPT4ge1xuICAgIGF3YWl0IGRyaXZlci5tb2JpbGVTd2lwZSh7XG4gICAgICBlbGVtZW50OiBhd2FpdCBkcml2ZXIuZmluZE5hdGl2ZUVsZW1lbnRPckVsZW1lbnRzKCdjbGFzcyBuYW1lJywgJ1hDVUlFbGVtZW50VHlwZVRhYmxlJywgZmFsc2UpLFxuICAgICAgZGlyZWN0aW9uOiAndXAnXG4gICAgfSk7XG4gICAgYXdhaXQgY2xpY2tFbGVtZW50KGRyaXZlciwge1xuICAgICAgdHlwZTogJ2FjY2Vzc2liaWxpdHkgaWQnLFxuICAgICAgdmFsdWU6ICdDZXJ0aWZpY2F0ZSBUcnVzdCBTZXR0aW5ncydcbiAgICB9LCB7XG4gICAgICB0aW1lb3V0OiA1MDAsXG4gICAgfSk7XG5cbiAgICBhd2FpdCBkcml2ZXIuZmluZE5hdGl2ZUVsZW1lbnRPckVsZW1lbnRzKHN3aXRjaExvY2F0b3IudHlwZSwgc3dpdGNoTG9jYXRvci52YWx1ZSwgZmFsc2UpO1xuICB9KTtcbiAgLy8gT25seSBjbGljayB0aGUgc3dpdGNoIGlmIGl0IGlzIHNldCB0byBPZmZcbiAgaWYgKGF3YWl0IGNsaWNrRWxlbWVudChkcml2ZXIsIHtcbiAgICB0eXBlOiBzd2l0Y2hMb2NhdG9yLnR5cGUsXG4gICAgdmFsdWU6IGAke3N3aXRjaExvY2F0b3IudmFsdWV9W1xcYHZhbHVlID09ICcwJ1xcYF1gXG4gIH0sIHtcbiAgICB0aW1lb3V0OiAxMDAwLFxuICAgIHNraXBJZkludmlzaWJsZTogdHJ1ZSxcbiAgfSkpIHtcbiAgICBhd2FpdCBkcml2ZXIucG9zdEFjY2VwdEFsZXJ0KCk7XG4gIH1cbn1cblxuLyoqXG4gKiBAdHlwZWRlZiB7T2JqZWN0fSBDZXJ0aWZpY2F0ZUluc3RhbGxhdGlvbk9wdGlvbnNcbiAqXG4gKiBAcHJvcGVydHkgeyFzdHJpbmd9IGNvbnRlbnQgLSBCYXNlNjQtZW5jb2RlZCBjb250ZW50IG9mIHRoZSBwdWJsaWMgY2VydGlmaWNhdGVcbiAqIEBwcm9wZXJ0eSB7P3N0cmluZ30gY29tbW9uTmFtZSAtIENvbW1vbiBuYW1lIG9mIHRoZSBjZXJ0aWZpY2F0ZS4gSWYgdGhpcyBpcyBub3Qgc2V0XG4gKiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGVuIHRoZSBzY3JpcHQgd2lsbCB0cnkgdG8gcGFyc2UgaXQgZnJvbSB0aGUgZ2l2ZW5cbiAqICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNlcnRpZmljYXRlIGNvbnRlbnQuXG4gKi9cblxuLyoqXG4gKiBJbnN0YWxscyBhIGN1c3RvbSBjZXJ0aWZpY2F0ZSBvbnRvIHRoZSBkZXZpY2UuXG4gKiBTaW5jZSBBcHBsZSBwcm92aWRlcyBubyBvZmZpY2lhbCB3YXkgdG8gZG8gaXQgdmlhIGNvbW1hbmQgbGluZSxcbiAqIHRoaXMgbWV0aG9kIHRyaWVzIHRvIHdyYXAgdGhlIGNlcnRpZmljYXRlIGludG8gLm1vYmlsZWNvbmZpZyBmb3JtYXRcbiAqIGFuZCB0aGVuIGRlcGxveXMgdGhlIHdyYXBwZWQgZmlsZSB0byB0aGUgaW50ZXJuYWwgSFRUUCBzZXJ2ZXIsXG4gKiBzbyBvbmUgY2FuIG9wZW4gaXQgd2l0aCBtb2JpbGUgU2FmYXJpLlxuICogVGhlbiB0aGUgYWxnb3JpdGhtIGdvZXMgdGhyb3VnaCB0aGUgcHJvZmlsZSBpbnN0YWxsYXRpb24gcHJvY2VkdXJlIGJ5XG4gKiBjbGlja2luZyB0aGUgbmVjZXNzYXJ5IGJ1dHRvbnMgdXNpbmcgV2ViRHJpdmVyQWdlbnQuXG4gKlxuICogQHBhcmFtIHtDZXJ0aWZpY2F0ZUluc3RhbGxhdGlvbk9wdGlvbnN9IG9wdHNcbiAqIEByZXR1cm5zIHtzdHJpbmd9IFRoZSBjb250ZW50IG9mIHRoZSBnZW5lcmF0ZWQgLm1vYmlsZWNvbmZpZyBmaWxlIGFzXG4gKiBiYXNlNjQtZW5jb2RlZCBzdHJpbmcuIFRoaXMgY29uZmlnIG1pZ2h0IGJlIHVzZWZ1bCBmb3IgZGVidWdnaW5nIHB1cnBvc2VzLlxuICovXG5jb21tYW5kcy5tb2JpbGVJbnN0YWxsQ2VydGlmaWNhdGUgPSBhc3luYyBmdW5jdGlvbiBtb2JpbGVJbnN0YWxsQ2VydGlmaWNhdGUgKG9wdHMgPSB7fSkge1xuICBjb25zdCB7Y29udGVudCwgY29tbW9uTmFtZX0gPSBvcHRzO1xuICBpZiAoXy5pc0VtcHR5KGNvbnRlbnQpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdDZXJ0aWZpY2F0ZSBjb250ZW50IHNob3VsZCBub3QgYmUgZW1wdHknKTtcbiAgfVxuXG4gIGlmICghYXdhaXQgZnMuZXhpc3RzKFNUQVRJQ19ESVIpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBUaGUgc3RhdGljIGNvbnRlbnQgcm9vdCAnJHtTVEFUSUNfRElSfScgYCArXG4gICAgICAgICAgICAgICAgICAgIGBkb2VzIG5vdCBleGlzdCBvciBpcyBub3QgYWNjZXNzaWJsZWApO1xuICB9XG4gIGNvbnN0IGNvbmZpZ05hbWUgPSBgJHsoTWF0aC5yYW5kb20oKSAqIDB4MTAwMDAwMDAwICsgMSkudG9TdHJpbmcoMzYpfS4ke0NPTkZJR19FWFRFTlNJT059YDtcbiAgY29uc3QgY29uZmlnUGF0aCA9IHBhdGgucmVzb2x2ZShTVEFUSUNfRElSLCBjb25maWdOYW1lKTtcbiAgY29uc3QgY2VydEJ1ZmZlciA9IEJ1ZmZlci5mcm9tKGNvbnRlbnQsICdiYXNlNjQnKTtcbiAgY29uc3QgY24gPSBjb21tb25OYW1lIHx8IGF3YWl0IGV4dHJhY3RDb21tb25OYW1lKGNlcnRCdWZmZXIpO1xuICBjb25zdCBtb2JpbGVDb25maWcgPSB0b01vYmlsZUNvbmZpZyhjZXJ0QnVmZmVyLCBjbik7XG4gIHRyeSB7XG4gICAgYXdhaXQgcGxpc3QudXBkYXRlUGxpc3RGaWxlKGNvbmZpZ1BhdGgsIG1vYmlsZUNvbmZpZywgZmFsc2UsIGZhbHNlKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3Qgc3RvcmUgdGhlIGdlbmVyYXRlZCBjb25maWcgYXMgJyR7Y29uZmlnUGF0aH0nLiBgICtcbiAgICAgICAgICAgICAgICAgICAgYE9yaWdpbmFsIGVycm9yOiAke2Vyci5tZXNzYWdlfWApO1xuICB9XG4gIHRyeSB7XG4gICAgY29uc3Qge2FkZHJlc3MsIHBvcnR9ID0gdGhpcy5zZXJ2ZXIuYWRkcmVzcygpO1xuICAgIGNvbnN0IGNlcnRVcmwgPSBgaHR0cDovLyR7YWRkcmVzcyA/IGFkZHJlc3MgOiBvcy5ob3N0bmFtZSgpfToke3BvcnQgPyBwb3J0IDogNDcyM30vJHtjb25maWdOYW1lfWA7XG4gICAgdHJ5IHtcbiAgICAgIGlmICh0aGlzLmlzUmVhbERldmljZSgpKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgYXdhaXQgdGhpcy5wcm94eUNvbW1hbmQoJy91cmwnLCAnUE9TVCcsIHt1cmw6IGNlcnRVcmx9KTtcbiAgICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgaWYgKHRoaXMuaXNXZWJDb250ZXh0KCkpIHtcbiAgICAgICAgICAgIC8vIFRoZSBjb21tYW5kIGFib3ZlIGRvZXMgbm90IGFsd2F5cyB3b3JrIG9uIHJlYWwgZGV2aWNlc1xuICAgICAgICAgICAgYXdhaXQgaW9zQ29tbWFuZHMuZ2VuZXJhbC5zZXRVcmwuY2FsbCh0aGlzLCBjZXJ0VXJsKTtcbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgdGhyb3cgZXJyO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgYXdhaXQgb3BlblVybCh0aGlzLm9wdHMudWRpZCB8fCB0aGlzLnNpbS51ZGlkLCBjZXJ0VXJsKTtcbiAgICAgIH1cblxuICAgICAgaWYgKGF3YWl0IGluc3RhbGxDZXJ0aWZpY2F0ZUluUHJlZmVyZW5jZXModGhpcykpIHtcbiAgICAgICAgYXdhaXQgdHJ1c3RDZXJ0aWZpY2F0ZUluUHJlZmVyZW5jZXModGhpcywgY24pO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgbG9nLmluZm8oYEl0IGxvb2tzIGxpa2UgdGhlICcke2NufScgY2VydGlmaWNhdGUgaGFzIGJlZW4gYWxyZWFkeSBhZGRlZCB0byB0aGUgQ0Egcm9vdGApO1xuICAgICAgfVxuICAgIH0gZmluYWxseSB7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCB0aGlzLmFjdGl2YXRlQXBwKHRoaXMub3B0cy5idW5kbGVJZCk7XG4gICAgICB9IGNhdGNoIChlKSB7XG4gICAgICAgIGxvZy53YXJuKGBDYW5ub3QgcmVzdG9yZSB0aGUgYXBwbGljYXRpb24gJyR7dGhpcy5vcHRzLmJ1bmRsZUlkfScuIE9yaWdpbmFsIGVycm9yOiAke2UubWVzc2FnZX1gKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gKGF3YWl0IGZzLnJlYWRGaWxlKGNvbmZpZ1BhdGgpKS50b1N0cmluZygnYmFzZTY0Jyk7XG4gIH0gZmluYWxseSB7XG4gICAgYXdhaXQgZnMucmltcmFmKGNvbmZpZ1BhdGgpO1xuICB9XG59O1xuXG5PYmplY3QuYXNzaWduKGV4dGVuc2lvbnMsIGNvbW1hbmRzKTtcbmV4cG9ydCB7IGNvbW1hbmRzIH07XG5leHBvcnQgZGVmYXVsdCBleHRlbnNpb25zO1xuIl0sImZpbGUiOiJsaWIvY29tbWFuZHMvY2VydGlmaWNhdGUuanMiLCJzb3VyY2VSb290IjoiLi4vLi4vLi4ifQ==
